---
phase: 02-worktree-state-and-quality-gates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/mow/refine-phase.md
  - ~/.claude/commands/mow/refine-phase.md
  - ~/.claude/mowism/workflows/refine-phase.md
autonomous: true
requirements:
  - GATE-01
  - GATE-02
  - GATE-03

must_haves:
  truths:
    - "User can invoke /mow:refine-phase with a phase number"
    - "User is presented with 4 tier options: Auto (recommended), minimum, complex, algorithmic"
    - "Minimum tier runs scope-check -> change-summary -> verify-work -> update-claude-md sequentially"
    - "Each quality check runs as a separate Task() subagent with fresh context"
    - "The chain continues even if a check fails (resilient, no hard-stop)"
  artifacts:
    - path: "commands/mow/refine-phase.md"
      provides: "Claude Code command file (repo canonical source)"
      contains: "name: mow:refine-phase"
    - path: "~/.claude/commands/mow/refine-phase.md"
      provides: "Claude Code command file (installed location)"
      contains: "name: mow:refine-phase"
    - path: "~/.claude/mowism/workflows/refine-phase.md"
      provides: "Workflow orchestration for quality chain"
      contains: "refine-phase"
  key_links:
    - from: "commands/mow/refine-phase.md"
      to: "~/.claude/mowism/workflows/refine-phase.md"
      via: "@-reference in execution_context"
      pattern: "workflows/refine-phase.md"
    - from: "~/.claude/mowism/workflows/refine-phase.md"
      to: "quality skill commands"
      via: "Task() calls referencing /scope-check, /change-summary, etc."
      pattern: "Task\\("
---

<objective>
Create the `/mow:refine-phase` command and workflow implementing the minimum tier quality chain. This establishes the command entry point, tier selection UX, and the sequential chain pattern that the complex/algorithmic tiers (Plan 02-04) extend.

Purpose: Replaces manual quality skill chaining with a single command. The minimum tier is the baseline -- all tiers share Stages 1, 3, 4, 5.

Output: Working `/mow:refine-phase` command that runs minimum tier end-to-end.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-worktree-state-and-quality-gates/02-RESEARCH.md
@.planning/phases/02-worktree-state-and-quality-gates/02-CONTEXT.md
@~/.claude/commands/mow/execute-phase.md
@~/.claude/mowism/workflows/execute-phase.md
@/home/max/git/mowism/commands/scope-check.md
@/home/max/git/mowism/commands/change-summary.md
@/home/max/git/mowism/commands/update-claude-md.md
@~/.claude/mowism/workflows/verify-work.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create refine-phase command file with tier selection</name>
  <files>commands/mow/refine-phase.md, ~/.claude/commands/mow/refine-phase.md</files>
  <action>
Create the command file `commands/mow/refine-phase.md` (repo canonical source) following the exact pattern from `~/.claude/commands/mow/execute-phase.md`:

```yaml
---
name: mow:refine-phase
description: Run tiered quality checks on a completed phase
argument-hint: "<phase-number>"
allowed-tools:
  - Read
  - Write
  - Edit
  - Glob
  - Grep
  - Bash
  - Task
  - AskUserQuestion
---
```

Body structure:
```markdown
<objective>
Run automated quality checks on a completed phase. Presents tier options (Auto, minimum, complex, algorithmic), then orchestrates the quality chain as sequential/parallel Task() subagents.

Runs BETWEEN execute-phase and verify-work in the Mowism workflow.

Context budget: ~15% orchestrator, 100% fresh per subagent.
</objective>

<execution_context>
@~/.claude/mowism/workflows/refine-phase.md
@~/.claude/mowism/references/ui-brand.md
</execution_context>

<context>
Phase: $ARGUMENTS
</context>
```

Copy this file to `~/.claude/commands/mow/refine-phase.md` (install location) with identical content.
  </action>
  <verify>
`cat commands/mow/refine-phase.md | head -5` shows correct frontmatter.
`diff commands/mow/refine-phase.md ~/.claude/commands/mow/refine-phase.md` shows no differences.
  </verify>
  <done>Command file exists in both repo and install locations with correct frontmatter and @-references.</done>
</task>

<task type="auto">
  <name>Task 2: Create refine-phase workflow with tier selection and minimum tier chain</name>
  <files>~/.claude/mowism/workflows/refine-phase.md</files>
  <action>
Create `~/.claude/mowism/workflows/refine-phase.md` as the workflow file. Follow the structure patterns from `execute-phase.md` and `diagnose-issues.md`.

Structure the workflow with these sections:

**`<purpose>`**: Run tiered automated quality checks on a completed phase. Orchestrator stays lean -- delegates each check to a subagent with fresh context.

**`<core_principle>`**: Each quality check runs as a separate Task() with its own 200k context window. The orchestrator only tracks which checks to run, their results, and the output files. Chain NEVER stops on a single check failure.

**`<process>`** with these steps:

**Step 1: `initialize`**
- Load phase context: `INIT=$(node ~/.claude/mowism/bin/mow-tools.cjs init execute-phase "${PHASE_ARG}")`
- Parse phase_dir, phase_number, phase_name from JSON
- Verify phase has summaries (quality checks need completed work to review)
- Create findings directory: `mkdir -p {phase_dir}/VERIFICATION-CHAIN-P{phase_number}`

**Step 2: `select_tier`**
- Use AskUserQuestion to present 4 options:
  ```
  ## Quality Tier Selection

  Choose a quality check tier for Phase {phase_number}: {phase_name}

  1. **Auto** (recommended) -- Claude selects based on phase complexity
  2. **Minimum** -- scope-check, change-summary, verify-work, update-claude-md
  3. **Complex** -- adds simplify + dead-code-sweep + grill-me (parallel)
  4. **Algorithmic** -- adds prove-it to complex tier (parallel)

  Reply with: auto, minimum, complex, or algorithmic
  ```
- Parse user response (case-insensitive, accept "1"/"2"/"3"/"4" or tier names)
- For "auto": implement auto-tier selection logic:
  1. Count plans in phase via phase_dir
  2. Read SUMMARY.md files for change types (look for "algorithm", "performance", "data structure", "proof" keywords)
  3. If any algorithmic indicators found → "algorithmic"
  4. If plan count >= 3 or multiple subsystems → "complex"
  5. Default → "complex" (per research: default to complex when uncertain)
  6. Present auto-selected tier to user: "Auto-selected: {tier} (based on {reason}). Proceeding..."

**Step 3: `execute_chain`**
- For minimum tier (the only tier in this plan):

  **Stage 1 (Gate): scope-check**
  ```
  Task(
    prompt="
      Run /scope-check on the changes made during Phase {phase_number}.

      Context: Phase {phase_number}: {phase_name}
      Phase directory: {phase_dir}

      Read the SUMMARY.md files in {phase_dir} to understand what was built.
      Then check all git commits for this phase.

      After running scope-check, write your findings to:
      {phase_dir}/VERIFICATION-CHAIN-P{phase_number}/scope-check.md

      Format the file with YAML frontmatter:
      ---
      check: scope-check
      phase: {phase_number}
      result: pass|fail
      date: {ISO timestamp}
      duration: (record how long this took)
      ---

      ## Scope Check Findings
      [full output]
    ",
    description="Scope check: Phase {phase_number}"
  )
  ```
  - After Task() returns: read the findings file, extract `result` from frontmatter
  - If scope-check fails: LOG the failure, DO NOT stop the chain
  - Report: "Stage 1 (scope-check): {result}"

  **Stage 3 (Sequential): change-summary**
  Same pattern as scope-check but:
  - Prompt references /change-summary skill
  - Writes to `{phase_dir}/VERIFICATION-CHAIN-P{phase_number}/change-summary.md`
  - Prompt includes: "Read findings from scope-check.md if it exists in the VERIFICATION-CHAIN directory. Note any scope issues in your summary."

  **Stage 4 (Sequential): verify-work**
  Same pattern but:
  - Prompt references the verify-work workflow concepts (goal-backward verification from PLAN must_haves)
  - Writes to `{phase_dir}/VERIFICATION-CHAIN-P{phase_number}/verify-work.md`
  - Note: this is an automated code verification, NOT the interactive UAT from /mow:verify-work

  **Stage 5 (Sequential): update-claude-md**
  Same pattern but:
  - Prompt references /update-claude-md skill
  - Writes to `{phase_dir}/VERIFICATION-CHAIN-P{phase_number}/update-claude-md.md`
  - Special instruction: "Review all findings from the VERIFICATION-CHAIN directory. Propose CLAUDE.md updates based on lessons learned. Write proposed updates to the findings file but DO NOT modify CLAUDE.md -- the user will review."

**Resilience pattern for every Task() call:**
1. Record start time
2. Spawn Task()
3. On success: report result, continue
4. On failure (agent error, timeout):
   - Write error to the check's findings file: "## CHECK FAILED\n\nError: {error message}\n\nThis check could not complete. The quality chain continued without it."
   - Set result to "error"
   - Continue to next stage
5. One retry on transient failures before marking as "error" (per locked decision)
6. Record duration

**Step 4: `report_results`**
- Collect all check results (pass/fail/error)
- Present summary:
  ```
  ## Refine Phase: {phase_number} Complete

  **Tier:** {tier}
  **Result:** {overall - pass if all pass, fail if any fail, mixed if some error}

  | # | Check | Result | Duration |
  |---|-------|--------|----------|
  | 1 | scope-check | pass | 45s |
  | 2 | change-summary | complete | 1m 12s |
  | 3 | verify-work | pass | 1m 30s |
  | 4 | update-claude-md | complete | 20s |

  Findings: {phase_dir}/VERIFICATION-CHAIN-P{phase_number}/
  ```

Note: The VERIFICATION-CHAIN index file and STATE.md verification results update are handled by Plan 02-04, which extends this workflow. For now, the workflow just runs the chain and reports results inline. Plan 02-04 will add the index generation and STATE.md update steps.

For complex and algorithmic tiers: the workflow should include a placeholder comment `<!-- Stage 2 (Parallel): Added by Plan 02-04 -->` between Stage 1 and Stage 3 so Plan 02-04 knows where to insert.
  </action>
  <verify>
`head -5 ~/.claude/mowism/workflows/refine-phase.md` shows `<purpose>` tag.
`grep -c "Task(" ~/.claude/mowism/workflows/refine-phase.md` shows 4 (one per minimum tier check).
`grep "Stage 2" ~/.claude/mowism/workflows/refine-phase.md` shows the placeholder comment.
  </verify>
  <done>
refine-phase workflow exists with tier selection (4 options including Auto), minimum tier chain (4 sequential stages), resilient Task() wrapping with retry, and placeholder for complex/algorithmic tiers.
  </done>
</task>

</tasks>

<verification>
- `ls commands/mow/refine-phase.md ~/.claude/commands/mow/refine-phase.md ~/.claude/mowism/workflows/refine-phase.md` -- all 3 files exist
- Command file has correct YAML frontmatter with Task and AskUserQuestion in allowed-tools
- Workflow has 4 Task() calls for minimum tier
- Tier selection presents Auto, minimum, complex, algorithmic
- Auto-tier has selection logic with default to "complex"
- Each Task() has resilience wrapper (retry on transient, continue on failure)
- Findings directory creation included
</verification>

<success_criteria>
A user can invoke `/mow:refine-phase {phase}`, select "minimum" tier, and the 4-stage chain runs to completion without further input. Each check writes findings to the VERIFICATION-CHAIN directory. Failed checks are logged and the chain continues.
</success_criteria>

<output>
After completion, create `.planning/phases/02-worktree-state-and-quality-gates/02-02-SUMMARY.md`
</output>
