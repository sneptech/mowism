---
phase: 09-multi-phase-execution-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/mow-tools.cjs
  - bin/mow-tools.test.cjs
  - .gitignore
  - mowism/templates/checkpoint.md
autonomous: true
requirements: [EXEC-01, EXEC-03]

must_haves:
  truths:
    - "Running `mow-tools.cjs worktree create 09` creates .worktrees/p09 with a branch, copies .planning/, and initializes STATUS.md"
    - "Running `mow-tools.cjs worktree create 09` when .worktrees/p09 already exists reuses the existing worktree and restores stashed changes"
    - "Manifest at .worktrees/manifest.json tracks all worktrees with status, branch, phase, stash ref, merge state"
    - ".worktrees/ is gitignored so worktree directories are never committed"
    - "Checkpoint template exists and contains frontmatter for phase, plan, status, worker, worktree, timestamp, reason"
    - "Circuit breaker threshold is configurable via .planning/config.json"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "worktree create, worktree list-manifest, worktree merge, worktree stash subcommands"
      contains: "cmdWorktreeCreate"
    - path: "bin/mow-tools.test.cjs"
      provides: "Tests for worktree create, manifest, merge, stash"
      contains: "worktree create"
    - path: ".gitignore"
      provides: "Gitignore entry for .worktrees/"
      contains: ".worktrees/"
    - path: "mowism/templates/checkpoint.md"
      provides: "Checkpoint file template for failure recovery"
      contains: "status:"
  key_links:
    - from: "bin/mow-tools.cjs"
      to: ".worktrees/manifest.json"
      via: "fs.readFileSync/writeFileSync"
      pattern: "manifest\\.json"
    - from: "bin/mow-tools.cjs"
      to: "git worktree add"
      via: "execSync"
      pattern: "git worktree add"
---

<objective>
Worktree management layer and failure recovery infrastructure for multi-phase execution.

Purpose: Phase workers need isolated worktrees per phase. This plan implements the worktree lifecycle (create/reuse/manifest/merge/stash) as mow-tools.cjs subcommands, adds gitignore for `.worktrees/`, creates the checkpoint template for failure recovery, and adds circuit-breaker config support. This is the foundation layer that Plans 02 and 03 build on.

Output: New mow-tools.cjs subcommands for worktree lifecycle, manifest file format, checkpoint template, .gitignore entry, and tests.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-multi-phase-execution-engine/09-CONTEXT.md
@.planning/phases/09-multi-phase-execution-engine/09-RESEARCH.md
@bin/mow-tools.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Worktree lifecycle subcommands and manifest management</name>
  <files>bin/mow-tools.cjs, bin/mow-tools.test.cjs, .gitignore</files>
  <action>
Add the following subcommands to mow-tools.cjs in the Worktree State Tracking section, and wire them into the CLI dispatch:

**1. `worktree create <phase>` subcommand (`cmdWorktreeCreate`):**
- Accept phase number argument and optional `--base <branch>` flag (default: main or master)
- Determine worktree path: `.worktrees/p${paddedPhase}` (e.g., `.worktrees/p09`)
- Determine branch name: `phase-${paddedPhase}` (e.g., `phase-09`)
- **Check manifest for existing worktree:**
  - Read `.worktrees/manifest.json` if it exists
  - If entry exists for this phase AND the directory exists on disk:
    - Log "Reusing existing worktree for phase {N}"
    - If manifest entry has a `stash_ref`, run `git stash pop` in the worktree to restore stashed changes
    - Update manifest entry status to "active"
    - Return `{ created: false, reused: true, path, branch, stash_restored: bool }`
  - If entry exists but directory is gone: remove stale manifest entry, proceed with creation
- **Create new worktree:**
  - Ensure `.worktrees/` directory exists (`mkdir -p`)
  - Run `git worktree add .worktrees/p${paddedPhase} -b phase-${paddedPhase} ${base}` via execSync
  - Copy `.planning/` from main worktree: `cp -r .planning/ .worktrees/p${paddedPhase}/.planning/`
  - Initialize STATUS.md in the new worktree by running `status init ${phase}` from the worktree cwd
  - Update manifest with new entry
  - Return `{ created: true, reused: false, path, branch }`

**2. `worktree list-manifest` subcommand (`cmdWorktreeListManifest`):**
- Read `.worktrees/manifest.json`, return its contents
- If file doesn't exist, return `{ version: "1.0", worktrees: {}, updated: null }`
- Output as JSON

**3. `worktree merge <phase>` subcommand (`cmdWorktreeMerge`):**
- Accept phase number, optional `--into <branch>` (default: main or current branch of main worktree)
- Determine worktree path from manifest or convention
- From the main worktree (cwd), run:
  - `git merge phase-${paddedPhase} --no-ff -m "merge: phase ${phase} into ${into}"`
- If merge fails with conflicts:
  - Return `{ merged: false, conflicts: true, conflict_files: [...] }`
  - Do NOT abort the merge -- the caller (lead or subagent) handles resolution
- If merge succeeds:
  - Update manifest entry: `merged: true, merged_at: ISO timestamp`
  - Return `{ merged: true, conflicts: false }`

**4. `worktree stash <phase>` subcommand (`cmdWorktreeStash`):**
- Determine worktree path from manifest
- Run `git stash push -m "mow-checkpoint-phase-${phase}"` in the worktree
- Capture stash ref from `git stash list` (first entry)
- Update manifest entry with `stash_ref`
- Return `{ stashed: true, stash_ref }`

**5. Manifest helper functions:**
- `readManifest(cwd)`: Read `.worktrees/manifest.json` from the main repo root (not cwd, since cwd may be a worktree). Use `git rev-parse --show-superproject-working-tree` or fall back to checking if `.worktrees/manifest.json` exists relative to the repo root.
- `writeManifest(cwd, manifest)`: Write manifest with `updated` timestamp
- Manifest schema follows the format from 09-RESEARCH.md:
  ```json
  {
    "version": "1.0",
    "project": "{project-name}",
    "worktrees": {
      "p09": {
        "path": ".worktrees/p09",
        "branch": "phase-09",
        "phase": "09",
        "phase_name": "{from find-phase}",
        "created": "ISO-8601",
        "status": "active|merged|stashed|removed",
        "stash_ref": null,
        "last_commit": null,
        "merged": false,
        "merged_at": null
      }
    },
    "updated": "ISO-8601"
  }
  ```

**6. `.gitignore`:**
- Create `.gitignore` at project root if it doesn't exist, or append to it
- Add `.worktrees/` entry (the directory is a local artifact, never committed)

**7. Wire into CLI dispatch:**
- Add cases for `worktree create`, `worktree list-manifest`, `worktree merge`, `worktree stash` in the existing worktree subcommand router

**8. Tests in mow-tools.test.cjs:**
- Test `readManifest` returns default when no manifest exists
- Test `writeManifest` creates valid JSON with updated timestamp
- Test `cmdWorktreeCreate` returns correct structure (mock execSync for git commands)
- Test `cmdWorktreeListManifest` returns manifest contents
- Test manifest reuse detection logic (entry exists + directory exists = reuse)
- Test stale manifest entry cleanup (entry exists + directory gone = recreate)

Use direct `git worktree add` (NOT WorkTrunk `wt switch --create`) per research recommendation (Pitfall 5). This gives predictable subdirectory path control.
  </action>
  <verify>
Run `node bin/mow-tools.cjs worktree list-manifest` from repo root -- should return default empty manifest JSON.
Run tests: `node --test bin/mow-tools.test.cjs 2>&1 | tail -20` -- all tests pass.
Verify `.gitignore` contains `.worktrees/` entry.
  </verify>
  <done>
Four new worktree subcommands (create, list-manifest, merge, stash) exist with manifest management. `.worktrees/` is gitignored. Tests pass for new functionality.
  </done>
</task>

<task type="auto">
  <name>Task 2: Checkpoint template and circuit-breaker configuration</name>
  <files>mowism/templates/checkpoint.md, bin/mow-tools.cjs</files>
  <action>
**1. Create checkpoint template at `mowism/templates/checkpoint.md`:**

The template is used by phase workers when they fail, pause, or get cancelled. It must be detailed enough for a completely new worker in a fresh session to resume from exactly where work stopped (locked decision).

```markdown
---
phase: {phase}
plan: {plan}
status: {failed|paused|cancelled|timeout}
worker: {worker-name}
worktree: {worktree-path}
timestamp: {ISO-8601}
reason: {user_cancel|timeout|error}
circuit_breaker_hit: {true|false}
---

## Completed Plans

{List of plans with SUMMARY.md files and commit hashes, or "None" if first plan}

## Current Plan State

**Plan:** {plan-id}
**Task:** {task-number} of {total-tasks}
**Task name:** {task-name}
**What was completed in this task:** {description of completed work within the current task}

## Uncommitted Changes

{Output of `git diff --stat` from worktree, or "None"}

## Stashed Changes

{Stash reference if changes were stashed via `worktree stash`, or "None"}

## Error Context

{Error message and what was being attempted, or "N/A" for user_cancel/pause}

## Resume Instructions

1. Switch to worktree: `cd {worktree-path}`
2. Run smoke test on completed plans: {list of verification commands from completed plan SUMMARYs}
3. Continue from plan {plan-id}, task {task-number}: {task-name}
4. {Specific guidance based on failure point}
```

**2. Add circuit breaker config support in mow-tools.cjs:**

In `loadConfig()` or wherever config defaults are established, add:
- `multi_phase.circuit_breaker_threshold` with default value `2` (locked decision: configurable threshold, default 2)
- `multi_phase.merge_timing` with default value `"batch"` (locked decision: batch at wave boundaries by default, toggleable to "immediate")
- `multi_phase.worktree_metadata_push` with default value `false` (toggle option to include worktree metadata when pushing to remote)

Add a `config-get` path that can read these nested values (the existing `cmdConfigGet` should handle dot-notation like `multi_phase.circuit_breaker_threshold`).

Verify the existing `cmdConfigGet` function supports nested key paths. If it already does (it reads from config.json with dot-path traversal), no changes needed. If not, add dot-path traversal.

**3. Add `template fill checkpoint` support:**

Extend `cmdTemplateFill` to handle `type: 'checkpoint'`. It should:
- Read `mowism/templates/checkpoint.md` (using the same template path resolution: repo-relative first, then `~/.claude/mowism/templates/`)
- Replace `{phase}`, `{plan}`, `{status}`, `{worker-name}`, `{worktree-path}`, `{timestamp}`, `{reason}` placeholders
- Return the filled template string
  </action>
  <verify>
Run `node bin/mow-tools.cjs template fill checkpoint --phase 09 --plan 01 --status failed --worker phase-09 --worktree .worktrees/p09` and verify it outputs a filled checkpoint template with correct values.
Run `node bin/mow-tools.cjs config-get multi_phase.circuit_breaker_threshold` and verify it returns `2` (or the configured value).
Verify `mowism/templates/checkpoint.md` exists and contains all required sections.
  </verify>
  <done>
Checkpoint template exists with all sections from the locked decision (completed plans, current plan state, uncommitted changes, stashed changes, error context, resume instructions). Circuit breaker threshold is configurable via config.json. Template fill supports checkpoint type.
  </done>
</task>

</tasks>

<verification>
1. `node bin/mow-tools.cjs worktree list-manifest` returns valid JSON
2. `.gitignore` contains `.worktrees/` entry
3. `mowism/templates/checkpoint.md` exists with frontmatter and all required sections
4. `node bin/mow-tools.cjs config-get multi_phase.circuit_breaker_threshold` returns `2`
5. All existing tests still pass: `node --test bin/mow-tools.test.cjs`
6. New tests pass for worktree create/manifest/merge/stash
</verification>

<success_criteria>
- Four new worktree subcommands operational (create, list-manifest, merge, stash)
- Manifest JSON format matches research specification
- Worktree reuse detection works (existing entry + existing directory = reuse)
- Checkpoint template is complete and fillable
- Circuit breaker and merge timing are configurable
- `.worktrees/` is gitignored
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-multi-phase-execution-engine/09-01-SUMMARY.md`
</output>
