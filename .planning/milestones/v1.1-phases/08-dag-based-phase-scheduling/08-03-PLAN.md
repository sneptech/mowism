---
phase: 08-dag-based-phase-scheduling
plan: 03
type: execute
wave: 3
depends_on:
  - 08-02
files_modified:
  - agents/mow-dag-analyzer.md
  - agents/mow-roadmapper.md
autonomous: true
requirements:
  - DAG-03

must_haves:
  truths:
    - "A `mow-dag-analyzer` agent exists that analyzes roadmap phases for genuine dependency relationships"
    - "The agent classifies parallelism with confidence tiers (HIGH=auto, MEDIUM=prompt user, LOW=sequential)"
    - "The agent detects and interactively resolves circular dependencies"
    - "Missing dependency references are treated as warnings, not errors"
    - "The roadmapper agent spawns the DAG analyzer after generating phases"
    - "The DAG analyzer can be manually re-invoked to update dependencies after roadmap changes"
  artifacts:
    - path: "agents/mow-dag-analyzer.md"
      provides: "DAG analysis agent with confidence-tiered parallelism detection, cycle resolution, file conflict awareness"
      contains: "mow-dag-analyzer"
    - path: "agents/mow-roadmapper.md"
      provides: "Updated roadmapper that spawns mow-dag-analyzer after phase generation"
      contains: "mow-dag-analyzer"
  key_links:
    - from: "agents/mow-roadmapper.md"
      to: "agents/mow-dag-analyzer.md"
      via: "Task() subagent spawn after phase generation"
      pattern: "mow-dag-analyzer"
    - from: "agents/mow-dag-analyzer.md"
      to: "bin/mow-tools.cjs (roadmap analyze-dag)"
      via: "CLI invocation for validation"
      pattern: "roadmap analyze-dag"
---

<objective>
Create the `mow-dag-analyzer` agent that performs confidence-tiered dependency analysis on roadmap phases, and integrate it into the roadmapper workflow as an auto-spawned subagent.

Purpose: LLMs generating roadmaps tend to create overly conservative linear chains. The DAG analyzer examines phase goals, requirements, success criteria, and optionally codebase context to determine which phases are genuinely independent vs which have real data dependencies. This enables parallel execution in Phase 9.

Output: New `mow-dag-analyzer.md` agent definition, updated `mow-roadmapper.md` with DAG analyzer integration.
</objective>

<execution_context>
@/home/max/.claude/mowism/workflows/execute-plan.md
@/home/max/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-dag-based-phase-scheduling/08-RESEARCH.md
@.planning/phases/08-dag-based-phase-scheduling/08-02-SUMMARY.md
@agents/mow-roadmapper.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mow-dag-analyzer agent definition</name>
  <files>agents/mow-dag-analyzer.md</files>
  <action>
Create `agents/mow-dag-analyzer.md` with the following structure:

**Frontmatter:**
```yaml
---
name: mow-dag-analyzer
description: Analyzes roadmap phase dependencies to detect genuine parallelism with confidence-tiered classification. Spawned by mow-roadmapper or invoked manually.
tools: Read, Write, Bash, Glob, Grep
color: cyan
---
```

**Role section:**
- Specialized agent for dependency graph analysis
- Spawned by `mow-roadmapper` after phase generation, or manually via `/mow:new-project` re-analysis
- Job: Determine which phases are genuinely independent (can run in parallel) vs which have real data dependencies

**Analysis protocol (core loop):**
For each pair of phases (A, B) where A.number < B.number:
1. Read phase A and B goals, requirements, success criteria from ROADMAP.md
2. Check requirement category overlap (same REQ- prefix = likely dependent)
3. Check success criteria overlap (mentions same features/systems)
4. If `.planning/codebase/` exists, check STRUCTURE.md for which directories each phase would modify, check ARCHITECTURE.md for system boundaries
5. Classify the relationship:
   - **HIGH confidence independent**: Different requirement categories, different success criteria domains, different file areas. Auto-parallelize.
   - **MEDIUM confidence**: Some overlap but unclear if causal. Prompt user to decide.
   - **LOW confidence**: Same requirement category, overlapping files, or B's success criteria assume A's output. Keep sequential.
6. Only emit a `Depends on` edge if dependency is genuine (B needs artifact from A)

**Confidence tier thresholds:**
- HIGH: Zero requirement category overlap AND (if codebase context available) different file areas AND phase goals use different domain vocabulary
- MEDIUM: Shared requirement category but different specific requirements, OR some overlapping files but different sections, OR one phase creates something the other might reference but doesn't explicitly require
- LOW: Shared specific requirements, same files in goals/success criteria, B's criteria assume A's output exists

**Circular dependency handling (per locked decision):**
- When detected, show exact cycle path to user
- Suggest which edge to break with reasoning
- Confirm with user before making changes (NEVER auto-break)

**Missing dependency references:**
- Treat as satisfied (don't block analysis)
- Log warning in both CLI output and as a comment in ROADMAP.md
- The reference is aspirational, not broken

**Runtime file conflict awareness:**
- When two parallel phases would touch the same files, note this in the `**Parallel with**:` annotation
- Format: `**Parallel with**: Phase X (CAUTION: both touch bin/mow-tools.cjs -- coordinate file access)`
- This is analysis-time detection; runtime handling is Phase 9's job (per deferred decisions)

**Output format:**
The agent writes directly to ROADMAP.md:
1. Updates `**Depends on**:` fields with analyzed dependencies
2. Adds or updates `**Parallel with**:` advisory fields
3. Runs `mow-tools.cjs roadmap analyze-dag` to validate the result
4. Reports summary with confidence breakdown

**Sequential DAG validation (per locked decision):**
- If analysis produces a fully sequential DAG, trust the result
- Don't flag or question an all-sequential outcome

**Constraints section:**
- NEVER auto-break circular dependencies without user confirmation
- NEVER treat `Parallel with` as a constraint (it's advisory only; real constraints are `Depends on` edges)
- NEVER do deep code path analysis or build call graphs -- lightweight analysis only
- Default to INDEPENDENT rather than DEPENDENT when uncertain (over-constraining is worse than under-constraining for execution efficiency)
- Missing references are aspirational, not errors

**Structured return:**
```markdown
## DAG ANALYSIS COMPLETE

**Phases analyzed:** {N}
**Parallelism found:** {yes/no}

### Confidence Breakdown

| Phase Pair | Confidence | Relationship | Reason |
|------------|-----------|--------------|--------|
| 7 vs 8 | HIGH | Independent | Different domains: state layer vs roadmap parsing |
| 9 vs 10 | MEDIUM | Independent | Both need Phase 7 but different outputs |

### Changes Made

- Phase 8: `Depends on` updated from "Phase 7" to "Nothing"
- Phase 8: `Parallel with` added: "Phase 7 (different file domains)"

### Validation

{output of roadmap analyze-dag}
```
  </action>
  <verify>
Verify file exists at `agents/mow-dag-analyzer.md` with correct frontmatter (name, description, tools, color). Verify it contains sections for: role, analysis protocol, confidence tiers, circular dependency handling, missing references, file conflict awareness, output format, constraints, and structured return.
  </verify>
  <done>
`mow-dag-analyzer.md` exists with complete agent definition. Contains confidence tier thresholds (HIGH/MEDIUM/LOW), cycle resolution protocol, missing reference handling, file conflict warnings, and ROADMAP.md write-back format.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate DAG analyzer into roadmapper workflow</name>
  <files>agents/mow-roadmapper.md</files>
  <action>
Update `agents/mow-roadmapper.md` to spawn the DAG analyzer after initial phase generation.

**1. Add to the `<execution_flow>` section**, after Step 7 (Write Files Immediately) and before Step 8 (Return Summary), add a new step:

```markdown
## Step 7.5: DAG Analysis (after phase generation)

After writing ROADMAP.md with initial phase structure:

1. Spawn the DAG analyzer agent to analyze dependencies:
   ```
   Use Task() to spawn mow-dag-analyzer subagent with context:
   - The ROADMAP.md just written
   - .planning/codebase/ files if they exist
   - Instruction: analyze all phases, update Depends on fields, add Parallel with annotations
   ```

2. Wait for DAG analyzer to complete

3. Verify the result:
   ```bash
   node ~/.claude/mowism/bin/mow-tools.cjs roadmap analyze-dag --raw
   ```

4. If cycles detected: the DAG analyzer will have prompted the user for resolution. Re-read ROADMAP.md for updated state.

5. Include DAG analysis summary in the roadmap return.

**Note:** The DAG analyzer writes directly to ROADMAP.md. The roadmapper validates the result but doesn't need to merge output.
```

**2. Update the `<structured_returns>` section** to include DAG analysis in the `## ROADMAP CREATED` template:

Add after the `### Coverage` section:
```markdown
### Dependency Analysis

{DAG analyzer summary -- parallelism found, confidence breakdown}

**Execution waves:**
{from roadmap analyze-dag output}
```

**3. Add a note in the `<downstream_consumer>` section:**

Add a row to the table:
```
| Dependency graph | Determines parallel execution order |
```

**4. Add DAG analyzer to the tools/agents reference.**
In the role section or a new agents reference section, note:
```
Spawns: mow-dag-analyzer (after phase generation, for dependency analysis)
```
  </action>
  <verify>
Read `agents/mow-roadmapper.md` and verify: (1) Step 7.5 exists with DAG analyzer spawn, (2) structured return includes dependency analysis, (3) downstream consumer table includes dependency graph, (4) mow-dag-analyzer referenced as spawned agent.
  </verify>
  <done>
`mow-roadmapper.md` spawns `mow-dag-analyzer` after phase generation. Structured return includes DAG analysis summary. Downstream consumer table updated. Agent reference documented.
  </done>
</task>

</tasks>

<verification>
1. `agents/mow-dag-analyzer.md` exists with valid agent frontmatter
2. Agent has confidence tier system matching locked decisions (HIGH=auto, MEDIUM=prompt, LOW=sequential)
3. Agent handles circular dependencies interactively (per locked decision)
4. Agent treats missing references as warnings (per locked decision)
5. Agent detects file conflicts at analysis time (per locked decision)
6. `agents/mow-roadmapper.md` spawns DAG analyzer after phase generation
7. Both agents reference `roadmap analyze-dag` for validation
</verification>

<success_criteria>
- `mow-dag-analyzer.md` agent created with complete dependency analysis protocol
- Confidence tiers: HIGH (auto-parallelize), MEDIUM (prompt user), LOW (keep sequential)
- Circular dependencies: interactive resolution with user confirmation
- Missing references: treated as satisfied with warnings
- File conflict detection: noted in Parallel with annotations
- Roadmapper integration: DAG analyzer spawned after phase generation
- Manual re-invocation supported for post-change dependency updates
</success_criteria>

<output>
After completion, create `.planning/phases/08-dag-based-phase-scheduling/08-03-SUMMARY.md`
</output>
