---
phase: 07-state-coherence-foundation
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02", "07-03"]
files_modified:
  - mowism/workflows/execute-plan.md
  - agents/mow-team-lead.md
autonomous: true
requirements: [STATE-01]

must_haves:
  truths:
    - "The execute-plan.md workflow's update_current_position step writes STATUS.md (via `status write`) and sends a structured message (via `message format`) instead of calling `state advance-plan` directly"
    - "The execute-plan.md workflow's extract_decisions_and_issues step sends decisions/blockers as messages instead of calling `state add-decision` and `state add-blocker` directly"
    - "The mow-team-lead.md agent uses the current Agent Teams API (SendMessage, TeamCreate, TeamDelete) instead of the old Teammate API"
    - "The mow-team-lead.md agent has a message processing handler that parses worker JSON messages and calls `state update-phase-row` to update the Active Phases table"
    - "Backward compatibility: in single-agent mode (no Agent Teams), execute-plan.md still writes STATE.md directly as a fallback"
  artifacts:
    - path: "mowism/workflows/execute-plan.md"
      provides: "Updated executor workflow with STATUS.md writes and structured messaging"
      contains: "status write"
    - path: "agents/mow-team-lead.md"
      provides: "Updated lead orchestrator with current API and message processing"
      contains: "SendMessage"
  key_links:
    - from: "mowism/workflows/execute-plan.md update_current_position"
      to: "bin/mow-tools.cjs status write"
      via: "worker writes own STATUS.md instead of shared STATE.md"
      pattern: "status write"
    - from: "mowism/workflows/execute-plan.md update_current_position"
      to: "SendMessage"
      via: "worker sends structured message to coordinator"
      pattern: "message format"
    - from: "agents/mow-team-lead.md message handler"
      to: "bin/mow-tools.cjs state update-phase-row"
      via: "coordinator processes worker messages and updates Active Phases table"
      pattern: "state update-phase-row"
---

<objective>
Wire the execute-plan workflow and team lead agent to use the single-writer protocol: workers write STATUS.md + send messages, coordinator writes STATE.md.

Purpose: This is the enforcement plan. Plans 01-03 built the infrastructure (STATUS.md format, message schema, Active Phases table). This plan wires them into the actual workflows so the single-writer protocol is in effect during real execution. Without this, workers would still write STATE.md directly (the v1.0 behavior), violating the protocol.

Output: Updated execute-plan.md with STATUS.md writes and messaging, updated mow-team-lead.md with current Agent Teams API and message processing.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-state-coherence-foundation/07-RESEARCH.md
@.planning/phases/07-state-coherence-foundation/07-01-SUMMARY.md
@.planning/phases/07-state-coherence-foundation/07-02-SUMMARY.md
@.planning/phases/07-state-coherence-foundation/07-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update execute-plan.md for single-writer protocol</name>
  <files>
    mowism/workflows/execute-plan.md
  </files>
  <action>
  Modify `mowism/workflows/execute-plan.md` to implement the single-writer protocol. Workers write STATUS.md and send messages; only the coordinator writes STATE.md.

  **Key principle:** Backward compatibility. In single-agent mode (when Agent Teams is not active), the workflow should still write STATE.md directly. The messaging path is for multi-agent mode.

  **1. Modify `<step name="update_current_position">` (lines 336-350):**

  Replace the current content with a dual-path approach:

  ```markdown
  <step name="update_current_position">
  Update progress -- the path depends on whether this is a multi-agent (Agent Teams) or single-agent execution.

  **Multi-agent mode (running as a worker in a team):**

  Workers NEVER write STATE.md directly. Instead:

  1. Update own STATUS.md:
  ```bash
  # Update the plan row in this phase's STATUS.md
  node ~/.claude/mowism/bin/mow-tools.cjs status write "${PHASE_NUMBER}" \
    --plan "${PHASE}-${PLAN}" --status complete \
    --commit "${TASK_COMMIT}" --duration "${DURATION}" \
    --tasks "${TASK_COUNT}/${TOTAL_TASKS}"
  ```

  2. Send structured message to coordinator:
  ```bash
  # Format the message
  MSG=$(node ~/.claude/mowism/bin/mow-tools.cjs message format plan_complete \
    --phase "${PHASE_NUMBER}" --plan "${PHASE}-${PLAN}" \
    --commit "${TASK_COMMIT}" --duration-min "${DURATION_MIN}" --raw)

  # Send via Agent Teams SendMessage
  # The coordinator will update STATE.md upon receiving this message
  ```

  Use SendMessage({ type: "message", recipient: "team-lead", content: $MSG, summary: "Phase ${PHASE_NUMBER}: plan ${PHASE}-${PLAN} complete (${DURATION})" })

  **Single-agent mode (no team, backward compatible):**

  ```bash
  # Legacy path -- still works when not in a team
  node ~/.claude/mowism/bin/mow-tools.cjs state advance-plan
  node ~/.claude/mowism/bin/mow-tools.cjs state update-progress
  node ~/.claude/mowism/bin/mow-tools.cjs state record-metric \
    --phase "${PHASE}" --plan "${PLAN}" --duration "${DURATION}" \
    --tasks "${TASK_COUNT}" --files "${FILE_COUNT}"
  ```

  **Detection:** Check if running in an Agent Teams context (look for team membership, or check if STATUS.md exists for this phase -- indicating the coordinator initialized it). If STATUS.md exists at `{phase_dir}/{padded}-STATUS.md`, use multi-agent path. Otherwise, fall back to single-agent path.
  </step>
  ```

  **2. Modify `<step name="extract_decisions_and_issues">` (lines 353-363):**

  Add the same dual-path pattern:

  ```markdown
  <step name="extract_decisions_and_issues">
  From SUMMARY: Extract decisions and add to project context.

  **Multi-agent mode (STATUS.md exists for this phase):**

  1. Log decisions in own STATUS.md (append to ## Decisions section):
  ```bash
  # Decisions stay in STATUS.md for this phase
  # The coordinator will read them from STATUS.md if needed
  ```

  2. If there are blockers, send a structured blocker message:
  ```bash
  MSG=$(node ~/.claude/mowism/bin/mow-tools.cjs message format blocker \
    --phase "${PHASE_NUMBER}" --plan "${PHASE}-${PLAN}" \
    --blocker "${BLOCKER_DESC}" --action "skip" --raw)
  ```

  Use SendMessage to coordinator with the blocker message. Per locked decision: default behavior is skip-and-continue (worker moves to next available task).

  **Single-agent mode (no STATUS.md -- legacy path):**

  ```bash
  node ~/.claude/mowism/bin/mow-tools.cjs state add-decision \
    --phase "${PHASE}" --summary "${DECISION_TEXT}" --rationale "${RATIONALE}"

  node ~/.claude/mowism/bin/mow-tools.cjs state add-blocker "Blocker description"
  ```
  </step>
  ```

  **3. Modify `<step name="update_session_continuity">` (lines 366-375):**

  Add multi-agent path: workers do NOT update session continuity (that is coordinator state). Only single-agent mode updates session continuity.

  ```markdown
  <step name="update_session_continuity">
  **Multi-agent mode:** Skip -- session continuity is coordinator-owned state.
  The coordinator updates this based on overall team progress.

  **Single-agent mode:**
  ```bash
  node ~/.claude/mowism/bin/mow-tools.cjs state record-session \
    --stopped-at "Completed ${PHASE}-${PLAN}-PLAN.md" \
    --resume-file "None"
  ```
  </step>
  ```

  **4. Add a note at the top of `<step name="init_context">`:**

  After loading INIT JSON, add detection logic:

  ```markdown
  **Detect multi-agent mode:**
  ```bash
  # Check if STATUS.md exists for this phase (coordinator initialized it)
  MULTI_AGENT=false
  STATUS_PATH="${PHASE_DIR}/${PADDED_PHASE}-STATUS.md"
  if [ -f "$STATUS_PATH" ]; then
    MULTI_AGENT=true
    # Mark plan as started in STATUS.md
    node ~/.claude/mowism/bin/mow-tools.cjs status write "${PHASE_NUMBER}" \
      --plan "${PHASE}-${PLAN}" --status "in progress"
  fi
  ```
  ```

  **5. Preserve all other steps unchanged.** Only the state-writing steps change. Task execution, verification, SUMMARY creation, commit protocol, checkpoint handling -- all remain the same.
  </action>
  <verify>
  Read the modified `execute-plan.md`. Confirm:
  1. `update_current_position` has both multi-agent (status write + message) and single-agent (state advance-plan) paths
  2. `extract_decisions_and_issues` has both paths
  3. `update_session_continuity` skips in multi-agent mode
  4. Detection logic uses STATUS.md existence as the indicator
  5. All other steps are preserved unchanged
  6. `grep "state advance-plan" mowism/workflows/execute-plan.md` still finds the command (in the single-agent fallback path)
  </verify>
  <done>
  - execute-plan.md has dual-path state updates: multi-agent (STATUS.md + messages) and single-agent (STATE.md direct)
  - Multi-agent detection uses STATUS.md existence as the signal
  - Workers never write STATE.md in multi-agent mode
  - Workers send structured JSON messages via SendMessage for plan_complete and blocker events
  - Single-agent backward compatibility is fully preserved
  </done>
</task>

<task type="auto">
  <name>Task 2: Update mow-team-lead.md for current API and message processing</name>
  <files>
    agents/mow-team-lead.md
  </files>
  <action>
  Rewrite the Agent Teams API references in `agents/mow-team-lead.md` to use the current API (TeamCreate, SendMessage, TaskCreate, TaskUpdate, TaskList, TaskGet, TeamDelete) instead of the old Teammate API. Also add a structured message processing handler.

  **1. Update tool list in frontmatter:**

  Change `tools:` line from:
  ```
  tools: Read, Bash, Grep, Glob, Teammate, Task, TaskCreate, TaskUpdate, TaskList
  ```
  to:
  ```
  tools: Read, Bash, Grep, Glob, Task, TeamCreate, SendMessage, TaskCreate, TaskUpdate, TaskList, TaskGet, TeamDelete
  ```

  **2. Update Step 2 (Create Team):**

  Replace:
  ```
  Teammate({ operation: "spawnTeam", team_name: "mow-{project-slug}" })
  ```
  With:
  ```
  TeamCreate({ team_name: "mow-{project-slug}" })
  ```

  **3. Update all Teammate write/broadcast calls throughout the file:**

  Replace the old `Teammate({ operation: "write", teammate: "...", message: "..." })` pattern with:
  ```
  SendMessage({ type: "message", recipient: "{worker-name}", content: "{message}", summary: "{5-10 word preview}" })
  ```

  Replace `Teammate({ operation: "broadcast", message: "..." })` with:
  ```
  SendMessage({ type: "broadcast", content: "{message}", summary: "{5-10 word preview}" })
  ```

  Replace `Teammate({ operation: "requestShutdown" })` with:
  ```
  SendMessage({ type: "shutdown_request", recipient: "{worker-name}", content: "All work complete" })
  ```

  Replace `Teammate({ operation: "cleanup" })` with:
  ```
  TeamDelete()
  ```

  **4. Add a new section `<message_processing>` to the agent definition:**

  This section teaches the coordinator how to handle incoming worker messages:

  ```markdown
  <message_processing>
  ## Processing Worker Messages

  Workers send structured JSON messages via SendMessage. When you receive a message, process it:

  ### Parse the Message

  ```bash
  PARSED=$(node ~/.claude/mowism/bin/mow-tools.cjs message parse '${MESSAGE_CONTENT}' --raw)
  ```

  ### Handle by Event Type

  | Event Type | Action |
  |-----------|--------|
  | `plan_started` | Update Active Phases: `state update-phase-row {phase} --plans "{progress}" --last-update "{ts}"` |
  | `plan_complete` | Update Active Phases plans count. Record metric. If last plan in phase: trigger phase_complete handling |
  | `phase_complete` | Update Active Phases: `state update-phase-row {phase} --status complete`. Check if any blocked phases are now unblocked. If so, spawn workers for them. |
  | `error` | Log error. Read worker's STATUS.md for detail. Decide: retry, skip, or escalate to user. |
  | `blocker` | Read blocker detail from worker's STATUS.md. If action="skip", acknowledge. If action="pause" (strict mode), decide resolution and send ack. |
  | `state_change` | Update Active Phases table with new status. Informational -- no action required unless transition is unexpected. |

  ### Send Acknowledgment

  Per locked decision: acknowledged delivery model. After processing a milestone message (plan_complete, phase_complete, error, blocker), send an ack:

  ```bash
  ACK=$(node ~/.claude/mowism/bin/mow-tools.cjs message format ack --ref-type "{original_type}" --ref-plan "{plan}" --raw)
  ```

  SendMessage({ type: "message", recipient: "{worker-name}", content: ACK, summary: "Ack: {type} {plan}" })

  ### Batch Acks at Wave Transitions

  To avoid excessive ack overhead, accumulate acks during wave execution and send them in bulk at wave boundaries. For strict-mode blocker messages, send acks immediately.

  </message_processing>
  ```

  **5. Update Step 5 (Monitor Progress) to reference STATUS.md:**

  When the coordinator needs detail beyond what messages provide, it reads the worker's STATUS.md directly:

  ```markdown
  For detailed progress, read the worker's STATUS.md:
  ```bash
  node ~/.claude/mowism/bin/mow-tools.cjs status read {phase_number} --raw
  ```
  This gives full plan progress, blocker detail, and phase-specific decisions -- without the worker needing to include all that in messages.
  ```

  **6. Update Step 6 (Complete Team) to use TeamDelete:**

  Replace cleanup section to use `TeamDelete()` instead of `Teammate({ operation: "cleanup" })`.

  **7. Ensure all `Teammate` references are replaced.** Do a thorough pass to replace every occurrence of the old API.
  </action>
  <verify>
  Run: `grep -c "Teammate" agents/mow-team-lead.md` -- should return 0 (all old API references removed).
  Run: `grep -c "SendMessage\|TeamCreate\|TeamDelete" agents/mow-team-lead.md` -- should return multiple matches (new API in use).
  Run: `grep "message format\|message parse\|status read\|state update-phase-row" agents/mow-team-lead.md` -- should find references to the new mow-tools.cjs subcommands.
  </verify>
  <done>
  - All Teammate API references replaced with current API (TeamCreate, SendMessage, TeamDelete)
  - Message processing handler teaches coordinator to parse worker JSON messages and update Active Phases table
  - Acknowledged delivery pattern documented with batch-ack-at-wave-transitions optimization
  - STATUS.md reading documented for when coordinator needs detail beyond messages
  - Worker SendMessage patterns include summary field for quick preview
  </done>
</task>

</tasks>

<verification>
1. `grep "Teammate" mowism/workflows/execute-plan.md agents/mow-team-lead.md` returns zero matches (old API fully removed from both files)
2. `execute-plan.md` has dual-path state updates with STATUS.md detection
3. `mow-team-lead.md` references TeamCreate, SendMessage, TeamDelete, and mow-tools.cjs status/message subcommands
4. The single-writer protocol is enforced: workers write STATUS.md + send messages; coordinator writes STATE.md
5. Single-agent backward compatibility preserved in execute-plan.md
</verification>

<success_criteria>
- Workers (via execute-plan.md) never write STATE.md in multi-agent mode -- they write STATUS.md and send structured messages
- Coordinator (via mow-team-lead.md) is the sole STATE.md writer, processing worker messages to update the Active Phases table
- Agent Teams API is current: TeamCreate, SendMessage (type: message/broadcast/shutdown_request), TeamDelete
- Backward compatibility: single-agent mode still writes STATE.md directly via the existing commands
- Message processing handler covers all 7 event types with appropriate coordinator actions
</success_criteria>

<output>
After completion, create `.planning/phases/07-state-coherence-foundation/07-04-SUMMARY.md`
</output>
