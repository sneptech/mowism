---
phase: 07-state-coherence-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - mowism/templates/state.md
  - bin/mow-tools.cjs
  - bin/mow-tools.test.cjs
autonomous: true
requirements: [STATE-04]

must_haves:
  truths:
    - "STATE.md template contains an Active Phases table section instead of (or in addition to) the Current Position section"
    - "Running `mow-tools.cjs state active-phases --raw` returns a JSON array of phase rows from the Active Phases table"
    - "Running `mow-tools.cjs state update-phase-row 7 --status executing --worker worker-green --plans 1/4 --raw` updates exactly one row in the Active Phases table without corrupting other rows"
    - "The Active Phases table supports showing all phases simultaneously (completed, active, blocked, future)"
  artifacts:
    - path: "mowism/templates/state.md"
      provides: "Updated STATE.md template with Active Phases table replacing Current Position"
      contains: "## Active Phases"
    - path: "bin/mow-tools.cjs"
      provides: "state active-phases and state update-phase-row subcommands"
      contains: "cmdStateActivePhases"
    - path: "bin/mow-tools.test.cjs"
      provides: "Tests for Active Phases table operations"
      contains: "active-phases"
  key_links:
    - from: "bin/mow-tools.cjs cmdStateUpdatePhaseRow"
      to: ".planning/STATE.md Active Phases table"
      via: "parses table, finds row by phase number, updates fields, rewrites table"
      pattern: "Active Phases"
    - from: "mowism/templates/state.md"
      to: "new-project workflow"
      via: "template used when creating new projects"
      pattern: "Active Phases"
---

<objective>
Restructure STATE.md from a single-phase "Current Position" view to a multi-phase "Active Phases" table that serves as a lightweight index for the coordinator.

Purpose: The coordinator needs to track multiple concurrent phases at a glance. The current "Current Position" section only shows one phase. The Active Phases table shows all phases with their status, assigned worker, plan progress, and last update time -- enabling parallel phase execution.

Output: Updated state.md template, two new mow-tools.cjs subcommands (`state active-phases`, `state update-phase-row`), and tests.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-state-coherence-foundation/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update STATE.md template and add Active Phases subcommands</name>
  <files>
    mowism/templates/state.md
    bin/mow-tools.cjs
  </files>
  <action>
  **1. Update `mowism/templates/state.md`:**

  Add an "Active Phases" section to the template. Keep the "Current Position" section as well for backward compatibility in single-agent mode (both can coexist -- the Active Phases table is the v1.1 multi-agent view, Current Position is the v1.0 single-agent view). The template should document both sections.

  Add to the template's File Template section, BETWEEN the "Current Position" section and "Performance Metrics" section:

  ```markdown
  ## Active Phases

  | Phase | Name | Status | Worker | Plans | Last Update |
  |-------|------|--------|--------|-------|-------------|

  **Next unblockable:** --
  ```

  Add a corresponding documentation section in the template explaining:
  - Active Phases is the v1.1 multi-agent coordinator dashboard
  - Each row represents one phase with: phase number, name, status (not started / executing / complete / blocked / failed), assigned worker name (or `--`), plan progress as `N/M`, and ISO timestamp of last update
  - The "Next unblockable" line shows which blocked phase will become available first
  - This table is coordinator-owned -- only the coordinator writes to it
  - Per-phase detail is in `phases/XX/XX-STATUS.md` -- this table is the cached summary view

  Status values for phases in the Active Phases table: `not started`, `executing`, `complete`, `blocked (N,M)`, `failed`
  - `blocked (7,8)` means blocked on phases 7 and 8 completing

  **2. Add two new functions to `bin/mow-tools.cjs`:**

  **`cmdStateActivePhases(cwd, raw)`:**
  - Reads STATE.md
  - Finds the `## Active Phases` section
  - Parses the table using the same `|`-split-and-trim pattern from `parseWorktreeTable()` and `parseTeammateTable()`
  - Returns JSON array of rows: `[{ phase, name, status, worker, plans, last_update }, ...]`
  - If no Active Phases section found, return empty array with a warning

  **`cmdStateUpdatePhaseRow(cwd, phase, options, raw)`:**
  - Options: `--status <s> --worker <w> --plans <progress> --last-update <ts> --name <n>`
  - Reads STATE.md
  - Finds the `## Active Phases` section and parses the table
  - Finds the row matching `phase` number
  - If row not found and all required fields provided (name, status), INSERT a new row for this phase
  - If row found, updates only the specified fields (keeps existing values for unspecified fields)
  - Rewrites the entire Active Phases section (header + updated table)
  - Also updates the `**Next unblockable:**` line by examining which phases have `blocked` status and what they're blocked on
  - Returns JSON: `{ updated: true, phase: N, fields_changed: [...] }`

  Use the existing `stateReplaceField()` or section-replacement pattern from `writeWorktreeTable()` / `writeTeammateTable()` for rewriting the table in STATE.md.

  **`parseActivePhasesTable(content)` helper (internal, not a CLI subcommand):**
  - Same pattern as `parseWorktreeTable()`:
    ```javascript
    function parseActivePhasesTable(content) {
      const rows = [];
      const sectionMatch = content.match(
        /## Active Phases\n[\s\S]*?\n\|[^\n]+\n\|[-|\s]+\n([\s\S]*?)(?=\n\*\*|$)/
      );
      if (!sectionMatch) return rows;
      const tableBody = sectionMatch[1].trim();
      for (const line of tableBody.split('\n')) {
        if (!line.startsWith('|')) continue;
        const cells = line.split('|').map(c => c.trim()).filter(c => c);
        if (cells.length >= 6) {
          rows.push({
            phase: cells[0], name: cells[1], status: cells[2],
            worker: cells[3], plans: cells[4], last_update: cells[5],
          });
        }
      }
      return rows;
    }
    ```

  **`writeActivePhasesTable(content, rows, nextUnblockable)` helper:**
  - Builds the table header + rows + metadata line
  - Replaces the existing `## Active Phases` section in content using the section-replacement regex pattern

  **3. Add CLI routing** in the `main()` function's `state` case:

  Add these subcommand handlers alongside the existing state subcommands:

  ```javascript
  } else if (subcommand === 'active-phases') {
    cmdStateActivePhases(cwd, raw);
  } else if (subcommand === 'update-phase-row') {
    const phase = args[2];
    const statusIdx = args.indexOf('--status');
    const workerIdx = args.indexOf('--worker');
    const plansIdx = args.indexOf('--plans');
    const lastUpdateIdx = args.indexOf('--last-update');
    const nameIdx = args.indexOf('--name');
    cmdStateUpdatePhaseRow(cwd, phase, {
      status: statusIdx !== -1 ? args[statusIdx + 1] : null,
      worker: workerIdx !== -1 ? args[workerIdx + 1] : null,
      plans: plansIdx !== -1 ? args[plansIdx + 1] : null,
      last_update: lastUpdateIdx !== -1 ? args[lastUpdateIdx + 1] : null,
      name: nameIdx !== -1 ? args[nameIdx + 1] : null,
    }, raw);
  ```

  Ensure these are added in the `else if` chain BEFORE the final `else` that calls `cmdStateLoad(cwd, raw)`.
  </action>
  <verify>
  Run: `node bin/mow-tools.cjs state active-phases --raw` (on the current project, which has a STATE.md -- it should return empty array if no Active Phases section exists yet, with a warning).
  Verify the updated template exists: `grep "Active Phases" mowism/templates/state.md`.
  </verify>
  <done>
  - STATE.md template includes Active Phases table section with documentation
  - `state active-phases` parses the table and returns JSON array
  - `state update-phase-row` updates a single row by phase number or inserts a new row
  - Table parsing uses established `|`-split-and-trim patterns from existing worktree/teammate parsers
  - "Next unblockable" metadata line is maintained automatically
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for Active Phases table operations</name>
  <files>
    bin/mow-tools.test.cjs
  </files>
  <action>
  Add a test group for Active Phases operations in `bin/mow-tools.test.cjs`.

  **Tests to add (7 tests):**

  1. **`state active-phases` returns empty array when no section exists** -- Create a STATE.md without Active Phases section (use the v1.0 format). Run `state active-phases --raw`. Assert: JSON output is an empty array.

  2. **`state active-phases` parses table correctly** -- Create a STATE.md with an Active Phases table containing 3 rows (one executing, one blocked, one not started). Run `state active-phases --raw`. Parse JSON. Assert: 3 rows with correct field values.

  3. **`state update-phase-row` updates existing row** -- Create STATE.md with a table containing phase 7. Run `state update-phase-row 7 --status executing --worker worker-green --plans 1/4 --raw`. Read STATE.md. Assert: phase 7 row shows `executing`, `worker-green`, `1/4`. Other rows unchanged.

  4. **`state update-phase-row` inserts new row when phase not found** -- Create STATE.md with an empty Active Phases table. Run `state update-phase-row 7 --name "State Coherence" --status "not started" --raw`. Read STATE.md. Assert: table now has one row with phase 7.

  5. **`state update-phase-row` preserves unspecified fields** -- Create STATE.md with phase 7 having worker `worker-green` and plans `1/4`. Run `state update-phase-row 7 --plans 2/4 --raw`. Assert: worker still `worker-green`, plans now `2/4`.

  6. **`state update-phase-row` updates Next unblockable** -- Create STATE.md with phases 7 (executing), 8 (executing), 9 (blocked (7,8)). Run `state update-phase-row 7 --status complete --raw`. Assert: "Next unblockable" is recalculated correctly.

  7. **Active Phases table survives round-trip** -- Create STATE.md with 5 rows (matching v1.1 phases 7-11). Parse with `active-phases`. Update one row. Re-parse. Assert: all 5 rows present, only the updated row changed, no data corruption.
  </action>
  <verify>
  Run the full test suite: `node bin/mow-tools.test.cjs`. All existing tests plus 7 new Active Phases tests must pass.
  </verify>
  <done>
  - 7 tests covering active-phases parsing, update-phase-row insert/update, field preservation, and round-trip integrity
  - All tests pass (zero failures)
  - Existing tests unaffected (regression-safe)
  </done>
</task>

</tasks>

<verification>
1. `mowism/templates/state.md` contains `## Active Phases` section with table format documentation
2. `node bin/mow-tools.cjs state active-phases --raw` returns valid JSON (empty array on current STATE.md that lacks the section)
3. `node bin/mow-tools.test.cjs` passes all tests including the new Active Phases group
4. The table format uses standard `|`-delimited markdown compatible with existing parsers
5. STATE.md template stays under 100 lines for the File Template portion
</verification>

<success_criteria>
- STATE.md template includes Active Phases table for multi-agent coordinator dashboard
- `state active-phases` parses the table and returns structured JSON
- `state update-phase-row` updates a single row atomically (only the coordinator should call this)
- "Next unblockable" metadata line is auto-maintained
- Phase status values: not started / executing / complete / blocked (N,M) / failed
- Template documentation explains the coordinator-owned semantics
</success_criteria>

<output>
After completion, create `.planning/phases/07-state-coherence-foundation/07-03-SUMMARY.md`
</output>
