---
phase: 16-auto-advance-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/mow-tools.cjs
  - commands/mow/auto.md
  - mowism/workflows/auto.md
autonomous: true
requirements:
  - AUTO-01
  - AUTO-02
  - AUTO-03
  - AUTO-04
  - AUTO-05
  - AUTO-06

must_haves:
  truths:
    - "Running /mow:auto sets workflow.auto_advance to true in config.json and starts from the first incomplete phase"
    - "Re-running /mow:auto after partial completion detects completed phases and offers to continue from the next ready phase"
    - "The auto-advance orchestrator delegates to the team lead multi_phase_flow for DAG-driven execution with discuss pause gates"
    - "At milestone boundary the orchestrator clears workflow.auto_advance and shows a summary report"
    - "AUTO-06 (optional phase range) is documented as deferred per locked discuss-phase decision"
  artifacts:
    - path: "commands/mow/auto.md"
      provides: "/mow:auto slash command entry point"
      contains: "mow:auto"
    - path: "mowism/workflows/auto.md"
      provides: "Auto-advance orchestration workflow with resume detection, context window awareness, milestone boundary handling"
      contains: "auto_advance"
    - path: "bin/mow-tools.cjs"
      provides: "cmdInitAuto function for DAG state detection, milestone boundary identification, and resume support"
      contains: "cmdInitAuto"
  key_links:
    - from: "commands/mow/auto.md"
      to: "mowism/workflows/auto.md"
      via: "@-reference in execution_context"
      pattern: "workflows/auto.md"
    - from: "mowism/workflows/auto.md"
      to: "bin/mow-tools.cjs"
      via: "mow-tools.cjs init auto CLI call"
      pattern: "init auto"
    - from: "mowism/workflows/auto.md"
      to: "agents/mow-team-lead.md"
      via: "delegation to multi_phase_flow"
      pattern: "multi_phase_flow"
---

<objective>
Create the `/mow:auto` command, the auto-advance orchestration workflow, and the `cmdInitAuto` tooling function that wire together the existing per-workflow auto-advance flags, DAG analysis, and team lead orchestration into a single entry point for full-milestone pipeline execution.

Purpose: This is the primary Phase 16 deliverable -- one command that drives an entire milestone from the current phase to completion, delegating to team lead for DAG-driven worker orchestration while handling resume detection, context window awareness, and milestone boundary cleanup.

Output: `commands/mow/auto.md` (command file), `mowism/workflows/auto.md` (orchestration workflow), updated `bin/mow-tools.cjs` (cmdInitAuto function + CLI routing).
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-auto-advance-pipeline/16-CONTEXT.md
@.planning/phases/16-auto-advance-pipeline/16-RESEARCH.md
@agents/mow-team-lead.md
@agents/mow-phase-worker.md
@mowism/workflows/transition.md
@mowism/workflows/execute-phase.md
@commands/mow/execute-phase.md
@commands/mow/discuss-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cmdInitAuto function and CLI routing in mow-tools.cjs</name>
  <files>bin/mow-tools.cjs</files>
  <action>
Add a new `cmdInitAuto` function (~40-60 LOC) to mow-tools.cjs, following the existing cmdInit* pattern (e.g., cmdInitExecutePhase, cmdInitPhaseOp). Place it in the DAG Analysis section (near line ~4200, after cmdRoadmapAnalyzeDag) or in the init section with other init commands.

**cmdInitAuto(cwd, raw) should:**

1. Verify `.planning/` directory exists. If not, error: "No .planning/ directory. Run /mow:new-project first."
2. Load config via loadConfig(cwd) and read `workflow.auto_advance` current state (from config-get or direct config read).
3. Call the existing `cmdRoadmapAnalyzeDag` internal logic (reuse the DAG computation -- either extract the DAG computation into an internal helper `analyzeDagInternal(cwd)` that returns the result object, or call `cmdRoadmapAnalyzeDag` with raw=true and capture its output). The result gives `phases`, `waves`, `ready`, `blocked`, `completed`.
4. Determine milestone boundaries by scanning ROADMAP.md for the current milestone section (the one containing incomplete phases). Extract all phase numbers in the current milestone.
5. Check Agent Teams availability via `checkAgentTeams()`.
6. Return JSON:
   ```json
   {
     "planning_exists": true,
     "auto_advance_active": true/false,
     "dag": { "phases": [...], "waves": [...], "ready": [...], "blocked": [...], "completed": [...] },
     "milestone_phases": ["13", "14", "15", "16"],
     "completed_count": 3,
     "remaining_count": 1,
     "total_phase_count": 4,
     "first_ready_phase": "16",
     "agent_teams_enabled": true/false,
     "commit_docs": true/false
   }
   ```

**Also add CLI routing** in the main argument dispatcher (the switch/if-else chain at the bottom of the file). Add a case for `init auto` that calls `cmdInitAuto(cwd, raw)`. Follow the existing pattern for other init subcommands (e.g., `init execute-phase`, `init plan-phase`, `init phase-op`).

**Implementation notes:**
- For DAG internal reuse: create a small helper `function analyzeDagInternal(cwd)` that contains the core logic from `cmdRoadmapAnalyzeDag` (lines ~4035-4164) and returns the result object. Then have `cmdRoadmapAnalyzeDag` call it and handle output. This avoids duplicating the DAG logic.
- For milestone phase extraction: parse ROADMAP.md looking for the "In Progress" milestone section header, then extract all phase numbers from `### Phase N:` headings within that section. The current milestone is `v1.2` with phases 13-16.
- Use the existing `normalizePhaseName`, `findPhaseInternal`, `parseDependsOn`, and `topoGenerations` helpers.
  </action>
  <verify>
Run: `node bin/mow-tools.cjs init auto --raw 2>&1 | head -30` -- should return valid JSON with dag, milestone_phases, completed_count, remaining_count, first_ready_phase fields. Verify `first_ready_phase` is "16" (since 13-15 are complete). Verify `completed_count` is 3 and `remaining_count` is 1.

Also verify: `node bin/mow-tools.cjs init auto 2>&1` (non-raw) prints a human-readable summary.
  </verify>
  <done>
cmdInitAuto returns correct DAG state with completed/ready/blocked phases, milestone boundary info, and Agent Teams status. CLI routing responds to `init auto` subcommand. Existing `cmdRoadmapAnalyzeDag` still works correctly (no regression from internal refactor).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /mow:auto command file and auto-advance orchestration workflow</name>
  <files>commands/mow/auto.md, mowism/workflows/auto.md</files>
  <action>
**Create `commands/mow/auto.md`** following the existing command file pattern (e.g., `commands/mow/execute-phase.md`, `commands/mow/discuss-phase.md`). The command file is a thin entry point that references the workflow.

YAML frontmatter:
```yaml
---
name: mow:auto
description: Start full auto-advance pipeline from current phase through milestone end
argument-hint: ""
allowed-tools:
  - Read
  - Write
  - Edit
  - Bash
  - Glob
  - Grep
  - Task
  - SendMessage
  - TaskCreate
  - TaskUpdate
  - TaskList
  - TaskGet
  - TeamCreate
  - TeamDelete
  - AskUserQuestion
---
```

Body: Include `??? Help Detection` block (same as other commands). Then objective, execution_context referencing `@~/.claude/mowism/workflows/auto.md`, context referencing STATE.md and ROADMAP.md, and process directing to follow the workflow end-to-end. No arguments per locked decision.

**Create `mowism/workflows/auto.md`** as the orchestration workflow. This is the main deliverable. Structure:

```
<purpose>
Drive the entire milestone from first incomplete phase to completion. Sets workflow.auto_advance, delegates to team lead for DAG-driven multi-phase orchestration, handles resume on re-run, milestone boundary cleanup, and context window awareness.
</purpose>

<process>

<step name="initialize">
1. Run `node ~/.claude/mowism/bin/mow-tools.cjs init auto --raw` and parse the JSON.
2. Extract: auto_advance_active, dag, milestone_phases, completed_count, remaining_count, first_ready_phase, agent_teams_enabled.
3. If remaining_count is 0: "Milestone complete! All phases done. Run /mow:complete-milestone." Exit.
</step>

<step name="resume_detection">
Per locked decision: "On re-run, detect completed phases and show what's done/next, then confirm before proceeding."

If completed_count > 0:
  Show: "Phases already complete: {completed list with names}"
  Show: "Next: Phase {first_ready_phase} — {name}"
  If auto_advance_active is true:
    Show: "Auto-advance was previously active (possibly from interrupted session)."
  Ask: "Continue from Phase {first_ready_phase}? (y/n)"
  If no: "Auto-advance cancelled. Flag left unchanged." Exit.

If completed_count is 0:
  Show: "Starting auto-advance from Phase {first_ready_phase} through milestone end."
  Show: "{remaining_count} phases remaining. DAG order: {wave summary}"
  Show: "Discuss gates will pause for your input at each phase."
  If any phases have existing CONTEXT.md, note: "Phases with existing context will skip discuss."
</step>

<step name="set_auto_advance">
```bash
node ~/.claude/mowism/bin/mow-tools.cjs config-set workflow.auto_advance true
```
</step>

<step name="check_agent_teams">
If agent_teams_enabled is true:
  Proceed to team_lead_delegation (multi-phase DAG-parallel mode).

If agent_teams_enabled is false:
  Proceed to sequential_fallback (single-session sequential mode using existing --auto chain).
</step>

<step name="team_lead_delegation">
Per research: "The team lead already has battle-tested DAG orchestration." Delegate ALL remaining phases.

Read and follow `agents/mow-team-lead.md` multi_phase_flow with ALL remaining phases from the DAG ready/blocked list.

The team lead handles:
- DAG analysis and phase selection (auto-select ALL remaining phases)
- Worktree creation for ready phases
- Worker spawning (each worker runs full lifecycle from Phase 15)
- Phase completion, merging, downstream unblocking
- Worker discuss gates (workers send input_needed, user interacts in worker terminal)

Key differences from manual team lead invocation:
- Skip the "present phase selection to user" step -- auto-advance runs ALL remaining phases
- Skip user confirmation for phase selection -- already confirmed in resume_detection
- The team lead still presents DAG structure for visibility

After each phase_complete event, the team lead:
1. Merges the phase branch
2. Checks if this was the last phase in the milestone (is_last_phase from cmdPhaseComplete)
3. If last phase: proceed to milestone_boundary step
4. If not last: unblock downstream phases, spawn workers (standard multi_phase_flow behavior)
</step>

<step name="sequential_fallback">
If Agent Teams not enabled, use single-session sequential auto-advance:

For each incomplete phase in DAG order:
1. Check if CONTEXT.md exists for this phase
2. If no CONTEXT.md: follow discuss-phase.md --auto (which STILL pauses for user input per hard constraint)
3. Follow plan-phase.md --auto (chains to execute)
4. Follow execute-phase.md --auto (chains to transition)
5. Follow transition.md --auto (chains to next phase)

This is the EXISTING auto-advance chain. /mow:auto just sets the flag and starts the chain from the first incomplete phase.

After each phase completes: check if this was the last phase. If so, proceed to milestone_boundary.
</step>

<step name="context_window_awareness">
Per locked decision: "When the orchestrator's context gets low, save progress to STATE.md and instruct the user to /clear and re-run /mow:auto."

After each phase completion event, assess context health:
- Phase count heuristic: if 4+ phases have completed in this session, warn proactively
- If context feels constrained (losing track of earlier phases): save immediately

When saving:
1. Ensure STATE.md reflects latest completed phase (cmdPhaseComplete already handles this)
2. Print:
   ```
   ---
   CONTEXT WINDOW LOW — Save Point

   Progress saved to STATE.md. Completed phases: {list}

   Please run: /clear
   Then re-run: /mow:auto

   The pipeline will detect completed phases and resume from Phase {next}.
   ---
   ```
3. Clear auto_advance flag is NOT needed here -- it stays true for resume
</step>

<step name="verification_failure">
Per locked decision: "When a phase fails verification: pause the pipeline and alert the user with what failed."

If a phase worker reports verification failure (gaps_found):
1. Show which phase failed and the gap summary
2. Show: "Pipeline paused. Phase {N} needs gap closure."
3. Show: "Options:"
   - Fix gaps: `/mow:plan-phase {N} --gaps` then `/mow:execute-phase {N} --gaps-only`
   - Skip verification: Mark phase complete manually
   - Abort pipeline: "Run /mow:auto again after fixing"
4. Do NOT auto-retry per locked decision
</step>

<step name="milestone_boundary">
Per locked decision: "Auto-advance stops at milestone boundary, clears workflow.auto_advance config, and shows summary report."

1. Clear auto-advance flag:
   ```bash
   node ~/.claude/mowism/bin/mow-tools.cjs config-set workflow.auto_advance false
   ```

2. Show milestone summary report:
   ```
   ---
   AUTO-ADVANCE PIPELINE COMPLETE

   Milestone: {milestone_name}

   Phases completed: {count} ({phase list})
   Total plans executed: {sum of plan counts across phases}

   Phase Summary:
     Phase {N}: {name}  -- {plan_count} plans
     Phase {N}: {name}  -- {plan_count} plans
     ...

   Auto-advance flag cleared.

   Next: /mow:complete-milestone {version}
   ---
   ```

3. Suggest `/mow:complete-milestone` for archival.
</step>

</process>

<stale_flag_detection>
If workflow.auto_advance is true but this is NOT a /mow:auto invocation (e.g., user ran /mow:execute-phase directly):
- Other workflows already read this flag and act on it
- The resume_detection step in /mow:auto handles re-entry
- Transition.md Route B already clears at milestone boundary

Per Pitfall 2 from research: the flag persists intentionally for resume. It's only stale if the user has moved to a different milestone without clearing it.
</stale_flag_detection>

<success_criteria>
- /mow:auto sets workflow.auto_advance and starts pipeline from first incomplete phase
- Re-run detects completed phases and resumes correctly
- Delegates to team lead for DAG-driven execution (or sequential fallback)
- Milestone boundary clears flag and shows summary
- Context window awareness saves state proactively
- Verification failure pauses pipeline without auto-retry
</success_criteria>
```

**AUTO-06 handling:** Add a comment in the command file and workflow noting: "AUTO-06 (optional phase range arguments) deferred per locked discuss-phase decision: '/mow:auto takes no arguments -- always starts from first incomplete phase.' Phase range support can be added as optional arguments in a future iteration without breaking the no-argument default."
  </action>
  <verify>
1. Verify `commands/mow/auto.md` exists with valid YAML frontmatter (name, description, allowed-tools) and ??? help detection block.
2. Verify `mowism/workflows/auto.md` exists with all required steps: initialize, resume_detection, set_auto_advance, check_agent_teams, team_lead_delegation, sequential_fallback, context_window_awareness, verification_failure, milestone_boundary.
3. Verify AUTO-06 deferred note appears in both files.
4. Grep for "auto_advance" in the workflow to confirm it sets and clears the flag.
5. Grep for "multi_phase_flow" to confirm team lead delegation.
  </verify>
  <done>
/mow:auto command file exists with proper frontmatter and ??? detection. Auto-advance workflow contains all 8 orchestration steps covering: init, resume, flag set, Agent Teams check, team lead delegation, sequential fallback, context window management, verification failure handling, and milestone boundary cleanup. AUTO-06 is documented as deferred.
  </done>
</task>

</tasks>

<verification>
1. `node bin/mow-tools.cjs init auto --raw` returns valid JSON with all expected fields
2. `commands/mow/auto.md` has valid YAML frontmatter matching the pattern of other commands
3. `mowism/workflows/auto.md` references all key components: mow-tools.cjs, team lead, transition, config-set
4. AUTO-06 deferred notice present in both command and workflow files
5. No regressions: `node bin/mow-tools.cjs roadmap analyze-dag --raw` still works after internal refactor
</verification>

<success_criteria>
- cmdInitAuto returns correct DAG state detection for resume support
- /mow:auto command file follows established command file pattern
- Auto-advance workflow covers all locked decisions from CONTEXT.md
- Team lead delegation for multi-phase mode, sequential fallback for non-AT mode
- Milestone boundary clears auto_advance flag and shows summary
- AUTO-06 documented as deferred, not implemented
</success_criteria>

<output>
After completion, create `.planning/phases/16-auto-advance-pipeline/16-01-SUMMARY.md`
</output>
