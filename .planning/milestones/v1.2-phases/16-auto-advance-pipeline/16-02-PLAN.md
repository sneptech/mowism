---
phase: 16-auto-advance-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/mow-tools.cjs
autonomous: true
requirements:
  - AUTO-07

must_haves:
  truths:
    - "When workflow.auto_advance is true, the dashboard render prepends a milestone-wide progress banner showing current phase and percentage"
    - "When workflow.auto_advance is false (or unset), no auto-advance banner appears in dashboard output"
    - "The milestone banner shows completed phase count, total phase count, and a completion percentage"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "Extended cmdDashboardRender with auto-advance milestone banner"
      contains: "auto_advance"
  key_links:
    - from: "bin/mow-tools.cjs"
      to: ".planning/config.json"
      via: "config-get workflow.auto_advance check in dashboard render"
      pattern: "auto_advance"
    - from: "bin/mow-tools.cjs"
      to: "cmdRoadmapAnalyzeDag"
      via: "DAG analysis for milestone-wide completion stats"
      pattern: "analyzeDag"
---

<objective>
Extend the dashboard renderer (`cmdDashboardRender` in mow-tools.cjs) to show a milestone-wide auto-advance progress banner when `workflow.auto_advance` is true. The banner shows which phase is currently active, how many phases are complete vs total, and a milestone completion percentage.

Purpose: During auto-advance pipeline execution, the user needs a quick glance at overall milestone progress, not just per-phase detail. This banner provides that top-level context.

Output: Updated `cmdDashboardRender` in `bin/mow-tools.cjs` with auto-advance banner rendering.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-auto-advance-pipeline/16-CONTEXT.md
@.planning/phases/16-auto-advance-pipeline/16-RESEARCH.md
@bin/mow-tools.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-advance milestone banner to cmdDashboardRender</name>
  <files>bin/mow-tools.cjs</files>
  <action>
Extend `cmdDashboardRender` (currently at line ~557 in mow-tools.cjs) to prepend a milestone-wide auto-advance progress banner when `workflow.auto_advance` is true in config.

**Banner format** (per research and CONTEXT.md locked decision):
```
AUTO-ADVANCE  Phase 15/16  Milestone: 93%  3/4 done
```

Where:
- `Phase 15/16` = current active phase number / total milestone phases
- `Milestone: 93%` = completed phases / total phases as percentage
- `3/4 done` = completed count / total count

**Implementation steps:**

1. **Check auto_advance config** early in cmdDashboardRender, after reading the config but before rendering phase rows. Use the same config loading pattern already used for `event_log_count` and `terminal_bell`:
   ```javascript
   let autoAdvance = false;
   try {
     const configPath = path.join(cwd, '.planning', 'config.json');
     if (fs.existsSync(configPath)) {
       const config = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
       if (config.workflow && config.workflow.auto_advance) {
         autoAdvance = true;
       }
     }
   } catch { /* not auto-advancing */ }
   ```

2. **If autoAdvance is true, compute milestone stats** using the DAG analysis helper (from Plan 16-01's `analyzeDagInternal`, or fallback to direct inline computation). Read ROADMAP.md to count current milestone phases and their completion status:
   ```javascript
   if (autoAdvance) {
     // Use analyzeDagInternal if available, otherwise inline
     const dagResult = analyzeDagInternal(cwd);
     // OR: reuse the phase counting logic from cmdRoadmapAnalyzeDag
     const totalPhases = dagResult.phases.length;
     const completedPhases = dagResult.completed.length;
     const milestonePercent = totalPhases > 0 ? Math.round((completedPhases / totalPhases) * 100) : 0;
     // Find the first "executing" or "ready" phase
     const currentPhase = dagResult.ready[0] || (dagResult.phases.find(p => p.disk_status !== 'complete') || {}).number || '?';
   }
   ```

   **Important:** If Plan 16-01 creates `analyzeDagInternal`, use it. If not (plans execute in parallel and this may run first), implement inline: read ROADMAP.md, count phase headings in the current milestone section, count those with `(completed ...)` in their checkbox line. This is simpler and avoids depending on the refactor in Plan 01.

   Inline approach:
   ```javascript
   // Count phases in current milestone
   const roadmapPath = path.join(cwd, '.planning', 'ROADMAP.md');
   const roadmapContent = safeReadFile(roadmapPath) || '';
   // Find "In Progress" milestone section
   const inProgressMatch = roadmapContent.match(/###\s+v[\d.]+[^\n]*\(In Progress\)/i);
   // ... extract phase lines, count completed vs total
   ```

3. **Render the banner** as the first line(s) before phase rows. Use bold/inverse styling if available, or plain text:
   ```javascript
   if (autoAdvance) {
     const bannerText = `AUTO-ADVANCE  Phase ${currentPhase}/${totalPhases}  Milestone: ${milestonePercent}%  ${completedPhases}/${totalPhases} done`;
     // Pad to width, use inverse/bold if color supported
     let bannerLine;
     if (supportsColor()) {
       // Use 256-color blue background (27) with white text (231) for auto-advance banner
       bannerLine = color256(27, 231, bannerText.padEnd(width));
     } else {
       bannerLine = bannerText;
     }
     lines.unshift(bannerLine);
     lines.splice(1, 0, '\u2500'.repeat(width)); // separator after banner
   }
   ```

4. **Update the raw JSON output** to include auto-advance stats when the banner is rendered:
   ```javascript
   // In the raw output object, add:
   if (autoAdvance) {
     resultObj.auto_advance = {
       active: true,
       current_phase: currentPhase,
       total_phases: totalPhases,
       completed_phases: completedPhases,
       milestone_percent: milestonePercent,
     };
   }
   ```

5. **Handle the "no active phases" case**: If auto_advance is true but there are no active phase rows yet (pipeline just started), still show the banner above "No active phases".

**File ownership note:** This plan modifies a DIFFERENT section of mow-tools.cjs than Plan 16-01. Plan 01 adds cmdInitAuto near the DAG section (~line 4200) and CLI routing at the bottom. Plan 02 modifies cmdDashboardRender (~line 557). No file conflict.

**Testing note:** To test the banner without running the full pipeline, temporarily set auto_advance in config.json:
```bash
node bin/mow-tools.cjs config-set workflow.auto_advance true
node bin/mow-tools.cjs dashboard render
node bin/mow-tools.cjs config-set workflow.auto_advance false
```
  </action>
  <verify>
1. Temporarily enable: `node bin/mow-tools.cjs config-set workflow.auto_advance true`
2. Run: `node bin/mow-tools.cjs dashboard render` -- should show "AUTO-ADVANCE" banner line at the top with phase count and percentage
3. Run: `node bin/mow-tools.cjs dashboard render --raw` -- JSON should include `auto_advance` object with current_phase, total_phases, completed_phases, milestone_percent
4. Disable: `node bin/mow-tools.cjs config-set workflow.auto_advance false`
5. Run: `node bin/mow-tools.cjs dashboard render` -- no AUTO-ADVANCE banner should appear
6. Verify existing dashboard rendering still works correctly (phase rows, events, pinned notifications unchanged)
  </verify>
  <done>
Dashboard renders a milestone-wide "AUTO-ADVANCE" progress banner when `workflow.auto_advance` is true, showing current phase, total phases, completion percentage, and completed count. Banner does not appear when auto_advance is false. Raw JSON output includes auto_advance stats. No regression in existing dashboard functionality.
  </done>
</task>

</tasks>

<verification>
1. Dashboard banner appears only when workflow.auto_advance is true in config
2. Banner shows correct phase count and percentage based on ROADMAP.md phase completion state
3. Banner uses styled output (color) when terminal supports it, plain text fallback otherwise
4. Raw JSON output includes auto_advance stats object when banner is active
5. Existing dashboard rendering (phase rows, events, pinned notifications) unchanged
6. Banner renders correctly even with no active phase rows (pipeline just started)
</verification>

<success_criteria>
- Auto-advance banner prepended to dashboard output when flag is active
- Banner shows current active phase, total milestone phases, and completion percentage
- No banner when auto_advance is false (default state)
- Raw JSON includes auto_advance stats for programmatic consumers
- No regression in existing dashboard rendering
</success_criteria>

<output>
After completion, create `.planning/phases/16-auto-advance-pipeline/16-02-SUMMARY.md`
</output>
