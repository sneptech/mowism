---
phase: 13-gsd-bugfix-ports
plan: 04
type: execute
wave: 3
depends_on: [13-02]
files_modified:
  - bin/mow-tools.cjs
  - ~/.claude/mowism/workflows/check-todos.md
autonomous: true
requirements:
  - BUG-09

must_haves:
  truths:
    - "Todo system supports three states: pending/, in-progress/, and completed/ with file movement between them"
    - "Running 'todo start <filename>' moves a todo from pending/ to in-progress/ and warns if files overlap with existing in-progress todos"
    - "Running 'todo complete <filename>' works for todos in both pending/ and in-progress/ directories"
    - "/mow:check-todos shows in-progress items first in a 'Currently working on' section, then pending items below"
    - "In-progress todos persist across sessions -- they do NOT auto-revert to pending"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "cmdTodoStart function, updated cmdTodoComplete, updated cmdListTodos, updated cmdInitTodos"
      contains: "cmdTodoStart"
    - path: "~/.claude/mowism/workflows/check-todos.md"
      provides: "Updated display with in-progress section, todo start action"
      contains: "Currently working on"
  key_links:
    - from: "cmdTodoStart"
      to: "in-progress directory"
      via: "fs.renameSync"
      pattern: "in-progress"
    - from: "cmdTodoComplete"
      to: "in-progress directory check"
      via: "fallback source path"
      pattern: "in-progress.*pending|pending.*in-progress"
---

<objective>
Add in-progress state to the todo lifecycle (BUG-09): new in-progress/ directory, todo start subcommand, updated completion flow that checks both source directories, and updated check-todos display.

Purpose: Enable tracking of currently-active todos for worktree parallelism awareness, with interference detection to prevent concurrent work on overlapping files.
Output: Updated mow-tools.cjs with 3-state todo lifecycle and updated check-todos.md workflow.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bin/mow-tools.cjs
@~/.claude/mowism/workflows/check-todos.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add todo start subcommand and update todo complete, list, and init functions (BUG-09)</name>
  <files>bin/mow-tools.cjs</files>
  <action>
**1. Add `cmdTodoStart` function** (near `cmdTodoComplete`, ~line 5563):

```javascript
function cmdTodoStart(cwd, filename, raw) {
  if (!filename) { error('filename required for todo start'); }
  const pendingDir = path.join(cwd, '.planning', 'todos', 'pending');
  const inProgressDir = path.join(cwd, '.planning', 'todos', 'in-progress');
  const sourcePath = path.join(pendingDir, filename);
  if (!fs.existsSync(sourcePath)) {
    error(`Todo not found in pending: ${filename}`);
  }
  fs.mkdirSync(inProgressDir, { recursive: true });

  // Check for interference with existing in-progress todos
  const warnings = [];
  try {
    const inProgressFiles = fs.readdirSync(inProgressDir).filter(f => f.endsWith('.md'));
    const newContent = fs.readFileSync(sourcePath, 'utf-8');
    const newFilesMatch = newContent.match(/^files:\s*(.+)$/m);
    const newFiles = newFilesMatch
      ? newFilesMatch[1].split(',').map(s => s.trim()).filter(Boolean)
      : [];
    if (newFiles.length > 0) {
      for (const ipFile of inProgressFiles) {
        const ipContent = fs.readFileSync(path.join(inProgressDir, ipFile), 'utf-8');
        const ipFilesMatch = ipContent.match(/^files:\s*(.+)$/m);
        const ipFiles = ipFilesMatch
          ? ipFilesMatch[1].split(',').map(s => s.trim()).filter(Boolean)
          : [];
        const overlap = newFiles.filter(f => ipFiles.includes(f));
        if (overlap.length > 0) {
          const titleMatch = ipContent.match(/^title:\s*(.+)$/m);
          warnings.push({
            todo: titleMatch ? titleMatch[1].trim() : ipFile,
            overlapping_files: overlap,
          });
        }
      }
    }
  } catch {}

  // Add started timestamp
  let content = fs.readFileSync(sourcePath, 'utf-8');
  const today = new Date().toISOString().split('T')[0];
  content = `started: ${today}\n` + content;

  fs.writeFileSync(path.join(inProgressDir, filename), content, 'utf-8');
  fs.unlinkSync(sourcePath);
  output({
    started: true,
    file: filename,
    from: 'pending',
    to: 'in-progress',
    warnings: warnings.length > 0 ? warnings : undefined,
  }, raw);
}
```

**2. Update `cmdTodoComplete`** (~line 5563): Modify to check BOTH `pending/` and `in-progress/` as source directories:

- First check `pending/` for the file
- If not found, check `in-progress/`
- If found in neither, error with `Todo not found in pending or in-progress: ${filename}`
- When completing from `in-progress/`, the rest of the logic stays the same (add completion timestamp, move to `completed/`)
- Include `from` field in output to indicate where the file came from

**3. Update `cmdListTodos`** (~line 1266): Scan both `pending/` and `in-progress/` directories:

- Read `in-progress/` files first, add them to the todos array with `state: 'in-progress'`
- Then read `pending/` files, add with `state: 'pending'`
- Update the output to include `in_progress_count` alongside `count` (total)
- Each todo object should include a `state` field

**4. Update `cmdInitTodos`** (~line 6287): Same as cmdListTodos -- scan both directories, include state field and in_progress_count.

**5. Register the command** in the command dispatcher (the main switch/if-else block at the bottom of mow-tools.cjs):

Add `todo start` alongside existing `todo complete`:
```javascript
case 'start':
  cmdTodoStart(cwd, args[2], raw);
  break;
```

**Per user decision:** No limit on concurrent in-progress todos. In-progress todos persist across sessions (no auto-revert logic). Interference detection is file-path overlap only.
  </action>
  <verify>
1. Run `node bin/mow-tools.cjs todo start some-file.md` -- should error gracefully if file doesn't exist
2. Create a test pending todo, run `todo start` on it, verify it moves to in-progress/
3. Run `node bin/mow-tools.cjs todo complete` on an in-progress todo, verify it completes correctly
4. Run `node bin/mow-tools.cjs list-todos` -- verify in-progress and pending todos are both listed with state field
5. Run existing tests: `node bin/mow-tools.test.cjs` -- all tests pass
  </verify>
  <done>Todo start subcommand exists, moves pending→in-progress with interference detection. Todo complete checks both pending and in-progress. List-todos and init-todos scan both directories.</done>
</task>

<task type="auto">
  <name>Task 2: Update check-todos workflow to show in-progress section (BUG-09)</name>
  <files>~/.claude/mowism/workflows/check-todos.md</files>
  <action>
Update `~/.claude/mowism/workflows/check-todos.md` to reflect the 3-state todo lifecycle:

**1. Update `list_todos` step** to show in-progress items first:

Replace the current display format with:

```
{If in-progress todos exist:}
Currently working on:

1. ⚡ Add auth token refresh (api, started 2d ago)
2. ⚡ Fix modal z-index issue (ui, started 1d ago)

{Always show:}
Pending:

3. Add database connection pool refactor (database, 5h ago)
4. Update API error handling (api, 2d ago)

---

Reply with a number to view details, or:
- `/mow:check-todos [area]` to filter by area
- `q` to exit
```

The numbering is continuous across both sections. In-progress items use ⚡ prefix for visual distinction.

**2. Update `offer_actions` step** to include "Start working" option:

For pending todos, add a new option:
- "Start working" — Mark as in-progress (run `todo start`) and begin work

For in-progress todos, adjust the options:
- "Continue working" — Resume work on this in-progress todo
- "Complete" — Mark as done (run `todo complete`)
- "Put it back" — Move back to pending (reverse of start)

**3. Update `execute_action` step** to handle the new actions:

- **Start working:** Run `node mow-tools.cjs todo start [filename]`, check for interference warnings in output, display them if present, then proceed to work
- **Continue working:** Load todo context and begin work (no file move needed)
- **Complete:** Run `node mow-tools.cjs todo complete [filename]`
- **Put it back (from in-progress):** Move file from `in-progress/` back to `pending/`, remove `started:` timestamp line

**4. Update `git_commit` step** to handle the new file paths:

- Commits should reference `in-progress/` or `pending/` as appropriate
- Update commit message templates: "docs: start todo - [title]", "docs: complete todo - [title]"

**Per user decision:** In-progress todos persist across sessions. No auto-revert. The check-todos display shows in-progress first in its own section.
  </action>
  <verify>
1. Read check-todos.md and confirm "Currently working on" section format exists
2. Verify "Start working" option exists for pending todos
3. Verify "Continue working" and "Complete" options exist for in-progress todos
4. Verify git commit step handles in-progress file paths
  </verify>
  <done>check-todos workflow displays in-progress items first, offers start/continue/complete actions, and handles 3-state todo lifecycle.</done>
</task>

</tasks>

<verification>
1. Run `node bin/mow-tools.test.cjs` -- all existing tests pass
2. `todo start` command is registered and functional
3. `todo complete` works from both pending/ and in-progress/
4. `list-todos` includes state field and in_progress_count
5. check-todos.md has updated display and action options
</verification>

<success_criteria>
- `cmdTodoStart` function exists with interference detection
- `cmdTodoComplete` checks both pending/ and in-progress/ as source
- `cmdListTodos` and `cmdInitTodos` scan both directories with state field
- `todo start` registered in command dispatcher
- check-todos.md shows "Currently working on" section for in-progress todos
- Pending and in-progress todos have appropriate action options
- No auto-revert logic exists for in-progress todos
</success_criteria>

<output>
After completion, create `.planning/phases/13-gsd-bugfix-ports/13-04-SUMMARY.md`
</output>
