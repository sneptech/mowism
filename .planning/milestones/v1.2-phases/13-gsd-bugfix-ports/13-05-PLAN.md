---
phase: 13-gsd-bugfix-ports
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/settings.json
  - ~/.claude/hooks/mow-context-monitor.sh
  - ~/.claude/hooks/mow-inject-claude-md.sh
autonomous: true
requirements:
  - BUG-08
  - BUG-10

must_haves:
  truths:
    - "A Stop hook monitors context window usage and warns at 25% remaining, then commits work and writes handoff note at 15% remaining"
    - "The context monitor does not trigger for Task() subagents (top-level sessions only)"
    - "The context monitor does not create infinite Stop hook loops (checks stop_hook_active)"
    - "A SubagentStart hook injects project CLAUDE.md content as additionalContext into every spawned subagent"
  artifacts:
    - path: "~/.claude/hooks/mow-context-monitor.sh"
      provides: "Stop hook script for context window monitoring with 25%/15% thresholds"
      contains: "stop_hook_active"
    - path: "~/.claude/hooks/mow-inject-claude-md.sh"
      provides: "SubagentStart hook script for CLAUDE.md injection"
      contains: "additionalContext"
    - path: "~/.claude/settings.json"
      provides: "Hook registrations for Stop and SubagentStart events"
      contains: "mow-context-monitor"
  key_links:
    - from: "~/.claude/settings.json"
      to: "~/.claude/hooks/mow-context-monitor.sh"
      via: "Stop hook registration"
      pattern: "mow-context-monitor"
    - from: "~/.claude/settings.json"
      to: "~/.claude/hooks/mow-inject-claude-md.sh"
      via: "SubagentStart hook registration"
      pattern: "mow-inject-claude-md"
---

<objective>
Add context window monitoring via Stop hook (BUG-10) and CLAUDE.md injection via SubagentStart hook (BUG-08).

Purpose: Prevent context degradation in long sessions by warning and wrapping up before quality drops, and ensure all subagents have access to project-level CLAUDE.md context automatically.
Output: Two new hook scripts and updated settings.json with hook registrations.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@~/.claude/settings.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create context window monitor Stop hook (BUG-10)</name>
  <files>~/.claude/hooks/mow-context-monitor.sh, ~/.claude/settings.json</files>
  <action>
**Part A: Create the hook script at `~/.claude/hooks/mow-context-monitor.sh`**

```bash
#!/bin/bash
# Context window monitoring hook (Stop event)
# Warns at 25% remaining, wraps up at 15% remaining
# Per user decision: tighter thresholds than GSD (25%/15% vs 35%/25%)

INPUT=$(cat)

# Prevent infinite Stop hook loop
STOP_ACTIVE=$(echo "$INPUT" | jq -r '.stop_hook_active // false')
if [ "$STOP_ACTIVE" = "true" ]; then
  exit 0
fi

# Get transcript path from hook input
TRANSCRIPT=$(echo "$INPUT" | jq -r '.transcript_path // empty')
if [ -z "$TRANSCRIPT" ] || [ ! -f "$TRANSCRIPT" ]; then
  exit 0
fi

# Skip monitoring for subagents (their transcripts are in subdirectories)
# Top-level transcripts are directly in the session directory
if echo "$TRANSCRIPT" | grep -q '/subagents/'; then
  exit 0
fi

# Estimate context usage from transcript file size
# Heuristic: ~700KB of JSONL transcript â‰ˆ 100% of 200k context window
# This is approximate -- can be tuned via MAX_TRANSCRIPT_KB env var
MAX_SIZE=${MOW_MAX_TRANSCRIPT_KB:-700}
MAX_SIZE=$((MAX_SIZE * 1024))
FILE_SIZE=$(stat -c%s "$TRANSCRIPT" 2>/dev/null || stat -f%z "$TRANSCRIPT" 2>/dev/null || echo 0)
USED_PERCENT=$(( (FILE_SIZE * 100) / MAX_SIZE ))
REMAINING=$((100 - USED_PERCENT))

# Clamp to valid range
if [ "$REMAINING" -lt 0 ]; then REMAINING=0; fi
if [ "$REMAINING" -gt 100 ]; then REMAINING=100; fi

if [ "$REMAINING" -le 15 ]; then
  # Critical: commit staged work, write handoff note, tell user to /clear
  CWD=$(echo "$INPUT" | jq -r '.cwd // "."')

  # Attempt to commit any staged work
  cd "$CWD" 2>/dev/null && git add -A .planning/ 2>/dev/null && git commit -m "docs: context window handoff - auto-save before /clear" --no-verify 2>/dev/null || true

  # Write handoff note to STATE.md
  if [ -f "$CWD/.planning/STATE.md" ]; then
    DATE=$(date -u +"%Y-%m-%d")
    printf '\n### Context Window Handoff (%s)\nSession approaching context limit (~%d%% remaining). Work committed. Run /clear and resume.\n' "$DATE" "$REMAINING" >> "$CWD/.planning/STATE.md"
  fi

  # Output system message (do NOT block stopping -- let Claude stop gracefully)
  jq -n --arg remaining "$REMAINING" '{
    "systemMessage": ("CONTEXT WINDOW CRITICAL (~" + $remaining + "% remaining). Work has been committed. Handoff note written to STATE.md. Tell the user to /clear and resume."),
    "suppressOutput": false
  }'

elif [ "$REMAINING" -le 25 ]; then
  # Warning: print visible warning about remaining capacity
  jq -n --arg remaining "$REMAINING" '{
    "systemMessage": ("CONTEXT WINDOW WARNING: ~" + $remaining + "% remaining. Consider wrapping up the current task soon and running /clear to continue with fresh context."),
    "suppressOutput": false
  }'
fi

exit 0
```

Make the script executable: `chmod +x ~/.claude/hooks/mow-context-monitor.sh`

**Part B: Register the Stop hook in `~/.claude/settings.json`**

The existing Stop hook plays a chime sound. Add the context monitor as an additional hook in the SAME Stop array (both hooks run on every Stop event):

In the existing `"Stop"` array, add a second hook entry:
```json
{
  "type": "command",
  "command": "bash ~/.claude/hooks/mow-context-monitor.sh"
}
```

So the Stop array becomes:
```json
"Stop": [
  {
    "hooks": [
      {
        "type": "command",
        "command": "mpv --no-video --really-quiet /home/max/git/ai-agent-tools-and-tips/hooks/factorio-research-complete-chime.opus"
      },
      {
        "type": "command",
        "command": "bash ~/.claude/hooks/mow-context-monitor.sh"
      }
    ]
  }
]
```

**Key design decisions:**
- Uses Stop hook (not PostToolUse) per research: fires once per turn, not after every tool call
- Does NOT use `decision: "block"` at 15% -- commits work and lets Claude stop gracefully (prevents infinite loop per Pitfall 2)
- Checks `stop_hook_active` to prevent re-triggering
- Skips subagent transcripts (per user decision: top-level sessions only)
- Heuristic is configurable via `MOW_MAX_TRANSCRIPT_KB` env var (default 700)
  </action>
  <verify>
1. Verify `~/.claude/hooks/mow-context-monitor.sh` exists and is executable
2. Read `~/.claude/settings.json` and confirm Stop hooks array contains both the chime and the context monitor
3. Run `echo '{"stop_hook_active": true}' | bash ~/.claude/hooks/mow-context-monitor.sh` -- should exit silently (loop prevention)
4. Run `echo '{"transcript_path": "/nonexistent"}' | bash ~/.claude/hooks/mow-context-monitor.sh` -- should exit silently (no transcript)
  </verify>
  <done>Context monitor Stop hook is created, executable, registered in settings.json, and handles edge cases (stop_hook_active, missing transcript, subagent skip).</done>
</task>

<task type="auto">
  <name>Task 2: Create SubagentStart hook for CLAUDE.md injection (BUG-08)</name>
  <files>~/.claude/hooks/mow-inject-claude-md.sh, ~/.claude/settings.json</files>
  <action>
**Part A: Create the hook script at `~/.claude/hooks/mow-inject-claude-md.sh`**

```bash
#!/bin/bash
# SubagentStart hook: inject project CLAUDE.md into subagent context
# This ensures all subagents have access to project-level instructions

INPUT=$(cat)

# Get the working directory from hook input
CWD=$(echo "$INPUT" | jq -r '.cwd // "."')

# Look for CLAUDE.md in the project directory
# Claude Code's project CLAUDE.md lives at .claude/CLAUDE.md relative to project root
CLAUDE_MD=""

# Check project-level CLAUDE.md
if [ -f "$CWD/.claude/CLAUDE.md" ]; then
  CLAUDE_MD="$CWD/.claude/CLAUDE.md"
elif [ -f "$CWD/CLAUDE.md" ]; then
  CLAUDE_MD="$CWD/CLAUDE.md"
fi

if [ -z "$CLAUDE_MD" ]; then
  exit 0  # No CLAUDE.md found, nothing to inject
fi

# Read content and output as additionalContext
CONTENT=$(cat "$CLAUDE_MD")
if [ -n "$CONTENT" ]; then
  jq -n --arg ctx "$CONTENT" '{
    "additionalContext": ("Project CLAUDE.md:\n\n" + $ctx)
  }'
fi

exit 0
```

Make the script executable: `chmod +x ~/.claude/hooks/mow-inject-claude-md.sh`

**Part B: Register the SubagentStart hook in `~/.claude/settings.json`**

Add a new `"SubagentStart"` key to the `"hooks"` object:

```json
"SubagentStart": [
  {
    "hooks": [
      {
        "type": "command",
        "command": "bash ~/.claude/hooks/mow-inject-claude-md.sh"
      }
    ]
  }
]
```

**Key design decisions:**
- Uses SubagentStart hook (automatic, no per-workflow changes) per research recommendation
- Checks both `.claude/CLAUDE.md` and root `CLAUDE.md` for compatibility
- Exits silently if no CLAUDE.md exists (non-disruptive)
- Uses `additionalContext` (not `systemMessage`) -- this adds context without interrupting the subagent's flow
- SubagentStart hooks cannot block subagent creation, so this is purely additive
  </action>
  <verify>
1. Verify `~/.claude/hooks/mow-inject-claude-md.sh` exists and is executable
2. Read `~/.claude/settings.json` and confirm SubagentStart hook is registered
3. Run `echo '{"cwd": "/home/max/git/mowism"}' | bash ~/.claude/hooks/mow-inject-claude-md.sh` -- should output JSON with additionalContext if .claude/CLAUDE.md exists
4. Run `echo '{"cwd": "/tmp"}' | bash ~/.claude/hooks/mow-inject-claude-md.sh` -- should exit silently (no CLAUDE.md)
  </verify>
  <done>SubagentStart hook is created, executable, registered in settings.json, and injects CLAUDE.md content as additionalContext into all subagents.</done>
</task>

</tasks>

<verification>
1. Both hook scripts exist and are executable
2. settings.json has correct hook registrations for Stop and SubagentStart
3. Context monitor handles edge cases (stop_hook_active, missing transcript, subagent)
4. CLAUDE.md injection is silent when no CLAUDE.md exists
5. No mow-tools.cjs changes (parallel-safe with Plans 01 and 03)
</verification>

<success_criteria>
- mow-context-monitor.sh warns at 25% remaining and commits + handoff at 15%
- mow-context-monitor.sh skips subagent transcripts
- mow-context-monitor.sh prevents infinite loops via stop_hook_active check
- mow-inject-claude-md.sh injects CLAUDE.md as additionalContext
- Both hooks are registered in settings.json
- Existing hooks (chime, shellcheck) are preserved
</success_criteria>

<output>
After completion, create `.planning/phases/13-gsd-bugfix-ports/13-05-SUMMARY.md`
</output>
