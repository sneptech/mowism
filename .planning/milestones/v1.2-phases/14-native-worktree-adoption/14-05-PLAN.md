---
phase: 14-native-worktree-adoption
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [bin/mow-tools.test.cjs]
autonomous: true
requirements: [WKT-04]
gap_closure: true

must_haves:
  truths:
    - "All three tests in the 'worktree create command' describe block pass when run with `node --test bin/mow-tools.test.cjs`"
    - "No test in the file references the old `.worktrees/pNN` path convention"
    - "Manifest assertions use `.claude/worktrees/manifest.json` path and `phase-NN` keys"
  artifacts:
    - path: "bin/mow-tools.test.cjs"
      provides: "Updated worktree create command tests matching cmdWorktreeCreateNative API"
      contains: ".claude/worktrees/phase-09"
  key_links:
    - from: "bin/mow-tools.test.cjs (worktree create command tests)"
      to: "bin/mow-tools.cjs (cmdWorktreeCreateNative)"
      via: "runMowTools('worktree create 09 --raw', tmpDir)"
      pattern: "worktree create 09 --raw"
---

<objective>
Fix the "worktree create command" test describe block in mow-tools.test.cjs to match the new cmdWorktreeCreateNative API.

Purpose: Close WKT-04 verification gap — all three tests fail because they assert old `.worktrees/p09` paths, old `p09` manifest keys, old `.worktrees/manifest.json` location, and an `output.created` field that no longer exists. Also update the `list-manifest` test that manually writes a manifest at the old `.worktrees/` path.

Output: All worktree tests passing with native path conventions.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-native-worktree-adoption/14-04-SUMMARY.md
@.planning/phases/14-native-worktree-adoption/14-VERIFICATION.md
@bin/mow-tools.test.cjs (lines 3877-4050)
@bin/mow-tools.cjs (cmdWorktreeCreateNative at line 6765)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite worktree create command tests and list-manifest test for native paths</name>
  <files>bin/mow-tools.test.cjs</files>
  <action>
Rewrite the "worktree create command" describe block (lines 3939-4035) and update the "list-manifest" test (lines 3903-3936) in bin/mow-tools.test.cjs. All changes are within these two describe blocks.

**afterEach cleanup (lines 3951-3966):**
- Change `const wtDir = path.join(tmpDir, '.worktrees')` to `const wtDir = path.join(tmpDir, '.claude', 'worktrees')`
- The worktree entry subdirectories inside `.claude/worktrees/` are now named `phase-09` (not `p09`), but the `readdirSync` filter already excludes `manifest.json` and iterates the rest, so entry iteration still works
- Update the `git worktree remove` path to use `path.join(wtDir, entry)` (unchanged, still correct with new wtDir base)

**Test "creates new worktree with correct structure" (lines 3969-3988):**
- Keep command as `worktree create 09 --raw` (the legacy alias routes to create-native)
- REMOVE the line `assert.strictEqual(output.created, true)` — cmdWorktreeCreateNative does NOT output a `created` field
- Keep `assert.strictEqual(output.reused, false)`
- Change path assertion: `output.path` is an ABSOLUTE path. Assert `assert.strictEqual(output.path, path.join(tmpDir, '.claude', 'worktrees', 'phase-09'))` instead of `assert.strictEqual(output.path, '.worktrees/p09')`
- Keep `assert.strictEqual(output.branch, 'phase-09')`
- Change directory exists check: `assert.ok(fs.existsSync(path.join(tmpDir, '.claude', 'worktrees', 'phase-09')), 'worktree directory should exist')`
- Change manifest read: `const manifest = JSON.parse(fs.readFileSync(path.join(tmpDir, '.claude', 'worktrees', 'manifest.json'), 'utf-8'))`
- Change manifest key assertions from `p09` to `phase-09`:
  - `assert.ok(manifest.worktrees['phase-09'], 'manifest should have phase-09 entry')`
  - `assert.strictEqual(manifest.worktrees['phase-09'].status, 'active')`
  - `assert.strictEqual(manifest.worktrees['phase-09'].branch, 'phase-09')`
  - `assert.strictEqual(manifest.worktrees['phase-09'].phase, '09')`

**Test "reuses existing worktree when directory exists" (lines 3990-4003):**
- Keep both `worktree create 09 --raw` calls
- REMOVE `assert.strictEqual(output.created, false)` — no `created` field
- Keep `assert.strictEqual(output.reused, true)`
- Change path assertion: `assert.strictEqual(output.path, path.join(tmpDir, '.claude', 'worktrees', 'phase-09'))`

**Test "cleans stale manifest entry when directory is gone" (lines 4005-4035):**
- Change `const wtPath = path.join(tmpDir, '.worktrees', 'p09')` to `const wtPath = path.join(tmpDir, '.claude', 'worktrees', 'phase-09')`
- Change manifest read before re-create: `const manifestBefore = JSON.parse(fs.readFileSync(path.join(tmpDir, '.claude', 'worktrees', 'manifest.json'), 'utf-8'))`
- Change manifest key: `assert.ok(manifestBefore.worktrees['phase-09'], 'stale entry should still exist before create')`
- REMOVE `assert.strictEqual(output.created, true)` — no `created` field
- Keep `assert.strictEqual(output.reused, false)`

**Test "returns manifest contents when manifest exists" in list-manifest block (lines 3903-3936):**
- Change `const worktreeDir = path.join(tmpDir, '.worktrees')` to `const worktreeDir = path.join(tmpDir, '.claude', 'worktrees')`
- Change manifest data key from `p09` to `phase-09` and path from `.worktrees/p09` to the absolute path format or `.claude/worktrees/phase-09`
- Change assertion `assert.ok(manifest.worktrees.p09, ...)` to `assert.ok(manifest.worktrees['phase-09'], ...)`
- Change `assert.strictEqual(manifest.worktrees.p09.branch, ...)` to `manifest.worktrees['phase-09'].branch`
- Change `assert.strictEqual(manifest.worktrees.p09.status, ...)` to `manifest.worktrees['phase-09'].status`

**IMPORTANT — do NOT change:**
- The `beforeEach` git init setup (lines 3942-3948) — stays the same
- The runMowTools command format `worktree create 09 --raw` — the legacy alias is correct
- `output.branch` assertions — `phase-09` is still the branch name
- `output.reused` assertions — still valid in new API
- `output.phase` assertion if present — still `09`
  </action>
  <verify>
Run the specific test file:
```bash
cd /home/max/git/mowism && node --test --test-name-pattern="worktree" bin/mow-tools.test.cjs
```
All tests in both "worktree list-manifest command" and "worktree create command" describe blocks must pass. Zero failures.

Also confirm no old path references remain:
```bash
grep -n '\.worktrees/p[0-9]' bin/mow-tools.test.cjs
grep -n "\.worktrees/manifest" bin/mow-tools.test.cjs
```
Both grep commands should return zero matches.
  </verify>
  <done>
All three "worktree create command" tests pass: "creates new worktree with correct structure", "reuses existing worktree when directory exists", "cleans stale manifest entry when directory is gone". The "list-manifest" test also passes with native paths. No references to `.worktrees/pNN` or `.worktrees/manifest.json` remain in the test file.
  </done>
</task>

</tasks>

<verification>
1. Run full worktree test suite: `node --test --test-name-pattern="worktree" bin/mow-tools.test.cjs` — all pass
2. Grep for old paths: `grep -rn '\.worktrees/p[0-9]' bin/mow-tools.test.cjs` — zero matches
3. Grep for old manifest location: `grep -rn '\.worktrees/manifest' bin/mow-tools.test.cjs` — zero matches
4. Run full test suite to ensure no regressions: `node --test bin/mow-tools.test.cjs` — all pass
</verification>

<success_criteria>
- All three "worktree create command" tests pass with native `.claude/worktrees/phase-NN` paths
- The "list-manifest" test passes with native paths
- No `.worktrees/pNN` or `.worktrees/manifest.json` references remain in test file
- Full test suite has zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/14-native-worktree-adoption/14-05-SUMMARY.md`
</output>
