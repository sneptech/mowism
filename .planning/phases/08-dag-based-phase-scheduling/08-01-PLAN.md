---
phase: 08-dag-based-phase-scheduling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/mow-tools.cjs
  - bin/mow-tools.test.cjs
autonomous: true
requirements:
  - DAG-01

must_haves:
  truths:
    - "ROADMAP.md `**Goal**:` and `**Depends on**:` fields (colon outside bold) are correctly parsed by `roadmap analyze` and `roadmap get-phase`"
    - "`parseDependsOn()` extracts structured phase arrays from free-text dependency strings"
    - "`phase add` and `phase insert` preserve current default behavior (DAG agent handles dependency re-analysis after manual changes)"
    - "Existing tests pass after regex fix (tests updated to match real ROADMAP.md format)"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "parseDependsOn() helper, fixed regex patterns in cmdRoadmapAnalyze, cmdRoadmapGetPhase, cmdPhaseComplete"
      contains: "parseDependsOn"
    - path: "bin/mow-tools.test.cjs"
      provides: "Tests for parseDependsOn, updated roadmap analyze tests, format compatibility tests"
      contains: "parseDependsOn"
  key_links:
    - from: "bin/mow-tools.cjs (cmdRoadmapAnalyze)"
      to: "ROADMAP.md"
      via: "regex matching **Goal**: and **Depends on**: fields"
      pattern: "\\*\\*Goal\\*\\*:"
    - from: "bin/mow-tools.cjs (parseDependsOn)"
      to: "cmdRoadmapAnalyze output"
      via: "depends_on_parsed field in analyze output"
      pattern: "depends_on_parsed"
---

<objective>
Fix the regex format mismatch bug in mow-tools.cjs roadmap parsing and add the `parseDependsOn()` helper that extracts structured phase arrays from free-text dependency strings. This is the foundation for all DAG analysis work.

Purpose: The existing regex patterns in `cmdRoadmapAnalyze`, `cmdRoadmapGetPhase`, and `cmdPhaseComplete` expect `**Goal:**` (colon inside bold markers) but actual ROADMAP.md files use `**Goal**:` (colon outside bold). This causes `goal` and `depends_on` to return `null` for all phases. Fixing this and adding structured dependency parsing enables the DAG analysis built in Plan 02.

Output: Fixed regex patterns, new `parseDependsOn()` function, updated and new tests.
</objective>

<execution_context>
@/home/max/.claude/mowism/workflows/execute-plan.md
@/home/max/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-dag-based-phase-scheduling/08-RESEARCH.md
@bin/mow-tools.cjs
@bin/mow-tools.test.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix regex patterns and add parseDependsOn()</name>
  <files>bin/mow-tools.cjs</files>
  <action>
Fix the colon-inside-bold regex bug across all affected functions. The actual ROADMAP.md format uses `**Field**:` (colon OUTSIDE bold markers) but the code matches `\*\*Field:\*\*` (colon INSIDE bold markers).

**1. Fix `cmdRoadmapAnalyze` (around line 3347-3351):**
Change:
```javascript
const goalMatch = section.match(/\*\*Goal:\*\*\s*([^\n]+)/i);
```
To match both formats (robust):
```javascript
const goalMatch = section.match(/\*\*Goal\*?\*?:\s*([^\n]+)/i);
```
Apply same fix to the `dependsMatch` regex on the next line.

**2. Fix `cmdRoadmapGetPhase` (around line 1211):**
Same pattern: change `\*\*Goal:\*\*` to `\*\*Goal\*?\*?:`.

**3. Fix `cmdPhaseComplete` (around line 4031-4046):**
Update the `planCountPattern` regex that matches `\*\*Plans:\*\*` to `\*\*Plans\*?\*?:`.
Update the `reqMatch` regex that matches `\*\*Requirements:\*\*` to `\*\*Requirements\*?\*?:`.

**4. Add `parseDependsOn()` function** (place near `cmdRoadmapAnalyze`, before it):
```javascript
function parseDependsOn(raw) {
  if (!raw || /nothing|none|n\/a|first phase/i.test(raw)) return [];
  return (raw.match(/Phase\s+(\d+(?:\.\d+)?)/gi) || [])
    .map(m => m.match(/\d+(?:\.\d+)?/)[0]);
}
```

**5. Add `depends_on_parsed` to `roadmap analyze` output:**
In `cmdRoadmapAnalyze`, after constructing each phase object, add:
```javascript
depends_on_parsed: parseDependsOn(depends_on),
```
This adds a structured array alongside the existing raw `depends_on` text field (backward compatible).

**6. Update `cmdPhaseAdd` (around line 3481):**
Change the hardcoded `Depends on: Phase ${maxPhase}` in the phase entry template. Instead, default to `Depends on: Phase ${maxPhase}` still (preserves current behavior as research recommends) but add a comment noting it can be overridden by the DAG agent.

**7. Update `cmdPhaseInsert` (around line 3554):**
Same: keep current behavior of `Depends on: Phase ${afterPhase}` (research says preserve current behavior for insert too).

Note: Items 6 and 7 are actually fine as-is per research recommendation ("Default to Phase ${maxPhase} for phase add... preserves current behavior"). No code change needed -- the DAG agent handles re-analysis after manual changes. Skip these edits.
  </action>
  <verify>
Run `node bin/mow-tools.cjs roadmap analyze --raw` from the project root and verify that `goal` and `depends_on` fields are no longer null for phases 7-11. Verify `depends_on_parsed` arrays are present (e.g., Phase 9 should have `["7", "8"]`).
  </verify>
  <done>
`roadmap analyze` correctly parses `**Goal**:` and `**Depends on**:` (colon-outside-bold format). `parseDependsOn()` function exists and returns structured arrays. Phase 9 shows `depends_on_parsed: ["7", "8"]`. Phase 7 shows `depends_on_parsed: []`. `phase add` and `phase insert` preserve their current default behavior unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update existing tests and add parseDependsOn tests</name>
  <files>bin/mow-tools.test.cjs</files>
  <action>
**1. Update existing `roadmap analyze` test data** to use `**Goal**:` format (colon outside bold) since the regex now matches both formats but we want tests to reflect the canonical format used in actual ROADMAP.md files. Specifically:
- In the test `'parses phases with goals and disk status'` (around line 1262), change `**Goal:**` to `**Goal**:` in the test ROADMAP.md content.
- In the test `'extracts goals and dependencies'` (around line 1303), change `**Goal:**` to `**Goal**:` and `**Depends on:**` to `**Depends on**:` in the test content. Update assertions: `depends_on` field values should still match (they're raw text).

**2. Add test for `parseDependsOn` via `roadmap analyze` output.** Create a new test in the `roadmap analyze` describe block:
```javascript
test('provides depends_on_parsed arrays', () => {
  // Write a ROADMAP with multi-dependency phases
  fs.writeFileSync(
    path.join(tmpDir, '.planning', 'ROADMAP.md'),
    `# Roadmap\n\n### Phase 7: State\n**Goal**: Build state\n**Depends on**: Nothing (first phase)\n\n### Phase 8: DAG\n**Goal**: Build DAG\n**Depends on**: Nothing\n\n### Phase 9: Execution\n**Goal**: Run phases\n**Depends on**: Phase 7, Phase 8\n\n### Phase 11: Docs\n**Goal**: Write docs\n**Depends on**: Phase 7, Phase 8, Phase 9, Phase 10\n`
  );

  const result = runMowTools('roadmap analyze', tmpDir);
  assert.ok(result.success);
  const output = JSON.parse(result.output);

  // Phase 7: depends on nothing
  assert.deepStrictEqual(output.phases[0].depends_on_parsed, []);
  // Phase 8: depends on nothing
  assert.deepStrictEqual(output.phases[1].depends_on_parsed, []);
  // Phase 9: depends on 7 and 8
  assert.deepStrictEqual(output.phases[2].depends_on_parsed, ['7', '8']);
  // Phase 11: depends on 7, 8, 9, 10 (10 missing from ROADMAP but still parsed)
  assert.deepStrictEqual(output.phases[3].depends_on_parsed, ['7', '8', '9', '10']);
});
```

**3. Add backward compatibility test** confirming the regex still matches the old `**Goal:**` format (colon inside bold) since some older or manually-written roadmaps may use it:
```javascript
test('handles both colon-inside-bold and colon-outside-bold formats', () => {
  fs.writeFileSync(
    path.join(tmpDir, '.planning', 'ROADMAP.md'),
    `# Roadmap\n\n### Phase 1: Old Format\n**Goal:** Old style goal\n**Depends on:** Nothing\n\n### Phase 2: New Format\n**Goal**: New style goal\n**Depends on**: Phase 1\n`
  );

  const result = runMowTools('roadmap analyze', tmpDir);
  assert.ok(result.success);
  const output = JSON.parse(result.output);

  assert.strictEqual(output.phases[0].goal, 'Old style goal');
  assert.strictEqual(output.phases[0].depends_on, 'Nothing');
  assert.strictEqual(output.phases[1].goal, 'New style goal');
  assert.strictEqual(output.phases[1].depends_on, 'Phase 1');
});
```

**4. Update ALL other test files** that write `**Goal:**` format in ROADMAP.md test data. Search for `**Goal:**` in the test file and update each occurrence to `**Goal**:`. Do the same for `**Depends on:**` -> `**Depends on**:`, `**Plans:**` -> `**Plans**:`, `**Requirements:**` -> `**Requirements**:`. This ensures tests match the canonical format going forward.
  </action>
  <verify>
Run `node --test bin/mow-tools.test.cjs` and confirm all tests pass, including the new `parseDependsOn` and backward compatibility tests.
  </verify>
  <done>
All existing tests pass with updated format. New tests confirm `depends_on_parsed` arrays are correct for Nothing, single dependency, and multi-dependency cases. Backward compatibility test confirms both `**Goal:**` and `**Goal**:` formats are parsed.
  </done>
</task>

</tasks>

<verification>
1. `node bin/mow-tools.cjs roadmap analyze --raw` returns non-null `goal` and `depends_on` for all phases
2. `depends_on_parsed` arrays match expected values for the project's own ROADMAP.md
3. `node --test bin/mow-tools.test.cjs` passes all tests (existing + new)
4. `parseDependsOn("Nothing")` returns `[]`
5. `parseDependsOn("Phase 7, Phase 8")` returns `["7", "8"]`
6. `parseDependsOn("Phase 7 (some annotation), Phase 8")` returns `["7", "8"]`
</verification>

<success_criteria>
- Regex bug fixed: `roadmap analyze` correctly parses `**Goal**:` format from real ROADMAP.md files
- Both old (`**Goal:**`) and new (`**Goal**:`) formats supported
- `parseDependsOn()` function extracts structured arrays from free-text dependency strings
- `depends_on_parsed` field added to `roadmap analyze` output (backward compatible)
- All tests pass including new dependency parsing tests
</success_criteria>

<output>
After completion, create `.planning/phases/08-dag-based-phase-scheduling/08-01-SUMMARY.md`
</output>
