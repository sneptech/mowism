---
phase: 15-full-lifecycle-workers
plan: 02
type: execute
wave: 2
depends_on:
  - "15-01"
files_modified:
  - agents/mow-phase-worker.md
autonomous: true
requirements:
  - WORK-01
  - WORK-02
  - WORK-03
  - WORK-04
  - WORK-05
  - WORK-06
  - WORK-07

must_haves:
  truths:
    - "Worker chains all 5 lifecycle stages: discuss -> research -> plan -> execute -> refine"
    - "Worker pauses at discuss stage and sends input_needed message to lead before any AskUserQuestion call"
    - "Worker passes file paths between stages, never full file contents"
    - "Worker detects existing artifacts at startup and skips to the first incomplete stage"
    - "Worker spawns mow-phase-researcher, mow-planner, mow-plan-checker, mow-executor, and mow-verifier via Task()"
    - "Worker sends stage_transition messages at every stage boundary"
    - "Worker resolves per-subagent models via resolve-model at initialization"
    - "Worker reads worker.stage_gates config at each stage boundary for configurable pause behavior"
  artifacts:
    - path: "agents/mow-phase-worker.md"
      provides: "Full-lifecycle phase worker with 5-stage pipeline, resume detection, stage gates, nested delegation"
      contains: "stage_transition"
  key_links:
    - from: "agents/mow-phase-worker.md (discuss stage)"
      to: "mowism/workflows/discuss-phase.md"
      via: "inline workflow execution with AskUserQuestion"
      pattern: "discuss-phase"
    - from: "agents/mow-phase-worker.md (research stage)"
      to: "agents/mow-phase-researcher.md"
      via: "Task() subagent spawn"
      pattern: "mow-phase-researcher"
    - from: "agents/mow-phase-worker.md (plan stage)"
      to: "mowism/workflows/plan-phase.md"
      via: "inline workflow execution spawning mow-planner and mow-plan-checker"
      pattern: "plan-phase"
    - from: "agents/mow-phase-worker.md (execute stage)"
      to: "mowism/workflows/execute-phase.md"
      via: "inline workflow execution spawning mow-executor per plan"
      pattern: "execute-phase"
    - from: "agents/mow-phase-worker.md (refine stage)"
      to: "agents/mow-verifier.md"
      via: "Task() subagent spawn"
      pattern: "mow-verifier"
---

<objective>
Rewrite mow-phase-worker.md to be a full-lifecycle orchestrator that chains discuss, research, plan, execute, and refine stages autonomously with artifact-based resume detection, configurable stage gates, disk-first context passing, and nested subagent delegation.

Purpose: This is the core Phase 15 deliverable. Currently the worker only handles context gathering + planning + execution. The rewrite makes it a complete autonomous per-phase orchestrator covering the entire lifecycle.

Output: Rewritten agents/mow-phase-worker.md agent definition.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@agents/mow-phase-worker.md
@.planning/phases/15-full-lifecycle-workers/15-CONTEXT.md
@.planning/phases/15-full-lifecycle-workers/15-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite mow-phase-worker.md with full lifecycle pipeline</name>
  <files>agents/mow-phase-worker.md</files>
  <action>
  Rewrite agents/mow-phase-worker.md to replace the current Steps 1-5 with a full lifecycle pipeline. Preserve the existing YAML frontmatter (name, description, tools, color) and the constraints, messaging_protocol, and failure_handling sections (update them as needed). The new lifecycle section replaces the current `<lifecycle>` block.

  **Structure of rewritten agent:**

  1. **Frontmatter update:** Update description to mention "full lifecycle: discuss -> research -> plan -> execute -> refine". Keep existing tools list (it already includes Task, SendMessage, etc.).

  2. **Role section update:** Update to describe the 5-stage lifecycle. Keep the nested hierarchy description. Add mention of artifact-based resume and configurable stage gates.

  3. **New Step 1: Initialize and Resume Detection**
     - Print phase-colored banner (existing)
     - Run `mow-tools.cjs init phase-op {phase}` to get artifact state
     - Extract: `has_context`, `has_research`, `has_plans`, `plan_count`, `summary_count`, `has_verification`
     - Check for CHECKPOINT.md (existing resume pattern)
     - Determine `start_stage` using artifact-based detection:
       ```
       if !has_context:     start_at = "discuss"
       elif !has_research:  start_at = "research"
       elif !has_plans:     start_at = "plan"
       elif summary_count < plan_count: start_at = "execute"
       elif !has_verification: start_at = "refine"
       else: start_at = "complete"  # nothing to do
       ```
     - Resolve all subagent models once via `mow-tools.cjs resolve-model`:
       - `researcher_model` = resolve-model mow-phase-researcher
       - `planner_model` = resolve-model mow-planner (use init's planner_model field instead if available)
       - `checker_model` = resolve-model mow-plan-checker
       - `executor_model` = resolve-model mow-executor
       - `verifier_model` = resolve-model mow-verifier
     - Send stage_transition message indicating current stage

  4. **New Step 2: Discuss Stage (if start_at <= discuss)**
     - CRITICAL: Discuss runs INLINE, never as Task(). Worker follows discuss-phase.md workflow directly.
     - Before any AskUserQuestion: send `input_needed` message to lead (dual-path notification per locked decision):
       ```bash
       MSG=$(node ~/.claude/mowism/bin/mow-tools.cjs message format input_needed --phase {phase} --input-type discussion_prompt --detail "Phase needs discuss-phase context gathering" --activity "Awaiting user input" --raw)
       ```
       SendMessage to lead with summary "Phase {N} needs user input for discuss"
     - Run discuss-phase workflow inline: follow `mowism/workflows/discuss-phase.md` steps (analyze phase, present gray areas via AskUserQuestion, discuss areas, write CONTEXT.md)
     - CONTEXT.md creation signals "discuss done" -- no explicit continue confirmation needed
     - After CONTEXT.md created: send stage_transition from discussing to researching
     - Check stage gate before proceeding (see Stage Gate Check pattern below)

  5. **New Step 3: Research Stage (if start_at <= research)**
     - Spawn mow-phase-researcher as Task() subagent:
       ```
       Task(
         subagent_type="mow-phase-researcher",
         model="{researcher_model}",
         prompt="First, read ~/.claude/agents/mow-phase-researcher.md for your role.\n\n
           <objective>Research Phase {phase}: {name}</objective>
           <phase_context>Read: {phase_dir}/{padded_phase}-CONTEXT.md</phase_context>
           <output>Write to: {phase_dir}/{padded_phase}-RESEARCH.md</output>"
       )
       ```
     - DISK-FIRST: Worker stores only the file path from the return, NOT research content
     - Send stage_transition from researching to planning
     - Check stage gate

  6. **New Step 4: Plan Stage (if start_at <= plan)**
     - Run plan-phase workflow INLINE (because plan-phase itself spawns mow-planner and mow-plan-checker as Task() subagents -- nested spawning would crash if we delegated the whole workflow as Task())
     - Follow `mowism/workflows/plan-phase.md` steps 1-12 inline:
       - Initialize with `mow-tools.cjs init plan-phase {phase}`
       - Spawn mow-planner via Task() with planner_model
       - Spawn mow-plan-checker via Task() with checker_model (non-negotiable gate)
       - Handle revision loop (max 3 iterations)
     - DISK-FIRST: Worker tracks plan count and file names, NOT plan contents
     - Send plan_created messages for each plan
     - Send stage_transition from planning to executing
     - Check stage gate (if `worker.stage_gates` is `"before_execute"`, pause here)

  7. **New Step 5: Execute Stage (if start_at <= execute)**
     - Run execute-phase workflow INLINE (because it spawns mow-executor subagents per plan)
     - Follow `mowism/workflows/execute-phase.md` execute_waves step:
       - Get plan index via `mow-tools.cjs phase-plan-index {phase}`
       - For each wave, for each plan: spawn mow-executor via Task() with executor_model
       - Spot-check SUMMARY.md after each executor
       - Send task_claimed, commit_made, task_complete, plan_complete messages
     - DISK-FIRST: Worker tracks SUMMARY existence, NOT summary contents
     - After all plans complete: send stage_transition from executing to refining
     - Check stage gate

  8. **New Step 6: Refine Stage (if start_at <= refine)**
     - Check `workflow.verifier` config -- if false, skip refine stage entirely
     - Spawn mow-verifier as Task() subagent:
       ```
       Task(
         subagent_type="mow-verifier",
         model="{verifier_model}",
         prompt="Verify phase {phase} goal achievement.
           Phase directory: {phase_dir}
           Phase goal: {goal from ROADMAP.md}
           Read: {phase_dir}/*-PLAN.md and {phase_dir}/*-SUMMARY.md
           Create VERIFICATION.md."
       )
       ```
     - DISK-FIRST: Worker checks verification status, NOT full verification content
     - Handle verification result: passed/gaps_found/human_needed

  9. **New Step 7: Phase Complete**
     - Send phase_complete message to lead
     - Update STATUS.md with final status
     - STAY ALIVE -- wait for shutdown signal (existing behavior)

  **Stage Gate Check pattern (used between every stage):**
  ```bash
  GATE=$(node ~/.claude/mowism/bin/mow-tools.cjs config-get worker.stage_gates 2>/dev/null || echo "none")
  ```
  - `"none"`: auto-continue (default)
  - `"before_execute"`: pause only before execute stage
  - `"every_stage"`: pause between every stage
  When pausing: send `input_needed` with `input_type: stage_gate` and `detail: "Stage gate: awaiting approval to proceed to {next_stage}"`

  **Preserved from current worker:**
  - All constraints (single-writer protocol, never read STATE.md for coordination, commit only phase files, stay alive on failure/completion)
  - Messaging protocol section (11 message types -- already correct)
  - Failure handling section (checkpoint files, error banners, cancel support, context recap)
  - Phase-colored banner at init
  - Permission prompt context echo pattern

  **Key design rules (from locked decisions):**
  - Discuss ALWAYS pauses for user input. Worker MUST send input_needed AND use AskUserQuestion.
  - Auto-advance config (`workflow.auto_advance`) is IGNORED during discuss -- discuss always pauses.
  - File paths only between stages. Never `cat RESEARCH.md` into worker context.
  - 3-level hierarchy: worker (Level 1) -> subagents (Level 2). Subagents do NOT spawn further.
  </action>
  <verify>
  Verify the rewritten agent has all required sections:
  ```bash
  grep -c "stage_transition" agents/mow-phase-worker.md
  grep -c "input_needed" agents/mow-phase-worker.md
  grep -c "mow-phase-researcher" agents/mow-phase-worker.md
  grep -c "mow-verifier" agents/mow-phase-worker.md
  grep -c "stage_gates" agents/mow-phase-worker.md
  grep -c "summary_count" agents/mow-phase-worker.md
  grep -c "resolve-model" agents/mow-phase-worker.md
  grep -c "DISK-FIRST\|disk-first\|file paths only\|NOT.*content" agents/mow-phase-worker.md
  ```
  All counts should be >= 1.
  </verify>
  <done>
  mow-phase-worker.md contains complete 5-stage lifecycle (discuss/research/plan/execute/refine) with:
  - Artifact-based resume detection using init phase-op fields
  - Dual-path discuss notification (input_needed + AskUserQuestion)
  - Disk-first context passing (file paths, not contents)
  - Configurable stage gates read at each boundary
  - Model resolution via resolve-model at init
  - Stage transition messages at every boundary
  - Nested Task() delegation for researcher, planner, checker, executor, verifier
  - Preserved constraints, messaging protocol, and failure handling
  </done>
</task>

</tasks>

<verification>
1. Agent frontmatter is valid YAML with correct name, tools, color
2. All 5 stages are present: discuss, research, plan, execute, refine
3. Discuss stage sends input_needed AND uses AskUserQuestion (dual-path)
4. Research, execute, refine stages use Task() for subagent delegation
5. Plan stage runs inline (follows plan-phase.md) and spawns planner + checker via Task()
6. Artifact-based resume detection uses init phase-op fields (has_context, has_research, has_plans, summary_count, has_verification)
7. Stage gate config read at each boundary with fallback to "none"
8. All stage transitions send stage_transition messages to lead
9. Disk-first pattern: no stage reads full artifact content into worker context
10. All existing constraints, failure handling, and messaging protocol preserved
</verification>

<success_criteria>
- A phase worker can be spawned and will chain all 5 stages sequentially
- Discuss always pauses for user input (never bypassed)
- Resumed workers skip completed stages based on artifact detection
- Stage transition messages are sent at every boundary
- Subagents are spawned with cost-appropriate models from resolve-model
- Context between stages passed as file paths, never file contents
</success_criteria>

<output>
After completion, create `.planning/phases/15-full-lifecycle-workers/15-02-SUMMARY.md`
</output>
