---
phase: 15-full-lifecycle-workers
plan: 03
type: execute
wave: 2
depends_on:
  - "15-01"
files_modified:
  - mowism/workflows/discuss-phase.md
  - mowism/workflows/execute-phase.md
  - agents/mow-team-lead.md
autonomous: true
requirements:
  - WORK-02
  - WORK-06

must_haves:
  truths:
    - "discuss-phase.md guards against auto-advance when running inside a worker context"
    - "execute-phase.md detects worker context and skips redundant claim/branch/state operations"
    - "Team lead renders stage_transition messages from workers with stage name + sub-progress on dashboard"
  artifacts:
    - path: "mowism/workflows/discuss-phase.md"
      provides: "Worker-mode guard preventing auto-advance from bypassing discuss pause"
      contains: "worker.*mode\|worktree.*guard\|auto_advance.*discuss"
    - path: "mowism/workflows/execute-phase.md"
      provides: "Worker-mode detection skipping claim, branching, and state updates"
      contains: "worker.*mode\|phase.*worker"
    - path: "agents/mow-team-lead.md"
      provides: "Stage gate config awareness and stage_transition rendering"
      contains: "stage_gates\|stage_transition"
  key_links:
    - from: "mowism/workflows/discuss-phase.md (auto_advance step)"
      to: "agents/mow-phase-worker.md"
      via: "worker-mode guard prevents auto-advance during discuss"
      pattern: "auto_advance.*false\|skip.*auto.*advance"
    - from: "mowism/workflows/execute-phase.md (initialize step)"
      to: "agents/mow-phase-worker.md"
      via: "worker-mode detection adjusts initialization behavior"
      pattern: "worker.*mode\|worktree.*phase"
    - from: "agents/mow-team-lead.md (message_processing)"
      to: "agents/mow-phase-worker.md"
      via: "stage_transition events update dashboard"
      pattern: "stage_transition.*dashboard"
---

<objective>
Update supporting workflows and agents for worker-mode awareness: discuss-phase auto-advance guard, execute-phase worker-mode detection, and team lead stage_transition dashboard rendering with stage gate config awareness.

Purpose: The worker runs these workflows inline. They need minor adjustments to behave correctly when invoked by a worker vs. directly by the user. The team lead needs to understand new stage_transition content for dashboard rendering.

Output: Updated discuss-phase.md, execute-phase.md, and mow-team-lead.md with worker-mode guards and stage awareness.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@mowism/workflows/discuss-phase.md
@mowism/workflows/execute-phase.md
@agents/mow-team-lead.md
@.planning/phases/15-full-lifecycle-workers/15-CONTEXT.md
@.planning/phases/15-full-lifecycle-workers/15-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add worker-mode guards to discuss-phase.md and execute-phase.md</name>
  <files>mowism/workflows/discuss-phase.md, mowism/workflows/execute-phase.md</files>
  <action>
  **discuss-phase.md changes:**

  In the `auto_advance` step (the last step in the workflow), add a worker-mode guard at the TOP of the step:

  ```markdown
  **Worker-mode guard:** When discuss-phase is invoked inline by a phase worker (detected by the presence of STATUS.md for this phase in the current worktree or by the caller providing a `--worker-mode` flag), SKIP the auto_advance step entirely. The worker handles stage sequencing itself -- auto-advance would create a nested Task() that spawns plan-phase, which conflicts with the worker's inline plan-phase execution.
  ```

  Also add a comment in the `check_existing` step noting that when called from a worker, the "Skip" option should not be offered -- the worker always creates context if missing.

  **execute-phase.md changes:**

  In the `initialize` step, add a worker-mode detection note:

  ```markdown
  **Worker-mode detection:** When execute-phase is run inline by a phase worker (detected by STATUS.md existence AND current worktree being in `.claude/worktrees/`):
  - Skip `worktree claim` (worker already claimed the phase at spawn time)
  - Skip `handle_branching` (worktree has its own branch)
  - Skip `agent_teams_nudge` (worker is already in an Agent Team)
  - Skip `update_roadmap` (lead handles after merge)
  - Skip `offer_next` auto-advance (worker handles stage sequencing)

  The `multi_phase_check` step already handles this case. This note makes the behavior explicit for the worker context.
  ```

  In the `verify_phase_goal` step, add a note that when running in worker mode, the verifier spawn should use the `verifier_model` passed by the worker (from its resolve-model at init), not re-resolve.

  These are documentation/guard additions to existing steps, not structural changes to the workflow logic.
  </action>
  <verify>
  ```bash
  grep -c "worker.*mode\|Worker-mode" mowism/workflows/discuss-phase.md
  grep -c "worker.*mode\|Worker-mode" mowism/workflows/execute-phase.md
  ```
  Both should return >= 1.
  </verify>
  <done>discuss-phase.md has auto-advance guard for worker mode. execute-phase.md has worker-mode detection notes for skipping claim, branching, nudge, and auto-advance.</done>
</task>

<task type="auto">
  <name>Task 2: Update team lead for stage gate awareness and stage_transition rendering</name>
  <files>agents/mow-team-lead.md</files>
  <action>
  **In the `<multi_phase_flow>` section, Step 5 (Event-Driven Monitoring):**

  Update the `stage_transition` message handling. Currently the team lead handles stage_transition implicitly (it goes through dashboard event add). Add explicit handling:

  ```markdown
  **On `stage_transition` (worker moving between lifecycle stages):**
  1. Parse from_stage and to_stage from the message
  2. Update Active Phases table with current stage:
     ```bash
     node ~/.claude/mowism/bin/mow-tools.cjs state update-phase-row {phase} \
       --status "executing ({to_stage})" --last-update "$(date -u +%H:%M)"
     ```
  3. Add to dashboard event log:
     ```bash
     node ~/.claude/mowism/bin/mow-tools.cjs dashboard event add --type stage_transition --phase {N} \
       --detail "Phase {N}: {from_stage} -> {to_stage}"
     ```
  4. Re-render dashboard:
     ```bash
     node ~/.claude/mowism/bin/mow-tools.cjs dashboard render
     ```

  The dashboard render already handles stage_transition events. This explicit handling ensures the Active Phases table also reflects the current lifecycle stage (not just "executing" generically).
  ```

  **Add Stage Gate Config Awareness section** at the end of `<multi_phase_flow>` before `</multi_phase_flow>`:

  ```markdown
  ### Stage Gate Configuration

  Workers respect the `worker.stage_gates` config setting. The lead does NOT enforce stage gates — workers read this config themselves at each stage boundary. The lead's role is:

  1. **If a worker sends `input_needed` with `input_type: stage_gate`:** The dashboard auto-pins the notification. No special handling needed beyond the existing input_needed flow.
  2. **When spawning workers:** Include the current worker.stage_gates value in the worker prompt as context (informational — workers read config themselves, but this provides visibility).
  ```

  **Update the spawn prompt template** in Step 4 (Spawn Phase Workers for Ready Phases) to include stage gate info. After the existing prompt content, add:
  ```
  Worker autonomy: stage_gates = {gate_value}
  ```
  Where `gate_value` is read from config at spawn time via `config-get worker.stage_gates`.
  </action>
  <verify>
  ```bash
  grep -c "stage_gates" agents/mow-team-lead.md
  grep -c "stage_transition" agents/mow-team-lead.md
  grep -c "executing.*stage\|to_stage" agents/mow-team-lead.md
  ```
  All counts should be >= 1.
  </verify>
  <done>Team lead explicitly handles stage_transition to update Active Phases table with stage name. Stage gate config awareness documented with worker spawn prompt including gate value.</done>
</task>

</tasks>

<verification>
1. discuss-phase.md has worker-mode guard in auto_advance step
2. execute-phase.md has worker-mode detection in initialize step
3. Team lead handles stage_transition messages with Active Phases table update
4. Team lead spawns workers with stage_gates value in prompt
5. No structural changes to existing workflow logic -- only guard additions and documentation
</verification>

<success_criteria>
- Discuss-phase auto-advance is blocked when running in worker mode
- Execute-phase skips redundant operations (claim, branch, nudge) in worker mode
- Dashboard shows lifecycle stage for each active worker (not just generic "executing")
- Team lead includes stage_gates config in worker spawn prompt
</success_criteria>

<output>
After completion, create `.planning/phases/15-full-lifecycle-workers/15-03-SUMMARY.md`
</output>
