---
phase: 09-multi-phase-execution-engine
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - mowism/workflows/close-shop.md
  - mowism/workflows/execute-phase.md
  - commands/mow/close-shop.md
  - mowism/help/close-shop.md
autonomous: true
requirements: [EXEC-01, EXEC-02]

must_haves:
  truths:
    - "Running `/mow:close-shop` triggers graceful shutdown: checks worker status, runs pending merges, captures deferred items, updates STATE.md, sends shutdown requests"
    - "execute-phase.md in multi-phase mode delegates to the team lead rather than running plans directly"
    - "A user-facing command `/mow:close-shop` exists with help documentation"
    - "Pause-work signal is supported: user can tell orchestrator or individual worker to pause with state saved"
  artifacts:
    - path: "mowism/workflows/close-shop.md"
      provides: "Graceful multi-phase shutdown workflow"
      min_lines: 60
    - path: "mowism/workflows/execute-phase.md"
      provides: "Updated phase execution with multi-phase mode awareness"
      contains: "multi_phase"
    - path: "commands/mow/close-shop.md"
      provides: "Claude Code command entry for /mow:close-shop"
      contains: "close-shop"
    - path: "mowism/help/close-shop.md"
      provides: "Help file for /mow:close-shop"
      contains: "close-shop"
  key_links:
    - from: "mowism/workflows/close-shop.md"
      to: "agents/mow-team-lead.md"
      via: "Invoked by lead or user directly"
      pattern: "team-lead|SendMessage"
    - from: "mowism/workflows/execute-phase.md"
      to: "agents/mow-team-lead.md"
      via: "Multi-phase delegation"
      pattern: "multi.phase|team.lead"
    - from: "commands/mow/close-shop.md"
      to: "mowism/workflows/close-shop.md"
      via: "Workflow reference"
      pattern: "close-shop"
---

<objective>
Close-shop workflow for graceful multi-phase shutdown and execute-phase multi-phase awareness.

Purpose: Phase workers signal done but stay alive (locked decision). The `/mow:close-shop` command provides the graceful shutdown path: checking worker status, running pending merges, capturing deferred items and new context, updating state, and sending shutdown requests. Additionally, execute-phase.md needs a multi-phase mode hook so that when invoked in a multi-phase context, it delegates to the team lead instead of running plans directly.

Output: New close-shop.md workflow, updated execute-phase.md, new /mow:close-shop command and help file.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-multi-phase-execution-engine/09-CONTEXT.md
@.planning/phases/09-multi-phase-execution-engine/09-RESEARCH.md
@.planning/phases/09-multi-phase-execution-engine/09-01-SUMMARY.md
@mowism/workflows/execute-phase.md
@agents/mow-team-lead.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create close-shop workflow and command</name>
  <files>mowism/workflows/close-shop.md, commands/mow/close-shop.md, mowism/help/close-shop.md</files>
  <action>
**1. Create `mowism/workflows/close-shop.md`:**

This is the graceful shutdown workflow that runs when a multi-phase session is winding down. Can be triggered by the user running `/mow:close-shop` or by telling the team lead to wrap up.

```markdown
<purpose>
Gracefully shut down a multi-phase execution session. Ensures context is saved, pending git operations are handled, and new ideas/context are captured before cleaning up.
</purpose>

<process>

<step name="check_status">
## Step 1: Check Worker Status

Read the Active Phases table from STATE.md:
```bash
ACTIVE=$(node ~/.claude/mowism/bin/mow-tools.cjs state active-phases)
```

Parse the JSON to determine:
- How many workers are still active
- How many have signaled done (status: complete)
- How many have errors (status: failed)
- How many are still executing

**If workers are still executing:**
Report which phases are still running and ask user:
- "Wait for them to finish?" (default)
- "Send pause signal?" (saves state, workers checkpoint and stop)
- "Force cancel?" (workers stash, checkpoint, shut down immediately)

**If all workers are done or failed:**
Proceed to Step 2.
</step>

<step name="pending_merges">
## Step 2: Handle Pending Merges

Read worktree manifest:
```bash
MANIFEST=$(node ~/.claude/mowism/bin/mow-tools.cjs worktree list-manifest)
```

For each worktree where status is "active" and the phase is marked complete:
1. Merge into main: `node ~/.claude/mowism/bin/mow-tools.cjs worktree merge {phase}`
2. If conflicts: report and ask user to resolve (or delegate to merge subagent)
3. Update manifest entry to "merged"

Report: "Merged {N} phase branches into main."
</step>

<step name="capture_context">
## Step 3: Capture Deferred Items and Context

For each completed phase worker:
1. Read STATUS.md from the worktree: `cat .worktrees/p{NN}/.planning/phases/{phase_dir}/{NN}-STATUS.md`
2. Look for deferred items, new ideas, or context notes
3. If any found, write to `.planning/phases/{phase_dir}/deferred-items.md` with YAML frontmatter:
   ```yaml
   ---
   phase: {phase}
   source: close-shop
   captured: {ISO-8601 timestamp}
   ---
   ```
4. Also check for any CHECKPOINT.md files from failed phases -- summarize what needs follow-up

Report: "Captured deferred items from {N} phases. {M} checkpoints need follow-up."
</step>

<step name="update_state">
## Step 4: Update STATE.md

Update all tracking:
1. Update Active Phases table with final statuses for all phases
2. Update Current Position to reflect the most advanced completed phase
3. Add session record: `node ~/.claude/mowism/bin/mow-tools.cjs state record-session --stopped-at "Multi-phase session close-shop" --resume "Review pending checkpoints and deferred items"`

Commit:
```bash
node ~/.claude/mowism/bin/mow-tools.cjs commit "docs: close-shop state update" --files .planning/STATE.md .planning/ROADMAP.md
```
</step>

<step name="shutdown_workers">
## Step 5: Shutdown Workers

For each active worker (from team config):
```
SendMessage({ type: "shutdown_request", recipient: "phase-{NN}", content: "Close-shop: session ending. Thank you for your work." })
```

Wait for acknowledgments (workers should approve shutdown since they are in done state).

After all workers acknowledge (or timeout after 30s):
1. Stop team tracking: `node ~/.claude/mowism/bin/mow-tools.cjs team-update --action stop`
2. Delete team: `TeamDelete()`
</step>

<step name="report">
## Step 6: Final Report

```markdown
## Session Complete

**Phases executed:** {list of phases with status}
**Merges completed:** {N}
**Deferred items captured:** {M}
**Checkpoints needing follow-up:** {K}

### Phase Summary
| Phase | Status | Plans | Duration |
|-------|--------|-------|----------|
| Phase {N} | Complete | {X}/{Y} | {duration} |
| Phase {M} | Failed (checkpoint saved) | {X}/{Y} | {duration} |

### Next Steps
{If checkpoints exist: "Review checkpoint files in .planning/phases/XX/ for failed phases"}
{If deferred items: "Review deferred-items.md files for captured ideas"}
{Suggest: /mow:progress for overview, /mow:resume-work to continue}

Worktrees preserved at .worktrees/ for inspection. Run `git worktree remove .worktrees/pNN` when no longer needed.
```
</step>

</process>
```

**2. Create `commands/mow/close-shop.md`:**

Follow the existing Claude Code command format with YAML frontmatter:

```yaml
---
name: close-shop
description: Gracefully shut down a multi-phase execution session. Saves context, handles pending merges, captures deferred items, and cleans up team.
allowed-tools: Read, Write, Edit, Bash, Grep, Glob, SendMessage, TaskList, TeamDelete
---
```

Body:
- Standard ??? help detection block (copy pattern from any existing command in commands/mow/)
- Load the close-shop workflow: `@~/.claude/mowism/workflows/close-shop.md`
- Execute it

**3. Create `mowism/help/close-shop.md`:**

Follow the existing help file format (# /mow:close-shop, one-liner, Usage, What Happens, Examples, Related):

```markdown
# /mow:close-shop

Gracefully shut down a multi-phase execution session.

## Usage

```
/mow:close-shop
```

No arguments needed. Operates on the current active multi-phase session.

## What Happens

1. Checks if any phase workers are still executing (offers to wait, pause, or cancel)
2. Merges completed phase branches into main
3. Captures deferred items and new context from worker STATUS.md files
4. Updates STATE.md with final phase statuses
5. Sends shutdown requests to all workers
6. Cleans up the Agent Teams team
7. Produces a final session report

Worktrees are NOT deleted -- they persist for inspection until manually removed.

## Examples

```
# After all phases complete
/mow:close-shop

# Works even if some phases failed (failed phases get checkpoint files)
/mow:close-shop
```

## Related

- `/mow:progress` -- view execution status
- `/mow:resume-work` -- resume from a previous session
- `/mow:team-status` -- view agent team activity
```
  </action>
  <verify>
Verify files exist: `ls mowism/workflows/close-shop.md commands/mow/close-shop.md mowism/help/close-shop.md`
Read close-shop.md workflow and verify it has 6 steps covering: check status, pending merges, capture context, update state, shutdown workers, report.
Read commands/mow/close-shop.md and verify YAML frontmatter with name, description, allowed-tools.
Read mowism/help/close-shop.md and verify it follows the standard help format.
  </verify>
  <done>
/mow:close-shop command exists with workflow, command file, and help file. Workflow covers all close-shop steps from the locked decision: checking workers, merging, capturing context, updating state, shutting down, reporting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update execute-phase.md for multi-phase mode awareness</name>
  <files>mowism/workflows/execute-phase.md</files>
  <action>
Update `mowism/workflows/execute-phase.md` to detect when it's being invoked in a multi-phase context and delegate appropriately.

**Add a `<step name="multi_phase_check">` after the existing `agent_teams_nudge` step and before `handle_branching`:**

This step detects whether the current invocation should use multi-phase mode:

```markdown
<step name="multi_phase_check">
**Check for multi-phase invocation context:**

Multi-phase mode is triggered when:
1. The `$ARGUMENTS` contain `--multi-phase` flag, OR
2. The invocation comes from a phase worker (detected by STATUS.md existence AND the current worktree being in `.worktrees/`)

**If multi-phase mode AND this is the main worktree (not a phase worker):**
- This means the user wants to execute multiple phases in parallel
- Delegate to the team lead orchestrator rather than running plans directly:
  ```
  Read and follow agents/mow-team-lead.md multi_phase_flow
  Present DAG analysis, let user select phases, spawn workers.
  ```
  After the team lead completes (all workers done + close-shop), return to offer_next.

**If this is a phase worker's worktree (.worktrees/pNN):**
- This is a normal single-phase execution inside a worktree
- Continue with the standard execute_waves flow
- But use the multi-agent state protocol (STATUS.md writes, skip STATE.md)
- The `multi_agent_detection` in init_context already handles this via STATUS.md existence

**If neither multi-phase flag nor worker worktree:**
- Standard single-phase execution (existing behavior, unchanged)
- Continue to handle_branching
</step>
```

**Also update the `<step name="offer_next">` step:**

After phase execution completes in multi-phase worker mode (detected by being in `.worktrees/pNN`):
- Do NOT offer auto-advance to next phase (the team lead manages phase sequencing)
- Do NOT update ROADMAP.md or REQUIREMENTS.md (the lead handles this after merge)
- Instead: signal phase complete via structured message (the phase worker agent handles this, but the workflow should not interfere)

Add this check at the top of offer_next:
```markdown
**If executing inside a phase worktree (.worktrees/pNN):**
Skip roadmap update, skip auto-advance, skip transition. The phase worker agent handles
phase-complete signaling. Return control to the phase worker.
```

**Update the `<step name="update_roadmap">` step:**

Add a guard at the top:
```markdown
**If executing inside a phase worktree (.worktrees/pNN):**
Skip ROADMAP.md and REQUIREMENTS.md updates. The lead handles these after merging
the phase branch. Only commit the VERIFICATION.md and phase-specific files.
Modify the commit to include only phase-specific files:
```bash
node ~/.claude/mowism/bin/mow-tools.cjs commit "docs(phase-{X}): complete phase execution" --files .planning/phases/{phase_dir}/*-VERIFICATION.md .planning/phases/{phase_dir}/*-STATUS.md
```
```

**Support pause-work signal:**

Add a note in the `<step name="execute_waves">` section that pause-work is supported:
- If the worker receives a pause signal (from lead or user), it:
  1. Finishes the current executor subagent (waits for it to complete or saves its state)
  2. Updates STATUS.md with current progress
  3. Stashes any uncommitted changes
  4. Writes checkpoint file
  5. Exits cleanly
  </action>
  <verify>
Read mowism/workflows/execute-phase.md and verify:
1. Contains `<step name="multi_phase_check">` after agent_teams_nudge
2. Multi-phase detection logic checks --multi-phase flag and .worktrees/ path
3. offer_next step has guard for worktree context (skip roadmap update + auto-advance)
4. update_roadmap step has guard for worktree context (skip global file updates)
5. Existing single-phase flow is preserved unchanged
  </verify>
  <done>
execute-phase.md detects multi-phase context and delegates to team lead or adjusts behavior for phase workers. Single-phase mode is preserved. Workers in worktrees skip global file updates (ROADMAP.md, REQUIREMENTS.md) to avoid merge conflicts. Pause-work signal support documented.
  </done>
</task>

</tasks>

<verification>
1. `/mow:close-shop` command exists and follows established command patterns
2. close-shop workflow covers all 6 steps from the locked decision
3. execute-phase.md detects multi-phase invocation and delegates to team lead
4. execute-phase.md in worker worktree skips global file updates
5. Pause-work support is documented in execute-phase.md
6. All changes are backward-compatible with existing single-phase execution
</verification>

<success_criteria>
- /mow:close-shop gracefully shuts down multi-phase sessions with context capture
- execute-phase.md routes correctly: --multi-phase -> team lead, .worktrees/ -> worker mode, default -> standard
- Phase workers in worktrees don't update ROADMAP.md or REQUIREMENTS.md (lead handles post-merge)
- Pause-work signal is supported
- Single-phase execution is completely unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/09-multi-phase-execution-engine/09-03-SUMMARY.md`
</output>
