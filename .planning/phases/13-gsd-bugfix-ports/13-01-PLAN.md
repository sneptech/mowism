---
phase: 13-gsd-bugfix-ports
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/mow-tools.cjs
autonomous: true
requirements:
  - BUG-01
  - BUG-02
  - BUG-04

must_haves:
  truths:
    - "STATE.md field values containing dollar signs ($100, $1, $$) are preserved exactly as written after state update/patch operations"
    - "Phase requirement IDs from ROADMAP.md are included in init function output for plan-phase, execute-phase, and phase-op operations"
    - "Progress bar percentage never exceeds 100% even when orphaned SUMMARY files exist without matching PLANs"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "Fixed state mutators, requirement ID extraction, progress clamping"
      contains: "(_, prefix) => prefix +"
  key_links:
    - from: "cmdStatePatch"
      to: "stateReplaceField"
      via: "callback replacer pattern"
      pattern: "\\(_, prefix\\) => prefix \\+"
    - from: "cmdInitPlanPhase"
      to: "extractPhaseRequirementIds"
      via: "function call"
      pattern: "extractPhaseRequirementIds"
---

<objective>
Fix three pure-code bugs in mow-tools.cjs: dollar sign corruption in state mutators (BUG-01), missing phase requirement ID propagation in init functions (BUG-02), and unclamped progress bar computation (BUG-04).

Purpose: These are the simplest, highest-confidence fixes -- all in a single file with clear-cut changes identified from GSD upstream. They form the foundation for subsequent bugfix plans.
Output: Updated mow-tools.cjs with safe state mutation, requirement ID extraction, and progress clamping.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bin/mow-tools.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix dollar sign corruption in state mutators (BUG-01)</name>
  <files>bin/mow-tools.cjs</files>
  <action>
Replace all 5 vulnerable `.replace(pattern, '$1${value}')` call sites with callback replacers that prevent dollar sign interpretation:

1. **cmdStatePatch** (~line 1955): Change `content.replace(pattern, '$1${value}')` to `content.replace(pattern, (_, prefix) => prefix + value)`
2. **cmdStateUpdate** (~line 1983): Change `content.replace(pattern, '$1${value}')` to `content.replace(pattern, (_, prefix) => prefix + value)`
3. **stateReplaceField** (~line 2006): Change `content.replace(pattern, '$1${newValue}')` to `content.replace(pattern, (_, prefix) => prefix + newValue)`
4. **cmdStateUpdateProgress** (~line 2104): Change `content.replace(progressPattern, '$1${progressStr}')` to `content.replace(progressPattern, (_, prefix) => prefix + progressStr)`
5. **cmdPhaseComplete** (~lines 4847, 4855-4857, 4865-4867): Review all `.replace()` calls in this function. The `checkboxPattern` replacement uses `$1x$2` which is intentional (not user data -- it's a fixed string 'x'). The `tablePattern` replacement uses `$1 Complete $2 ${today} $3` which is safe (today is a date string, not user data). The `planCountPattern` replacement uses `$1${summaryCount}/${planCount}...` which is safe (numbers). Do NOT change these -- they are hardcoded values, not user-provided. Only fix the 4 state mutator sites above.

**Test the fix:** After changing, verify that a value like "Costs $100 per month" survives a round-trip through `state update` and `state patch` without becoming "Costs 00 per month" or "Costs $1100 per month".

**What NOT to fix:** Do not touch `.replace()` calls where the replacement string contains only hardcoded values (dates, numbers, fixed strings). Only fix calls where user-provided field values are interpolated into replacement strings.
  </action>
  <verify>
Run: `node bin/mow-tools.cjs state update "Status" "Costs \$100" && node bin/mow-tools.cjs state get | grep -o "Costs.*"` -- should output "Costs $100" (not corrupted).
Run existing tests: `node bin/mow-tools.test.cjs` -- all tests pass.
  </verify>
  <done>All 4 state mutator .replace() calls use callback replacer form. Dollar signs in field values survive state update and patch operations.</done>
</task>

<task type="auto">
  <name>Task 2: Add requirement ID extraction and propagation to init functions (BUG-02)</name>
  <files>bin/mow-tools.cjs</files>
  <action>
Add a shared helper function `extractPhaseRequirementIds(cwd, phaseNum)` near the other phase utility functions (around the `getRoadmapPhaseInternal` area). The function should:

1. Call `getRoadmapPhaseInternal(cwd, phaseNum)` to get the phase section
2. If not found, return empty array
3. Match the line `**Requirements**:` (or `**Requirements:**`) in the section text
4. Strip brackets, split on commas/spaces, trim, and filter to match pattern `/^[A-Z]+-\d+$/`
5. Return the array of requirement ID strings

Then add `phase_requirement_ids` to the result object in these three init functions:

1. **cmdInitPlanPhase** (~line 5938): Add `phase_requirement_ids: extractPhaseRequirementIds(cwd, phase)` to the result object
2. **cmdInitExecutePhase** (~line 5861): Add `phase_requirement_ids: extractPhaseRequirementIds(cwd, phase)` to the result object
3. **cmdInitPhaseOp** (~line 6259): Add `phase_requirement_ids: extractPhaseRequirementIds(cwd, phase)` to the result object

Use a permissive regex that handles both `**Requirements**:` and `**Requirements:**` formats (the codebase already uses `(?:\\*\\*:|:\\*\\*)` alternation for this dual format).
  </action>
  <verify>
Run: `node bin/mow-tools.cjs init plan-phase 13 | grep -o '"phase_requirement_ids":\[[^]]*\]'` -- should output an array containing BUG-01 through BUG-11.
Run: `node bin/mow-tools.cjs init execute-phase 13 | grep -o '"phase_requirement_ids":\[[^]]*\]'` -- should output the same array.
Run existing tests: `node bin/mow-tools.test.cjs` -- all tests pass.
  </verify>
  <done>All three init functions include phase_requirement_ids in their JSON output, correctly parsed from ROADMAP.md.</done>
</task>

<task type="auto">
  <name>Task 3: Clamp progress bar computations to prevent RangeError (BUG-04)</name>
  <files>bin/mow-tools.cjs</files>
  <action>
Add `Math.min(100, ...)` clamping at each progress percentage computation site where orphaned files could cause >100%:

1. **cmdStateUpdateProgress** (~line 2096): Change `Math.round(totalSummaries / totalPlans * 100)` to `Math.min(100, Math.round(totalSummaries / totalPlans * 100))`
2. **cmdProgressRender** (~line 5527): Change `Math.round((totalSummaries / totalPlans) * 100)` to `Math.min(100, Math.round((totalSummaries / totalPlans) * 100))`
3. **Dashboard progress computation** (~line 638-649 area): Where percent is computed from `done/total` plan info fallback, add `Math.min(100, ...)` around the `Math.round((done / total) * 100)` call.

Also verify that `renderProgressBar` (line ~313) already clamps -- research says it does. If it does, leave it. If not, add clamping there too.

The `filled` variable computation (`Math.round(percent / 100 * barWidth)`) does NOT need clamping if `percent` is already clamped, but verify the `'\u2591'.repeat(barWidth - filled)` call cannot receive a negative argument. If `percent` is clamped to 100, then `filled` maxes at `barWidth`, making the repeat argument 0 (safe).
  </action>
  <verify>
Create a temporary test scenario (or inspect code) to confirm that if totalSummaries > totalPlans (orphaned SUMMARY files), percent stays at 100 and no RangeError is thrown from `String.repeat()`.
Run existing tests: `node bin/mow-tools.test.cjs` -- all tests pass.
  </verify>
  <done>All progress percentage computations are clamped to 100 maximum. Orphaned SUMMARY files cannot cause RangeError.</done>
</task>

</tasks>

<verification>
1. Run `node bin/mow-tools.test.cjs` -- all existing tests pass
2. Test dollar sign preservation: `state update` with a value containing `$100` survives
3. Test requirement ID extraction: `init plan-phase 13` includes `phase_requirement_ids` array
4. Test progress clamping: no RangeError possible when summaries > plans
</verification>

<success_criteria>
- All 4 state mutator `.replace()` calls use callback replacer form (no `$1` in replacement strings)
- `extractPhaseRequirementIds` helper exists and returns correct IDs for phase 13
- All 3 init functions include `phase_requirement_ids` in their output
- All progress computations are clamped with `Math.min(100, ...)`
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-gsd-bugfix-ports/13-01-SUMMARY.md`
</output>
