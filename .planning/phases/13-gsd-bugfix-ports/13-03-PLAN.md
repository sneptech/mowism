---
phase: 13-gsd-bugfix-ports
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/mowism/workflows/discuss-phase.md
  - ~/.claude/mowism/workflows/plan-phase.md
autonomous: true
requirements:
  - BUG-03
  - BUG-06
  - BUG-11

must_haves:
  truths:
    - "When branching_strategy is 'phase', a feature branch is created at discuss-phase start (not delayed until execute-phase)"
    - "plan-phase warns the user when no CONTEXT.md exists for the phase and offers to run discuss-phase first"
    - "discuss-phase detects ambiguous user answers ('maybe', 'not sure', 'either works') and probes with follow-up questions before accepting"
  artifacts:
    - path: "~/.claude/mowism/workflows/discuss-phase.md"
      provides: "Branch creation at discuss start, gray-area ambiguity detection with follow-up probing"
      contains: "branching_strategy"
    - path: "~/.claude/mowism/workflows/plan-phase.md"
      provides: "Warning when no CONTEXT.md exists"
      contains: "No CONTEXT.md found"
  key_links:
    - from: "discuss-phase.md init step"
      to: "git checkout -b"
      via: "branching_strategy check"
      pattern: "branching_strategy.*phase"
    - from: "discuss-phase.md probing step"
      to: "ambiguity detection"
      via: "regex match on ambiguous answers"
      pattern: "maybe|not sure|either"
---

<objective>
Fix three workflow bugs: early branch creation at discuss-phase (BUG-03), plan-phase context warning (BUG-06), and discuss-phase ambiguity probing (BUG-11).

Purpose: These fixes improve workflow ordering correctness and decision capture quality. All changes are in workflow markdown files (no mow-tools.cjs changes), making them parallel-safe with Plan 01.
Output: Updated discuss-phase.md and plan-phase.md workflow files.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@~/.claude/mowism/workflows/discuss-phase.md
@~/.claude/mowism/workflows/plan-phase.md
@~/.claude/mowism/workflows/execute-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feature branch at discuss-phase start and add workflow ordering guards (BUG-03, BUG-06)</name>
  <files>~/.claude/mowism/workflows/discuss-phase.md, ~/.claude/mowism/workflows/plan-phase.md</files>
  <action>
**Part A: BUG-03 -- Branch creation at discuss-phase start**

In `~/.claude/mowism/workflows/discuss-phase.md`, add a new step `handle_branching` after the `init_context` step (after init JSON is parsed, before `check_existing`).

The discuss-phase workflow currently reads init from `cmdInitPhaseOp`, which does NOT include branching info. Modify the step to:

1. Read the project config to check `branching_strategy`:
   ```bash
   BRANCH_CONFIG=$(node /home/max/.claude/mowism/bin/mow-tools.cjs state load 2>/dev/null | grep -o '"branching_strategy":"[^"]*"' || echo '')
   ```
   Or simpler: read `.planning/config.json` directly and extract `branching_strategy`.

2. If `branching_strategy` is `"phase"`:
   - Compute branch name from template: `mow/phase-{phase_number}-{phase_slug}` (using `phase_number` and `phase_slug` from init context)
   - Run: `git checkout -b "$BRANCH_NAME" 2>/dev/null || git checkout "$BRANCH_NAME"`
   - Log: "Created feature branch: $BRANCH_NAME"

3. If `branching_strategy` is `"milestone"` or `"none"`: Skip (milestone branches are created at milestone level, not phase level).

This ensures the branch exists before any phase work begins, not delayed until execute-phase.

**Part B: BUG-06 -- Plan-phase context warning (already partially implemented)**

In `~/.claude/mowism/workflows/plan-phase.md`, the warning already exists at section "4. Honor User Decisions" (lines ~60-74). It uses `AskUserQuestion` when `context_content` is null. Verify this is working correctly.

Review the existing implementation and confirm:
1. It checks `context_content` (not `has_context` boolean) -- because `context_content` comes from `--include context` in the init call
2. The warning message is clear and offers both "Continue without context" and "Run discuss-phase first" options
3. If "Run discuss-phase first" is selected, it displays the command and exits

If the implementation is already correct, note it in the SUMMARY. If any aspect is missing or weak, fix it.

For the discuss-phase side of BUG-06 (warn if plans exist): This is already implemented at `check_existing` step (lines ~130-167). Verify it checks `has_plans` and `plan_count`. If working correctly, note it. If not, fix.
  </action>
  <verify>
1. Read discuss-phase.md and confirm `handle_branching` step exists after init, before check_existing
2. Read plan-phase.md and confirm context warning is present and functional
3. Read discuss-phase.md and confirm has_plans check is present in check_existing step
  </verify>
  <done>Feature branch created at discuss-phase start when branching_strategy is "phase". Plan-phase warns when no CONTEXT.md exists. Discuss-phase warns when plans already exist.</done>
</task>

<task type="auto">
  <name>Task 2: Add gray-area ambiguity detection to discuss-phase probing (BUG-11)</name>
  <files>~/.claude/mowism/workflows/discuss-phase.md</files>
  <action>
In `~/.claude/mowism/workflows/discuss-phase.md`, enhance the probing step (the area where follow-up questions are asked, around lines 244-293 in the probe_area step).

The current flow asks 4 questions per area, then checks if the user wants "More questions" or "Next area". The fix adds ambiguity detection WITHIN each question response.

Add a new instruction block after the existing probing instructions (inside the probe_area step or as a subsection):

```markdown
**Ambiguity Detection:**

After EACH user response to a probing question, check for ambiguous answers before accepting:

Ambiguous patterns (case-insensitive):
- "maybe", "perhaps", "possibly"
- "not sure", "unsure", "I don't know", "idk"
- "either works", "either way", "both are fine", "doesn't matter"
- "whatever you think", "up to you", "your call"
- "I guess", "suppose so"

**When ambiguity detected:**

Do NOT record the answer as a decision. Instead:

1. Acknowledge: "That's a gray area worth clarifying."
2. Reframe as a concrete trade-off: "Let me put it this way: [Option A] means [concrete consequence]. [Option B] means [different consequence]. Which trade-off do you prefer?"
3. If the user remains ambiguous after reframing, record as **Claude's Discretion** (not a locked decision): "User deferred to Claude's judgment: [area]. Claude will choose [reasonable default] during planning."

**What NOT to do:**
- Do not loop indefinitely on ambiguous answers (one reframe attempt, then defer to discretion)
- Do not treat "I don't have a strong preference" as ambiguous -- that IS a decision (defer to Claude)
- Do not probe on implementation details that are clearly Claude's domain (architecture, code patterns)

This ensures CONTEXT.md captures real decisions (not "maybe" placeholders) while respecting the user's time.
```

Place this instruction block logically within the existing probing flow -- after the question-asking instructions but before the "More questions / Next area" check.
  </action>
  <verify>
1. Read discuss-phase.md and confirm ambiguity detection instructions are present
2. Verify the instruction includes the pattern list, reframing behavior, and discretion fallback
3. Verify it does not create infinite loops (one reframe, then defer)
  </verify>
  <done>Discuss-phase detects ambiguous answers and probes with concrete trade-off reframing before recording decisions. Single-reframe limit prevents loops.</done>
</task>

</tasks>

<verification>
1. discuss-phase.md contains handle_branching step with branching_strategy check
2. discuss-phase.md contains ambiguity detection instructions in probing flow
3. plan-phase.md has context warning (verify existing implementation)
4. No mow-tools.cjs changes (parallel-safe with Plan 01)
</verification>

<success_criteria>
- discuss-phase.md has branch creation step for "phase" branching strategy
- plan-phase.md warns and offers options when no CONTEXT.md exists
- discuss-phase.md warns when plans already exist (verify existing)
- discuss-phase.md detects ambiguous answers and reframes as concrete trade-offs
- All workflow files are valid markdown with correct step structure
</success_criteria>

<output>
After completion, create `.planning/phases/13-gsd-bugfix-ports/13-03-SUMMARY.md`
</output>
