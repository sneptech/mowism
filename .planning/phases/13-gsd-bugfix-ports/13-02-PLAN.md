---
phase: 13-gsd-bugfix-ports
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - bin/mow-tools.cjs
  - ~/.claude/agents/mow-executor.md
autonomous: true
requirements:
  - BUG-07
  - BUG-05

must_haves:
  truths:
    - "/mow:health --repair creates a timestamped backup of STATE.md, ROADMAP.md, and REQUIREMENTS.md in .planning/backups/ before regenerating STATE.md"
    - "After --repair, a diff between old and new STATE.md is shown to the user"
    - "Executor stops retrying a failing task after a configurable maximum attempt limit and records it as a deferred issue"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "createPlanningBackup function, backup-before-repair logic, executor retry config"
      contains: "createPlanningBackup"
    - path: "~/.claude/agents/mow-executor.md"
      provides: "Executor retry limit enforcement instructions with config reference"
      contains: "max_task_attempts"
  key_links:
    - from: "cmdValidateHealth"
      to: "createPlanningBackup"
      via: "function call before repair"
      pattern: "createPlanningBackup\\(cwd\\)"
    - from: "mow-executor.md"
      to: "config.json"
      via: "max_task_attempts config read"
      pattern: "max_task_attempts"
---

<objective>
Add backup-before-repair safety to /mow:health --repair (BUG-07) and configurable executor retry limits (BUG-05).

Purpose: Prevent data loss during health repairs and prevent infinite executor retry loops. Both are safety guardrails for daily use reliability.
Output: Updated mow-tools.cjs with backup function and config, updated mow-executor.md with enforcement instructions.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bin/mow-tools.cjs
@~/.claude/agents/mow-executor.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backup-before-repair and diff display to /mow:health --repair (BUG-07)</name>
  <files>bin/mow-tools.cjs</files>
  <action>
Add a `createPlanningBackup(cwd)` function near the health validation section of mow-tools.cjs. The function should:

1. Create a timestamped directory at `.planning/backups/{ISO-timestamp}/` (replace colons with dashes in timestamp for filesystem safety, strip milliseconds)
2. Use `fs.mkdirSync(backupDir, { recursive: true })`
3. Copy `STATE.md`, `ROADMAP.md`, and `REQUIREMENTS.md` from `.planning/` to the backup directory (skip any that don't exist)
4. Count total backup directories in `.planning/backups/`
5. Return `{ dir: backupDir, files: backedUpFileNames, total_backups: count }`

Then modify `cmdValidateHealth` (the repair section starting ~line 5421):

**Before the `for (const repair of repairs)` loop:**
1. Call `createPlanningBackup(cwd)` and store the result
2. Add the backup info to `repairActions`: `repairActions.push({ action: 'backup', success: true, dir: backupResult.dir, files: backupResult.files })`
3. If `backupResult.total_backups >= 5`, add a suggestion to the output: include `cleanup_suggestion: "5+ backups exist in .planning/backups/. Consider running /mow:cleanup to manage disk usage."` in the final health output

**After the `regenerateState` repair case (where STATE.md is rewritten):**
1. Read the old STATE.md from the backup directory
2. Read the new STATE.md from `.planning/STATE.md`
3. Compute a simple line-by-line diff: for each line that differs between old and new, record it as `{ line: N, old: "...", new: "..." }`
4. Add the diff to the repair action result: `repairActions.push({ action: 'regenerateState', success: true, diff_lines: diffResult })`
5. Format the diff for human-readable output (not just JSON): prepend lines with `-` for removed and `+` for added

**Per user decision:** Backups are never auto-deleted. The cleanup suggestion is informational only.
  </action>
  <verify>
1. Create a deliberately corrupt STATE.md (remove a required field), then run `node bin/mow-tools.cjs health --repair`
2. Verify `.planning/backups/` contains a timestamped directory with STATE.md, ROADMAP.md, and REQUIREMENTS.md
3. Verify the repair output includes diff information showing what changed
4. Run existing tests: `node bin/mow-tools.test.cjs` -- all tests pass
  </verify>
  <done>health --repair creates backup before regeneration, shows diff of changes, and suggests cleanup when 5+ backups exist.</done>
</task>

<task type="auto">
  <name>Task 2: Add configurable executor retry limit with warn-then-block behavior (BUG-05)</name>
  <files>bin/mow-tools.cjs, ~/.claude/agents/mow-executor.md</files>
  <action>
**Part A: Add config default in mow-tools.cjs**

In the config defaults section of mow-tools.cjs (the `loadConfig` function or wherever defaults are established), add:
- `executor: { max_task_attempts: 5 }` as a new config key (nested under `executor` object for namespace cleanliness)

In `cmdInitExecutePhase`, include the executor config in the result object:
- `max_task_attempts: config.executor?.max_task_attempts ?? 5`

This makes the limit visible to the executor agent via init context.

**Part B: Strengthen executor agent instructions**

In `~/.claude/agents/mow-executor.md`, update the FIX ATTEMPT LIMIT section (~lines 149-153) to reference the configurable limit:

Replace the current soft guidance with enforcement-grade instructions:

```
**FIX ATTEMPT LIMIT (ENFORCED):**
Track auto-fix attempts per task using a counter variable. The limit is provided via init context as `max_task_attempts` (default: 5).

- **At attempt 3 (warn):** Print a prominent warning: "Task [name]: 3 fix attempts used. [max_task_attempts - 3] remaining before task is deferred."
- **At max_task_attempts (block):** STOP fixing this task immediately.
  1. Document remaining issues in SUMMARY.md under "## Deferred Issues" with: task name, error description, attempts made, last error output
  2. Continue to the next task
  3. Do NOT restart the build or retry

This is a HARD limit, not guidance. Violating it wastes context window budget and risks infinite loops.
```

**Per user decision:** Claude's discretion on warn-vs-block. Decision: warn at 3, hard-block at max_task_attempts (default 5).
  </action>
  <verify>
1. Run `node bin/mow-tools.cjs init execute-phase 13 | grep max_task_attempts` -- should output 5
2. Check `~/.claude/agents/mow-executor.md` contains "FIX ATTEMPT LIMIT (ENFORCED)" section
3. Run existing tests: `node bin/mow-tools.test.cjs` -- all tests pass
  </verify>
  <done>Executor has configurable max_task_attempts (default 5) in config, propagated via init, and enforced in agent instructions with warn-at-3 and block-at-max behavior.</done>
</task>

</tasks>

<verification>
1. Run `node bin/mow-tools.test.cjs` -- all existing tests pass
2. health --repair creates backup before regeneration
3. init execute-phase includes max_task_attempts
4. Executor agent has enforced retry limit instructions
</verification>

<success_criteria>
- `createPlanningBackup` function exists and copies STATE.md + ROADMAP.md + REQUIREMENTS.md
- health --repair calls createPlanningBackup before any repair action
- Diff between old and new STATE.md is shown after regeneration
- Cleanup suggestion appears when 5+ backups exist
- max_task_attempts defaults to 5 in config
- init execute-phase includes max_task_attempts in output
- mow-executor.md has enforced fix attempt limit section
</success_criteria>

<output>
After completion, create `.planning/phases/13-gsd-bugfix-ports/13-02-SUMMARY.md`
</output>
