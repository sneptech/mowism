---
phase: 10-live-feedback-and-visual-differentiation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/mow-tools.cjs
  - bin/mow-tools.test.cjs
autonomous: true
requirements: [FEED-01, FEED-03]

must_haves:
  truths:
    - "Message schema v2 validates all 13 event types (7 existing + 6 new checkpoint types)"
    - "256-color ANSI helper functions produce correct escape codes and respect NO_COLOR/FORCE_COLOR"
    - "Banner rendering produces full-width colored bars for orchestrator (red) and workers (phase-hashed 256-color)"
    - "Progress bar renders with full block and medium shade fill characters for active/blocked states"
    - "Caution stripe error banner renders alternating yellow/black with warning symbols"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "256-color helpers, message schema v2, banner/progress renderers"
      contains: "MESSAGE_SCHEMA_VERSION = 2"
    - path: "bin/mow-tools.test.cjs"
      provides: "Tests for new schema types, color helpers, banner rendering"
  key_links:
    - from: "bin/mow-tools.cjs"
      to: "MESSAGE_REQUIRED_FIELDS"
      via: "Schema v2 adds task_claimed, commit_made, task_complete, stage_transition, input_needed, plan_created"
      pattern: "task_claimed.*commit_made.*task_complete.*stage_transition.*input_needed.*plan_created"
    - from: "bin/mow-tools.cjs"
      to: "PHASE_PALETTE"
      via: "12-color curated 256-color palette with foreground contrast mapping"
      pattern: "PHASE_PALETTE"
---

<objective>
Implement the visual and messaging foundation for Phase 10: ANSI 256-color helper functions, curated phase color palette, message schema v2 with 6 new checkpoint types, full-width banner renderer for orchestrator/workers, progress bar renderer with active/blocked states, and caution stripe error banner.

Purpose: All downstream dashboard rendering, event log coloring, and agent wiring depends on these display primitives and schema extensions existing in mow-tools.cjs.
Output: Extended mow-tools.cjs with new constants, helpers, and subcommands; extended test suite.
</objective>

<execution_context>
@/home/max/.claude/mowism/workflows/execute-plan.md
@/home/max/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-live-feedback-and-visual-differentiation/10-RESEARCH.md
@.planning/phases/07-state-coherence-foundation/07-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 256-color helpers, phase palette, and extend message schema to v2</name>
  <files>bin/mow-tools.cjs</files>
  <action>
  **1. Add 256-color ANSI helper functions** near the existing Message Protocol Schema section (around line 182):

  Add a new section `// --- ANSI 256-Color Helpers ---` with:

  - `supportsColor()` -- returns `'none'`, `'16'`, or `'256'` based on:
    - `process.env.NO_COLOR !== undefined` -> `'none'`
    - `process.env.FORCE_COLOR !== undefined` -> `'256'`
    - `!process.stdout.isTTY` -> `'none'`
    - `process.env.TERM` includes `'256color'` or `'truecolor'` -> `'256'`
    - Otherwise -> `'16'`
  - `color256fg(n, text)` -- wraps text in `\x1b[38;5;${n}m...\x1b[39m` if color supported
  - `color256bg(n, text)` -- wraps text in `\x1b[48;5;${n}m...\x1b[49m` if color supported
  - `color256(fg, bg, text)` -- wraps text in `\x1b[38;5;${fg}m\x1b[48;5;${bg}m...\x1b[0m` if color supported

  **2. Add curated 12-color phase palette** (per research recommendation):

  ```javascript
  const PHASE_PALETTE = [33, 37, 71, 142, 166, 133, 44, 172, 63, 108, 175, 39];
  const PHASE_PALETTE_FG = [231, 231, 16, 16, 16, 231, 16, 16, 231, 16, 16, 16];
  ```

  - `phaseColor(phaseNumber)` -- returns `{ bg: PHASE_PALETTE[n % 12], fg: PHASE_PALETTE_FG[n % 12] }` where n is `Math.floor(parseFloat(phaseNumber))`

  **3. Add INPUT_TYPES constant** for input routing granularity (locked decision):

  ```javascript
  const INPUT_TYPES = ['discussion_prompt', 'permission_prompt', 'error_resolution', 'worker_failed', 'verification_question', 'planning_approval'];
  ```

  **4. Extend message schema to v2:**

  - Bump `MESSAGE_SCHEMA_VERSION` from 1 to 2
  - Add 6 new entries to `MESSAGE_REQUIRED_FIELDS`:
    - `task_claimed: ['phase', 'plan', 'task']`
    - `commit_made: ['phase', 'plan', 'commit_hash']`
    - `task_complete: ['phase', 'plan', 'task']`
    - `stage_transition: ['phase', 'from_stage', 'to_stage']`
    - `input_needed: ['phase', 'input_type', 'detail']`
    - `plan_created: ['phase', 'plan']`
  - Add all 6 new types to the `ENABLED_EVENTS` array
  - In `cmdMessageFormat`: add optional `activity` field handling -- if `fields.activity` exists (string, max 40 chars), include it in the output message JSON. Truncate to 40 chars silently.
  - In `cmdMessageParse`: handle v2 messages. Existing v1 parsing still works (backward compatible). For v2, validate the new types. The `activity` field is optional -- do not error if missing.
  - In `cmdMessageFormat`: for `input_needed` type, validate that `fields.input_type` is in the `INPUT_TYPES` array. Emit a warning (not error) to stderr if not recognized but still format the message.

  **5. Add CONFIG_DEFAULTS for feedback settings:**

  In the existing `CONFIG_DEFAULTS` object, add:
  ```javascript
  feedback: {
    terminal_bell: false,
    dashboard_redraw: false,
    event_log_count: 6,
  }
  ```
  </action>
  <verify>
  Run the test suite: `node bin/mow-tools.test.cjs 2>&1 | tail -5` -- all existing tests pass (zero regressions).
  Run: `node bin/mow-tools.cjs message format task_claimed --phase 10 --plan 10-01 --task 3 --raw` -- produces valid JSON with `v: 2` and `type: task_claimed`.
  Run: `node bin/mow-tools.cjs message format input_needed --phase 10 --input-type permission_prompt --detail "Bash: npm test" --raw` -- produces valid JSON.
  Run: `node bin/mow-tools.cjs message parse '{"v":2,"type":"commit_made","phase":10,"plan":"10-01","commit_hash":"abc1234","ts":"2026-01-01T00:00:00Z"}' --raw` -- parses successfully.
  </verify>
  <done>MESSAGE_SCHEMA_VERSION is 2, all 13 event types validate, 256-color helpers exist, phase palette returns correct colors, INPUT_TYPES constant exists, activity field handled in format/parse, feedback config defaults added.</done>
</task>

<task type="auto">
  <name>Task 2: Add banner renderer, progress bar, caution stripe, and format subcommands</name>
  <files>bin/mow-tools.cjs</files>
  <action>
  **1. Add `renderBanner(text, bgColor, fgColor, width)` function:**

  - `width` defaults to `process.stdout.columns || 80`
  - Creates a full-width padded text line: `' ' + text + ' '` then `.padEnd(width)`
  - If `supportsColor() === '256'`: apply `\x1b[48;5;${bgColor}m\x1b[38;5;${fgColor}m\x1b[1m` prefix, `\x1b[0m` suffix
  - If `supportsColor() === '16'`: use `util.styleText(['bold', 'inverse'], paddedText)` as a fallback (try/catch)
  - If `'none'`: return plain padded text

  **2. Add `renderCautionBanner(text, width)` function:**

  - Renders alternating yellow/black striped banner with warning symbols on each side
  - Yellow: `\x1b[48;5;226m\x1b[38;5;0m`, Black: `\x1b[48;5;0m\x1b[38;5;226m`
  - Centers text within the stripe
  - Brackets with `\u26A0` (warning symbol)
  - Falls back to plain text when colors not supported

  **3. Add `renderProgressBar(percent, width, isBlocked, colorCode)` function:**

  - `percent`: 0-100
  - `width`: number of fill characters (default 10)
  - `isBlocked`: if true, use `\u2592` (medium shade) instead of `\u2588` (full block)
  - Empty char: `\u2591` (light shade)
  - Returns `[${bar}]` (brackets included)
  - If `colorCode` provided and 256-color supported, tint the fill characters with `color256fg(colorCode, fillChars)`

  **4. Add CLI subcommands for rendering:**

  Add `case 'format':` to the CLI switch in the routing section:

  - `format banner --text <text> [--bg <n>] [--fg <n>] [--width <n>]` -- renders banner to stdout. If `--bg`/`--fg` not provided, use orchestrator defaults (bg=196, fg=231).
  - `format banner-phase --phase <n> [--text <text>] [--width <n>]` -- renders worker banner using `phaseColor(n)`. If no text, generates `PHASE {N}: {name}` from the phase number.
  - `format banner-error --text <text> [--width <n>]` -- renders caution stripe banner.
  - `format progress --percent <n> [--width <n>] [--blocked] [--color <n>]` -- renders progress bar.

  Each subcommand outputs the rendered string directly to stdout (not JSON-wrapped) for easy use in Bash echo/printf. In `--raw` mode, output a JSON object with `{ rendered: "..." }`.
  </action>
  <verify>
  Run: `FORCE_COLOR=1 node bin/mow-tools.cjs format banner --text "MOW ORCHESTRATOR" --bg 196 --fg 231` -- outputs red banner.
  Run: `FORCE_COLOR=1 node bin/mow-tools.cjs format banner-phase --phase 10` -- outputs phase-colored banner.
  Run: `FORCE_COLOR=1 node bin/mow-tools.cjs format banner-error --text "PHASE 10: ERROR"` -- outputs caution stripe.
  Run: `FORCE_COLOR=1 node bin/mow-tools.cjs format progress --percent 75 --width 10` -- outputs `[███████░░░]` (approximate).
  Run: `FORCE_COLOR=1 node bin/mow-tools.cjs format progress --percent 30 --blocked --width 10` -- outputs `[▒▒▒░░░░░░░]` (approximate).
  Existing tests still pass: `node bin/mow-tools.test.cjs 2>&1 | tail -5`.
  </verify>
  <done>Banner renderer produces full-width colored bars, caution stripe uses alternating yellow/black, progress bar supports active/blocked fill characters, all format subcommands accessible via CLI.</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for schema v2, color helpers, and format subcommands</name>
  <files>bin/mow-tools.test.cjs</files>
  <action>
  Add a new test section `// --- Phase 10: Visual Feedback Tests ---` to the test file. Tests:

  **Message schema v2 tests (7 tests):**
  1. `message format task_claimed` produces valid JSON with v:2 and required fields
  2. `message format commit_made` includes commit_hash field
  3. `message format task_complete` produces valid JSON with phase, plan, and task fields
  4. `message format input_needed` validates input_type against INPUT_TYPES (warn on unknown, still produce output)
  5. `message format plan_created` includes phase and plan
  6. `message parse` accepts v2 messages with new types
  7. `message format` with `--activity "Implementing dashboard"` includes activity field truncated to 40 chars

  **Color helper tests (4 tests):**
  8. `format banner` with FORCE_COLOR=1 produces ANSI escape codes in output
  9. `format banner` with NO_COLOR=1 produces plain text (no escape codes)
  10. `format banner-phase --phase 10` uses phase palette color (not red)
  11. `format progress --percent 50 --width 10` produces bar with 5 fill chars and 5 empty chars

  **Caution stripe test (1 test):**
  12. `format banner-error` with FORCE_COLOR=1 contains warning symbol `\u26A0` and yellow ANSI code `48;5;226`

  For tests that need color output, use `spawnSync` with `env: { ...process.env, FORCE_COLOR: '1' }` to ensure colors are emitted.
  For NO_COLOR tests, use `env: { ...process.env, NO_COLOR: '1' }` and verify output contains NO `\x1b[` sequences.

  Total: 12 new tests.
  </action>
  <verify>
  Run `node bin/mow-tools.test.cjs 2>&1 | tail -5` -- all tests pass, including the 12 new tests.
  Check test count increased by 12 from baseline.
  </verify>
  <done>12 new tests pass covering message schema v2 (including task_complete), color helpers, banner rendering, progress bar, and caution stripe. Zero regressions on existing tests.</done>
</task>

</tasks>

<verification>
1. All existing tests pass with zero regressions: `node bin/mow-tools.test.cjs`
2. Schema v2 round-trip: format a `task_claimed` message, parse it back, verify all fields preserved
3. Color degradation: run `format banner` with NO_COLOR=1, verify no escape codes in output
4. Progress bar edge cases: 0% shows all empty, 100% shows all full, blocked mode uses medium shade
5. Phase color determinism: `phaseColor(10)` returns the same color on repeated calls
</verification>

<success_criteria>
- MESSAGE_SCHEMA_VERSION is 2
- All 13 event types (7 old + 6 new) validate in format and parse
- 256-color helper functions are exported and testable
- Phase palette maps phase numbers to distinct, non-red colors
- Banner, progress bar, and caution stripe renderers produce correct ANSI output
- `format` CLI subcommands work from the command line
- 12+ new tests pass
- Zero regressions on existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/10-live-feedback-and-visual-differentiation/10-01-SUMMARY.md`
</output>
