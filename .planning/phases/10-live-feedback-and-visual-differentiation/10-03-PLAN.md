---
phase: 10-live-feedback-and-visual-differentiation
plan: 03
type: execute
wave: 3
depends_on: ["10-01", "10-02"]
files_modified:
  - agents/mow-team-lead.md
  - agents/mow-phase-worker.md
autonomous: true
requirements: [FEED-01, FEED-02, FEED-03, FEED-04]

must_haves:
  truths:
    - "Team lead renders dashboard after processing each worker message"
    - "Team lead displays input routing notifications when workers send input_needed messages"
    - "Phase workers print a color-coded full-width banner at startup"
    - "Phase workers send the 5 new checkpoint message types at defined milestones"
    - "Phase workers print 'Orchestrator notified -- waiting for input' when sending input_needed"
    - "Phase workers print a context recap when resuming after input"
    - "Phase workers echo phase context before Bash permission prompts"
  artifacts:
    - path: "agents/mow-team-lead.md"
      provides: "Dashboard rendering integration and extended message handling for 12 event types"
      contains: "dashboard render"
    - path: "agents/mow-phase-worker.md"
      provides: "Banner printing, extended milestone messaging with 8 checkpoint types, input wait confirmation, context recap"
      contains: "format banner-phase"
  key_links:
    - from: "agents/mow-team-lead.md"
      to: "bin/mow-tools.cjs dashboard render"
      via: "Lead calls dashboard render after each message processing"
      pattern: "dashboard render"
    - from: "agents/mow-team-lead.md"
      to: "bin/mow-tools.cjs dashboard event add"
      via: "Lead appends events for each worker message received"
      pattern: "dashboard event add"
    - from: "agents/mow-phase-worker.md"
      to: "bin/mow-tools.cjs message format"
      via: "Worker sends new checkpoint types (task_claimed, commit_made, stage_transition, input_needed, plan_created)"
      pattern: "message format (task_claimed|commit_made|stage_transition|input_needed|plan_created)"
    - from: "agents/mow-phase-worker.md"
      to: "bin/mow-tools.cjs format banner-phase"
      via: "Worker prints phase-colored banner at initialization"
      pattern: "format banner-phase"
---

<objective>
Wire the dashboard renderer and extended message types into the team lead orchestrator and phase worker agents. The lead renders the dashboard after processing each worker message and displays input routing notifications. Workers print startup banners, send the new checkpoint message types, confirm input waits, and print context recaps.

Purpose: This is the integration layer that connects the display primitives (Plans 01-02) to the agent workflows. Without this wiring, the CLI tools exist but are never called.
Output: Updated mow-team-lead.md and mow-phase-worker.md with full Phase 10 visual feedback integration.
</objective>

<execution_context>
@/home/max/.claude/mowism/workflows/execute-plan.md
@/home/max/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-live-feedback-and-visual-differentiation/10-RESEARCH.md
@.planning/phases/10-live-feedback-and-visual-differentiation/10-01-SUMMARY.md
@.planning/phases/10-live-feedback-and-visual-differentiation/10-02-SUMMARY.md
@.planning/phases/09-multi-phase-execution-engine/09-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update mow-team-lead.md with dashboard rendering and extended message handling</name>
  <files>agents/mow-team-lead.md</files>
  <action>
  **1. Add orchestrator banner at team creation:**

  In both `<multi_phase_flow>` Step 2 and `<single_phase_flow>` Step 2 (after TeamCreate), add:
  ```bash
  node ~/.claude/mowism/bin/mow-tools.cjs format banner --text "MOW ORCHESTRATOR" --bg 196 --fg 231
  ```
  Print the banner once at startup. This is the red full-width bar that identifies this terminal as the orchestrator.

  **2. Add dashboard rendering to message processing flow:**

  In `<message_processing>`, after the existing "Handle by Event Type" table, add a new subsection:

  ```markdown
  ### Render Dashboard

  After processing any worker message, render the live dashboard:

  1. Append event to dashboard log:
     \`\`\`bash
     node ~/.claude/mowism/bin/mow-tools.cjs dashboard event add --type "{event_type}" --phase {phase} --detail "{brief_detail}"
     \`\`\`

  2. Render the dashboard:
     \`\`\`bash
     node ~/.claude/mowism/bin/mow-tools.cjs dashboard render
     \`\`\`

  Call `dashboard render` as the FINAL command in your message-processing sequence so the dashboard is the bottom-most terminal output.
  ```

  **3. Expand the message processing event type table:**

  Add rows for the 5 new v2 event types:

  | Event Type | Action |
  |-----------|--------|
  | `task_claimed` | Informational -- append to dashboard events. No state update needed. |
  | `commit_made` | Informational -- append to dashboard events with commit hash in detail. |
  | `stage_transition` | Update Active Phases activity field: `state update-phase-row {phase} --last-update "{ts}"`. Append to dashboard events. |
  | `input_needed` | **Input routing:** Append to dashboard events (auto-pins notification). Notify user: the dashboard will show which phase terminal needs attention. Do NOT send a message to the worker -- it is already waiting. |
  | `plan_created` | Informational -- append to dashboard events. |

  **4. Update input routing notification handling in multi-phase flow:**

  In `<multi_phase_flow>` Step 5, update the `blocker` handler and add `input_needed` handling:

  For `input_needed` messages (new, more granular than `blocker`):
  - The dashboard auto-pins the notification (done by `dashboard event add` auto-pin logic)
  - The dashboard render will show the pinned notification with the phase color
  - The lead does NOT need to manually notify the user -- the dashboard is the notification
  - The lead does NOT send anything to the worker -- the worker is waiting in its terminal
  - When the worker resumes (sends any subsequent message), the pin auto-dismisses

  For `blocker` messages (existing, still supported as fallback):
  - Same behavior as before, plus append to dashboard events

  **5. Add dashboard cleanup to close-shop:**

  In `<multi_phase_flow>` Step 8 (Close-Shop), after committing `.planning/` changes and before sending shutdown requests, add:
  ```bash
  node ~/.claude/mowism/bin/mow-tools.cjs dashboard clear
  ```

  **6. Add dashboard cleanup to single-phase completion:**

  In `<single_phase_flow>` Step 8 (Completion), before team cleanup, add:
  ```bash
  node ~/.claude/mowism/bin/mow-tools.cjs dashboard clear
  ```
  </action>
  <verify>
  Read agents/mow-team-lead.md and verify:
  1. `format banner` call exists in both multi_phase_flow Step 2 and single_phase_flow Step 2
  2. `dashboard render` call exists in message_processing section
  3. `dashboard event add` call exists in message_processing section
  4. All 12 event types are listed in the message processing table
  5. `input_needed` handler describes auto-pin behavior and no-send-to-worker constraint
  6. `dashboard clear` exists in both close-shop and single-phase completion
  </verify>
  <done>Team lead renders dashboard after every worker message, displays input routing via pinned notifications, prints orchestrator banner at startup, handles all 12 event types, cleans up dashboard state on shutdown.</done>
</task>

<task type="auto">
  <name>Task 2: Update mow-phase-worker.md with banners, extended milestones, and input routing</name>
  <files>agents/mow-phase-worker.md</files>
  <action>
  **1. Add startup banner to Step 1 (Initialize):**

  After the `cd {worktree_path}` command in Step 1, add:
  ```bash
  node ~/.claude/mowism/bin/mow-tools.cjs format banner-phase --phase {phase_number}
  ```
  Print the phase-colored full-width banner once at initialization. This identifies the terminal visually.

  **2. Expand the messaging protocol with new checkpoint types:**

  In `<messaging_protocol>`, expand the milestone table from 5 to 8 checkpoint types:

  | Milestone | Message Type | When | Content |
  |-----------|-------------|------|---------|
  | Plan started | `plan_started` | Before spawning executor for a plan | Phase number, plan ID |
  | Plan complete | `plan_complete` | After executor completes and SUMMARY verified | Phase, plan, commit hash, duration |
  | Phase complete | `phase_complete` | After all plans have SUMMARY.md | Phase, plans completed, total duration |
  | Error | `error` | On executor failure | Phase, plan, error description |
  | Blocker | `blocker` | When user input needed (discuss-phase, checkpoint) | Phase, what's needed, action |
  | Task claimed | `task_claimed` | When claiming a task from the task list before starting work | Phase, plan, task name |
  | Commit made | `commit_made` | After each atomic task commit | Phase, plan, commit hash only (no message) |
  | Stage transition | `stage_transition` | When moving between lifecycle stages | Phase, from_stage, to_stage |
  | Input needed | `input_needed` | When blocked waiting for user input (permission prompt, UAT) | Phase, input_type, detail |
  | Plan created | `plan_created` | When plan files are written (after planning) | Phase, plan ID |

  Add the `--activity` flag to ALL message format calls. Include a short description (max 40 chars) of what the worker is currently doing. Examples:
  - `--activity "Planning phase 10"` (during planning)
  - `--activity "Executing 10-01 task 2"` (during execution)
  - `--activity "Verifying plan completeness"` (during verification)

  **3. Wire new checkpoint messages into lifecycle steps:**

  In `<lifecycle>` Step 3 (Planning), after plan files are created:
  ```bash
  MSG=$(node ~/.claude/mowism/bin/mow-tools.cjs message format plan_created --phase {phase} --plan "{plan_id}" --activity "Planning complete" --raw)
  ```
  Send to lead.

  In `<lifecycle>` Step 4 (Execute Plans), when claiming a task:
  ```bash
  MSG=$(node ~/.claude/mowism/bin/mow-tools.cjs message format task_claimed --phase {phase} --plan {plan_id} --task "{task_name}" --activity "Executing {task_name}" --raw)
  ```
  Send to lead.

  After each executor commit (in the plan completion spot-check):
  ```bash
  HASH=$(git log -1 --format=%h)
  MSG=$(node ~/.claude/mowism/bin/mow-tools.cjs message format commit_made --phase {phase} --plan {plan_id} --commit-hash "$HASH" --activity "Committed $HASH" --raw)
  ```
  Send to lead.

  When transitioning between lifecycle stages (e.g., from planning to execution):
  ```bash
  MSG=$(node ~/.claude/mowism/bin/mow-tools.cjs message format stage_transition --phase {phase} --from-stage discussing --to-stage planning --activity "Transitioning to planning" --raw)
  ```
  Send to lead. Add stage_transition messages at each major transition: discussing -> planning, planning -> executing, executing -> verifying.

  **4. Add input_needed message and wait confirmation:**

  In `<lifecycle>` Step 2 (Context Gathering) when user input is needed, REPLACE or SUPPLEMENT the existing `blocker` message with the new more granular `input_needed`:
  ```bash
  MSG=$(node ~/.claude/mowism/bin/mow-tools.cjs message format input_needed --phase {phase} --input-type discussion_prompt --detail "Phase needs discuss-phase context gathering" --activity "Awaiting user input" --raw)
  ```
  Send to lead, then print to terminal:
  ```
  echo "▶ Orchestrator notified -- waiting for input"
  ```

  Similarly in `<failure_handling>` when worker hits an error that needs user resolution:
  ```bash
  MSG=$(node ~/.claude/mowism/bin/mow-tools.cjs message format input_needed --phase {phase} --input-type error_resolution --detail "{error_description}" --activity "Awaiting error resolution" --raw)
  ```
  Send to lead, then print:
  ```
  echo "▶ Orchestrator notified -- waiting for input"
  ```

  **5. Add context recap on resume after input:**

  Add a new subsection to `<lifecycle>` or `<failure_handling>`:

  ```markdown
  ### Context Recap After Input Wait

  After sending an `input_needed` message and waiting for user input, when the user interacts with this terminal, print a brief context recap BEFORE processing the input:

  \`\`\`
  echo "━━━ Context ━━━"
  echo "Phase {N}, Plan {plan_id}: {plan_objective}"
  echo "Was working on: {current_task_description}"
  echo "━━━━━━━━━━━━━━━"
  \`\`\`

  This helps the user orient after switching from another terminal. Print once, then continue.
  ```

  **6. Add permission prompt phase context:**

  Add a note to the executor spawning instructions in Step 4:

  ```markdown
  **Permission prompt context:** Before running Bash commands that may trigger permission prompts, the executor should echo phase context:
  \`\`\`bash
  echo "[Phase {N}, Task {T}] About to run: {command}"
  \`\`\`
  This provides phase context directly above Claude Code's permission prompt since the prompt itself cannot be modified.
  ```

  **7. Add error state banner:**

  In `<failure_handling>` when a plan executor fails (before sending error message), change the banner to caution stripes:
  ```bash
  node ~/.claude/mowism/bin/mow-tools.cjs format banner-error --text "PHASE {N}: ERROR"
  ```
  This replaces the normal phase-colored banner with alternating yellow/black caution stripes (locked decision: NOT red, red is orchestrator only).
  </action>
  <verify>
  Read agents/mow-phase-worker.md and verify:
  1. `format banner-phase` call exists in Step 1 (Initialize)
  2. All 8 checkpoint message types documented in messaging protocol table
  3. `--activity` flag included in message format examples
  4. `input_needed` message sent in Step 2 and failure_handling
  5. "Orchestrator notified -- waiting for input" echo exists after input_needed sends
  6. Context recap section exists with the separator format
  7. Permission prompt context note exists in Step 4
  8. `format banner-error` call exists in failure_handling
  9. `stage_transition` messages at discussing -> planning, planning -> executing, executing -> verifying
  </verify>
  <done>Phase worker prints startup banner, sends all 8 checkpoint message types at correct lifecycle milestones, includes activity descriptions, confirms input waits, prints context recap on resume, echoes phase context for permission prompts, and switches to caution stripe banner on error.</done>
</task>

</tasks>

<verification>
1. mow-team-lead.md contains dashboard rendering after message processing
2. mow-team-lead.md handles all 12 event types (7 existing + 5 new)
3. mow-phase-worker.md prints phase banner at startup
4. mow-phase-worker.md sends task_claimed, commit_made, stage_transition, input_needed, and plan_created at correct lifecycle points
5. Input routing: worker sends input_needed -> dashboard auto-pins -> orchestrator renders notification -> worker resumes -> pin auto-dismissed
6. All --activity flags present in worker message format calls
7. Error banner uses caution stripes, not red
</verification>

<success_criteria>
- Orchestrator prints red banner at startup, renders dashboard after every worker message
- Workers print phase-colored banner at startup, send 8 checkpoint types with activity descriptions
- Input routing: pinned notifications in dashboard, "Orchestrator notified" confirmation in worker terminal, context recap on resume
- Permission prompts preceded by phase context echo
- Error state shows caution stripe banner in worker terminal
- Clean dashboard state on close-shop
</success_criteria>

<output>
After completion, create `.planning/phases/10-live-feedback-and-visual-differentiation/10-03-SUMMARY.md`
</output>
