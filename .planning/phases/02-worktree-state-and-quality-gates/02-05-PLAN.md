---
phase: 02-worktree-state-and-quality-gates
plan: 05
type: execute
wave: 3
depends_on:
  - 02-03
  - 02-04
files_modified: []
autonomous: true
requirements:
  - WKTR-01
  - WKTR-02
  - WKTR-03
  - WKTR-04
  - WKTR-05
  - GATE-01
  - GATE-02
  - GATE-03
  - GATE-04
  - GATE-05
  - GATE-06
  - GATE-07
  - GATE-08
  - GATE-09

must_haves:
  truths:
    - "All worktree subcommands in mow-tools.cjs work correctly (claim, release, status, clean, verify-result)"
    - "All cmdInit* functions call requireWorkTrunk() and stale cleanup"
    - "execute-phase workflow has worktree claim on start and release on completion"
    - ".config/wt.toml has functional post-create hook"
    - "refine-phase command exists and workflow handles all 4 tiers"
    - "VERIFICATION-CHAIN index file format is correct with links to per-check findings"
    - "STATE.md verification results section is written correctly"
    - "change-summary includes reconciliation of conflicting findings"
    - "No broken @-references in any new or modified file"
  artifacts: []
  key_links:
    - from: "commands/mow/refine-phase.md"
      to: "~/.claude/mowism/workflows/refine-phase.md"
      via: "@-reference"
      pattern: "workflows/refine-phase.md"
    - from: "~/.claude/mowism/workflows/execute-phase.md"
      to: "bin/mow-tools.cjs worktree claim"
      via: "node invocation"
      pattern: "worktree claim"
    - from: "~/.claude/mowism/workflows/refine-phase.md"
      to: "bin/mow-tools.cjs worktree verify-result"
      via: "node invocation"
      pattern: "verify-result"
---

<objective>
Validate all Phase 2 deliverables end-to-end: verify cross-references resolve, command files are in sync, workflow wiring is correct, mow-tools.cjs subcommands function, and all 14 requirements are addressed. Fix any issues found.

Purpose: Catch wiring problems, broken references, and integration gaps before Phase 2 is marked complete.

Output: Clean validation with all issues resolved.
</objective>

<execution_context>
@/home/max/.claude/mowism/workflows/execute-plan.md
@/home/max/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-worktree-state-and-quality-gates/02-01-SUMMARY.md
@.planning/phases/02-worktree-state-and-quality-gates/02-02-SUMMARY.md
@.planning/phases/02-worktree-state-and-quality-gates/02-03-SUMMARY.md
@.planning/phases/02-worktree-state-and-quality-gates/02-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate worktree integration (WKTR-01 through WKTR-05)</name>
  <files></files>
  <action>
Run the following validation checks. Fix any issues found.

**WKTR-01: WorkTrunk dependency check**
1. `node bin/mow-tools.cjs init progress 2>&1` -- must succeed (wt is installed)
2. `grep -c "requireWorkTrunk" bin/mow-tools.cjs` -- must be 12+ (one per cmdInit* plus definition)
3. Verify the error message includes all 4 install commands (yay, brew, cargo, https://worktrunk.dev)

**WKTR-02: STATE.md worktree tracking**
4. `node bin/mow-tools.cjs worktree status` -- must return valid JSON (empty array or entries)
5. Test claim: `node bin/mow-tools.cjs worktree claim test-phase` then `node bin/mow-tools.cjs worktree status` -- must show the claim
6. Clean up: `node bin/mow-tools.cjs worktree release test-phase`

**WKTR-03: Conflict detection**
7. After step 5 (while claim exists), attempt a second claim from same worktree -- verify behavior (should update, not conflict, since same worktree)
8. Verify the error message text for cross-worktree conflict includes "Cannot claim the same phase from another worktree"

**WKTR-04: Post-create hook**
9. `cat .config/wt.toml` -- must contain `[post-create]` and `planning-copy` with `primary_worktree_path` template variable
10. Verify the hook has STATE.md verification (`if [ -f "$DEST/STATE.md" ]`)

**WKTR-05: execute-phase worktree awareness**
11. `grep "worktree claim" ~/.claude/mowism/workflows/execute-phase.md` -- must find the claim call
12. `grep "worktree release" ~/.claude/mowism/workflows/execute-phase.md` -- must find the release call
13. `grep "refine-phase" ~/.claude/mowism/workflows/execute-phase.md` -- must find the offer

**Test suite:**
14. `node bin/mow-tools.test.cjs 2>&1 | tail -3` -- all tests must pass

If any check fails, fix the issue in the relevant file and re-verify.
  </action>
  <verify>All 14 checks pass. Test suite shows all tests passing.</verify>
  <done>All WKTR requirements validated: wt check works, state tracking functions, conflicts detected, post-create hook configured, execute-phase is worktree-aware.</done>
</task>

<task type="auto">
  <name>Task 2: Validate quality gate integration (GATE-01 through GATE-09)</name>
  <files></files>
  <action>
Run the following validation checks. Fix any issues found.

**GATE-01: refine-phase command exists**
1. `cat commands/mow/refine-phase.md | head -10` -- must show correct frontmatter
2. `diff commands/mow/refine-phase.md ~/.claude/commands/mow/refine-phase.md` -- must show no differences (repo and install in sync)

**GATE-02: Tier selection**
3. `grep -i "auto.*recommended" ~/.claude/mowism/workflows/refine-phase.md` -- must find auto tier option
4. `grep -i "minimum\|complex\|algorithmic" ~/.claude/mowism/workflows/refine-phase.md` -- must find all 3 named tiers

**GATE-03: Minimum tier chain**
5. Verify the workflow has Task() calls for scope-check, change-summary, verify-work, update-claude-md in the minimum tier flow

**GATE-04: Complex tier chain**
6. Verify Stage 2 has parallel Task() calls for simplify, dead-code-sweep, grill-me

**GATE-05: Algorithmic tier chain**
7. Verify Stage 2 for algorithmic tier includes prove-it alongside the complex tier checks

**GATE-06: VERIFICATION-CHAIN output**
8. `grep "VERIFICATION-CHAIN-P" ~/.claude/mowism/workflows/refine-phase.md` -- must find index file generation
9. Verify the index file template has the summary table with columns: #, Check, Result, Duration, Findings

**GATE-07: STATE.md verification results**
10. `grep "verify-result" ~/.claude/mowism/workflows/refine-phase.md` -- must find the mow-tools call
11. `grep "Verification Results" bin/mow-tools.cjs` -- must find the section header

**GATE-08: Local execution**
12. Verify each Task() runs in the same worktree (no cross-worktree file references in prompts)
13. Verify findings files are written to local .planning/ directory paths

**GATE-09: Reconciliation**
14. `grep -i "reconcil\|conflicting" ~/.claude/mowism/workflows/refine-phase.md` -- must find reconciliation instruction in change-summary prompt

**Cross-reference validation:**
15. Check all @-references in refine-phase command file resolve to existing paths
16. Verify no broken references between command → workflow → skill files

If any check fails, fix the issue in the relevant file and re-verify.
  </action>
  <verify>All 16 checks pass. No broken references. All tiers correctly orchestrated.</verify>
  <done>All GATE requirements validated: refine-phase exists with all tiers, VERIFICATION-CHAIN output is correct, STATE.md is updated, reconciliation is in change-summary, all references resolve.</done>
</task>

</tasks>

<verification>
- All worktree subcommands function correctly
- All quality gate components are wired correctly
- No broken @-references in any file
- Test suite passes
- Command files are in sync between repo and install locations
- All 14 requirements have validated implementations
</verification>

<success_criteria>
Every Phase 2 success criterion from ROADMAP.md is validated:
1. Worktree assignment tracking + conflict detection works
2. refine-phase with tier selection runs quality chain without further input
3. VERIFICATION-CHAIN-P{phase}.md exists with findings, STATE.md shows results
4. New worktrees get .planning/ via post-create hook
5. Missing wt CLI gives clear install error
</success_criteria>

<output>
After completion, create `.planning/phases/02-worktree-state-and-quality-gates/02-05-SUMMARY.md`
</output>
