---
phase: 02-worktree-state-and-quality-gates
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - .config/wt.toml
  - ~/.claude/mowism/workflows/execute-phase.md
autonomous: true
requirements:
  - WKTR-04
  - WKTR-05

must_haves:
  truths:
    - "When WorkTrunk creates a new worktree, .planning/ is automatically copied from the main worktree"
    - "The post-create hook verifies STATE.md exists after copy and fails visibly if not"
    - "execute-phase claims a phase in STATE.md before executing and releases on completion"
    - "If a worktree is already executing a phase, another worktree's execute-phase gets a hard block"
    - "Mowism auto-creates .config/wt.toml with the post-create hook if the file is missing"
  artifacts:
    - path: ".config/wt.toml"
      provides: "WorkTrunk project configuration with post-create hook"
      contains: "post-create"
    - path: "~/.claude/mowism/workflows/execute-phase.md"
      provides: "Worktree-aware phase execution workflow"
      contains: "worktree claim"
  key_links:
    - from: ".config/wt.toml"
      to: "primary_worktree_path"
      via: "{{ primary_worktree_path }} template variable"
      pattern: "primary_worktree_path"
    - from: "~/.claude/mowism/workflows/execute-phase.md"
      to: "bin/mow-tools.cjs worktree claim"
      via: "node mow-tools.cjs worktree claim in initialize step"
      pattern: "worktree claim"
    - from: "~/.claude/mowism/workflows/execute-phase.md"
      to: "bin/mow-tools.cjs worktree release"
      via: "node mow-tools.cjs worktree release in update_roadmap step"
      pattern: "worktree release"
---

<objective>
Configure WorkTrunk's post-create hook to copy `.planning/` into new worktrees, and update the execute-phase workflow to claim/release phase assignments via the mow-tools.cjs worktree subcommands built in Plan 02-01.

Purpose: New worktrees automatically have access to planning state (no manual setup), and concurrent agents are prevented from executing the same phase.

Output: .config/wt.toml with post-create hook, updated execute-phase.md with worktree awareness.
</objective>

<execution_context>
@/home/max/.claude/mowism/workflows/execute-plan.md
@/home/max/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-worktree-state-and-quality-gates/02-RESEARCH.md
@.planning/phases/02-worktree-state-and-quality-gates/02-01-SUMMARY.md
@/home/max/.claude/mowism/workflows/execute-phase.md
@bin/mow-tools.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .config/wt.toml with post-create hook and auto-configure logic</name>
  <files>.config/wt.toml, bin/mow-tools.cjs</files>
  <action>
**1. Create `.config/wt.toml`** in the repo root with this content:

```toml
# WorkTrunk project configuration for Mowism
# Auto-created by Mowism init. See: https://worktrunk.dev

[post-create]
# Copy .planning/ from main worktree to new worktree
planning-copy = """
SRC="{{ primary_worktree_path }}/.planning"
DEST="{{ worktree_path }}/.planning"
if [ -d "$SRC" ]; then
  cp -r "$SRC" "$DEST"
  echo "MOW: Copied .planning/ from $(basename {{ primary_worktree_path }})"
  if [ -f "$DEST/STATE.md" ]; then
    echo "MOW: State file verified"
  else
    echo "MOW: WARNING - STATE.md not found after copy" >&2
    exit 1
  fi
else
  echo "MOW: No .planning/ found in main worktree (skipping)"
fi
"""
```

**2. Add auto-configure logic to mow-tools.cjs** -- add a `ensureWtConfig()` function that:
1. Checks if `.config/wt.toml` exists in the project root (cwd)
2. If it doesn't exist: create it with the content above. Log: "MOW: Created .config/wt.toml with post-create hook"
3. If it exists: check if it contains `[post-create]` and `planning-copy`. If the planning-copy hook is missing, append it. Log: "MOW: Added planning-copy hook to .config/wt.toml"
4. If both exist: do nothing (already configured)

Wire `ensureWtConfig()` into `cmdInitExecutePhase` (after `requireWorkTrunk()` and stale cleanup). Only execute-phase needs this because that's the command that triggers worktree-aware behavior. Other commands just need the wt check.

Per locked decision: auto-configure the hook on init if wt is installed but hook is missing. Don't require user approval since the hook is non-destructive (copies files only).
  </action>
  <verify>
`cat .config/wt.toml` shows the post-create hook with primary_worktree_path template.
`grep "ensureWtConfig" bin/mow-tools.cjs` shows the function definition and call in cmdInitExecutePhase.
  </verify>
  <done>.config/wt.toml exists with planning-copy post-create hook. Auto-configure logic creates or updates the file on execute-phase init.</done>
</task>

<task type="auto">
  <name>Task 2: Update execute-phase workflow with worktree claim/release</name>
  <files>~/.claude/mowism/workflows/execute-phase.md</files>
  <action>
Modify `~/.claude/mowism/workflows/execute-phase.md` to add worktree awareness at three points:

**1. In the `initialize` step**, after the existing init call, add worktree claim:
```
# Claim this phase for the current worktree
node /home/max/.claude/mowism/bin/mow-tools.cjs worktree claim "${PHASE_NUMBER}"
```
- This happens AFTER phase validation (no point claiming a phase that doesn't exist)
- If the claim fails (phase already claimed by another worktree), the error message from mow-tools.cjs will halt execution with a clear message

**2. In the `update_roadmap` step** (after successful phase completion), add worktree release:
```
# Release worktree claim after successful completion
node /home/max/.claude/mowism/bin/mow-tools.cjs worktree release "${PHASE_NUMBER}"
```
- Per locked decision: auto-release claims when phase execution completes successfully

**3. In the `offer_next` step**, after the completion report, add a suggestion to run refine-phase:
```
---
**Quality gate available:**
`/mow:refine-phase {phase_number}` -- run automated quality checks before verify-work

<sub>`/clear` first -- fresh context window</sub>
---
```
- Per locked decision: offer to run refine-phase as next step, don't auto-chain
- This goes BEFORE the existing transition/auto-advance logic
- Only show this if verification passed (not if gaps_found)

**4. In the `failure_handling` section**, add a note about claim release on failure:
```
- **Phase claim on failure:** If execution stops mid-phase (user chooses "Stop"), the worktree claim is NOT auto-released. The user can re-run `/mow:execute-phase` to resume, and the existing claim will be preserved. To manually release: edit STATE.md or the stale cleanup will handle it if the worktree is removed.
```

Do NOT modify any other parts of the execute-phase workflow. Surgical additions only.
  </action>
  <verify>
`grep "worktree claim" ~/.claude/mowism/workflows/execute-phase.md` shows the claim call.
`grep "worktree release" ~/.claude/mowism/workflows/execute-phase.md` shows the release call.
`grep "refine-phase" ~/.claude/mowism/workflows/execute-phase.md` shows the offer.
  </verify>
  <done>
execute-phase claims the phase on start, releases on successful completion, and offers refine-phase as next step. Conflict detection happens via mow-tools.cjs (hard block). Failed executions preserve the claim for resume.
  </done>
</task>

</tasks>

<verification>
- `.config/wt.toml` exists with post-create hook using `{{ primary_worktree_path }}`
- execute-phase.md has worktree claim in initialize step
- execute-phase.md has worktree release in update_roadmap step
- execute-phase.md offers `/mow:refine-phase` after completion
- Auto-configure logic in mow-tools.cjs creates wt.toml if missing
</verification>

<success_criteria>
When WorkTrunk creates a new worktree (`wt switch --create feature-x`), the post-create hook copies `.planning/` automatically. When execute-phase runs, it claims the phase and prevents other worktrees from claiming it. On completion, the claim is released and refine-phase is offered.
</success_criteria>

<output>
After completion, create `.planning/phases/02-worktree-state-and-quality-gates/02-03-SUMMARY.md`
</output>
