---
phase: 02-worktree-state-and-quality-gates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/mow-tools.cjs
  - bin/mow-tools.test.cjs
  - ~/.claude/mowism/workflows/progress.md
  - commands/mow/worktree-status.md
  - ~/.claude/commands/mow/worktree-status.md
autonomous: true
requirements:
  - WKTR-01
  - WKTR-02
  - WKTR-03
  - GATE-07

must_haves:
  truths:
    - "Mowism refuses to init if wt CLI is not installed, with platform-specific install instructions"
    - "STATE.md can track which worktree is executing which phase with rich metadata including plan progress"
    - "A second agent trying to claim an already-claimed phase gets a clear conflict error"
    - "Stale worktree entries are auto-released on init when the worktree no longer exists"
    - "STATE.md has a Verification Results section tracking tier, pass/fail, date, and blockers"
    - "/mow:progress shows a Worktree Assignments summary section when worktree claims exist"
    - "A dedicated /mow:worktree-status command shows detailed worktree assignment information"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "checkWorkTrunk(), worktree claim/release/conflict, verification results"
      contains: "checkWorkTrunk"
    - path: "bin/mow-tools.test.cjs"
      provides: "Tests for all new worktree and verification results functions"
      contains: "checkWorkTrunk"
    - path: "~/.claude/mowism/workflows/progress.md"
      provides: "Updated progress workflow with Worktree Assignments section"
      contains: "Worktree Assignments"
    - path: "commands/mow/worktree-status.md"
      provides: "Dedicated worktree status command (repo canonical source)"
      contains: "mow:worktree-status"
    - path: "~/.claude/commands/mow/worktree-status.md"
      provides: "Dedicated worktree status command (installed location)"
      contains: "mow:worktree-status"
  key_links:
    - from: "bin/mow-tools.cjs"
      to: "wt CLI"
      via: "execSync('command wt --version')"
      pattern: "checkWorkTrunk"
    - from: "bin/mow-tools.cjs"
      to: "wt list --format=json"
      via: "execSync for stale detection"
      pattern: "wt list --format=json"
    - from: "bin/mow-tools.cjs cmdInit*"
      to: "checkWorkTrunk()"
      via: "function call at top of every init"
      pattern: "checkWorkTrunk"
    - from: "~/.claude/mowism/workflows/progress.md"
      to: "bin/mow-tools.cjs worktree status"
      via: "node invocation in report step"
      pattern: "worktree status"
    - from: "commands/mow/worktree-status.md"
      to: "bin/mow-tools.cjs worktree status"
      via: "node invocation for detailed view"
      pattern: "worktree status"
---

<objective>
Extend mow-tools.cjs with WorkTrunk dependency checking, worktree state tracking (claim/release/conflict detection), stale entry cleanup, and verification results tracking in STATE.md.

Purpose: All subsequent Phase 2 plans depend on these mow-tools.cjs primitives. The worktree tracking functions are used by execute-phase (Plan 02-03), and the verification results section is written by refine-phase (Plan 02-04).

Output: Extended mow-tools.cjs with new subcommands and tests.
</objective>

<execution_context>
@/home/max/.claude/mowism/workflows/execute-plan.md
@/home/max/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-worktree-state-and-quality-gates/02-RESEARCH.md
@bin/mow-tools.cjs
@bin/mow-tools.test.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WorkTrunk dependency check and wire into all init functions</name>
  <files>bin/mow-tools.cjs</files>
  <action>
Add a `checkWorkTrunk()` function near the top of mow-tools.cjs (in the Helpers section) that:
1. Runs `execSync('command wt --version 2>&1', { encoding: 'utf-8', timeout: 5000 })` to check if `wt` is in PATH
2. Returns `{ installed: true }` on success, `{ installed: false }` on catch
3. Does NOT use `which` or `type` -- use `command` for POSIX portability

Add a `requireWorkTrunk()` function that calls `checkWorkTrunk()` and if `installed` is false, calls `error()` with this exact message:
```
WorkTrunk (wt) is required but not found.

Mowism uses WorkTrunk for git worktree management in multi-agent workflows.

Install via:
  Arch/CachyOS: yay -S worktrunk
  macOS:        brew install max-sixty/tap/worktrunk
  Cargo:        cargo install worktrunk
  Other:        https://worktrunk.dev

After installing, run: wt config shell install
```

Wire `requireWorkTrunk()` as the FIRST call inside every `cmdInit*` function (there are ~12 of them: cmdInitExecutePhase, cmdInitPlanPhase, cmdInitNewProject, cmdInitNewMilestone, cmdInitQuick, cmdInitResume, cmdInitVerifyWork, cmdInitPhaseOp, cmdInitTodos, cmdInitMilestoneOp, cmdInitMapCodebase, cmdInitProgress). Pattern: find each `function cmdInit` and add `requireWorkTrunk();` as the first statement inside the function body.

Per locked decision: check on EVERY `/mow:*` command init, not just worktree-specific commands.
  </action>
  <verify>
Run `node bin/mow-tools.cjs init progress 2>&1` -- should succeed (wt is installed).
Run `grep -c "requireWorkTrunk" bin/mow-tools.cjs` -- should show 12+ matches (one per cmdInit function plus the function definition).
  </verify>
  <done>Every cmdInit* function calls requireWorkTrunk() as its first action. checkWorkTrunk() correctly detects wt presence. Error message includes all 4 platform install commands.</done>
</task>

<task type="auto">
  <name>Task 2: Add worktree state tracking, conflict detection, stale cleanup, and verification results to mow-tools.cjs</name>
  <files>bin/mow-tools.cjs, bin/mow-tools.test.cjs</files>
  <action>
Add the following new subcommands to mow-tools.cjs:

**1. `worktree claim <phase>`** — Claims a phase for the current worktree.
- Reads STATE.md, parses "Worktree Assignments" section (or creates it if missing)
- Checks if the phase is already claimed by another worktree (conflict detection per WKTR-03)
  - If claimed: call `error()` with message: "Phase {phase} is being executed by {worktree_path} (started {timestamp}). Cannot claim the same phase from another worktree.\n\nRun `/mow:worktree-status` for details or `/mow:progress` for a summary, or execute a different phase."
  - Hard block, no warning+confirm (per research discretion recommendation)
- Gets current worktree path from `process.cwd()` resolved against git
- Gets current branch from `git branch --show-current`
- Writes a new row to the "Worktree Assignments" table: `| {worktree_path} | {branch} | {phase} | — | executing | {ISO timestamp} | {session_id from env or 'unknown'} |`
  - The "Plan" column tracks which plan within the phase is currently executing (e.g., "02-03"). Set to "—" on initial claim.
  - Plan progress is updated by execute-phase as it advances through plans (Plan 02-03 wires this).
- Session ID: use `process.env.CLAUDE_SESSION_ID || process.env.HOSTNAME || 'unknown'`
- Commits STATE.md if `commit_docs` is true

**2. `worktree release <phase>`** — Releases a worktree's claim on a phase.
- Removes the row matching the current worktree path and the specified phase from "Worktree Assignments"
- Auto-release per locked decision: called when phase execution completes successfully

**3. `worktree status`** — Shows current worktree assignments.
- Reads STATE.md "Worktree Assignments" section
- Returns JSON array of `{ worktree, branch, phase, plan, status, started, agent }`

**4. `worktree update-plan <phase> <plan-id>`** — Updates the Plan column for a worktree's phase claim.
- Finds the row matching current worktree and specified phase
- Updates the Plan column to `<plan-id>` (e.g., "02-03")
- Called by execute-phase as it starts each plan (Plan 02-03 wires this)

**5. `worktree clean`** — Stale entry detection and cleanup.
- Runs `wt list --format=json` to get active worktrees
- Cross-references against STATE.md "Worktree Assignments"
- Any entry whose worktree path is NOT in `wt list` output → auto-release
- Logs: "MOW: Released stale claim for {path} (worktree no longer exists)"
- Per research discretion: check-on-init approach

**6. Add stale cleanup call** — Wire `worktree clean` logic into every `cmdInit*` function, right after `requireWorkTrunk()`. Make it silent (no output) unless it actually cleans something. Wrap in try/catch so a `wt list` failure doesn't block init.

**7. `worktree verify-result <phase> --tier <tier> --result <pass|fail|error> [--blockers "..."]`** — Records verification chain results.
- Adds/updates a row in STATE.md's "Verification Results" section: `| {phase} | {tier} | {result} | {date} | {blockers or 'none'} |`
- Creates the section if it doesn't exist, using the format from 02-RESEARCH.md

**8. STATE.md section format** — When creating new sections, use these headers:
```markdown
## Worktree Assignments

| Worktree | Branch | Phase | Plan | Status | Started | Agent |
|----------|--------|-------|------|--------|---------|-------|

### Verification Results

| Phase | Tier | Result | Date | Blockers |
|-------|------|--------|------|----------|
```

**9. Add tests** to bin/mow-tools.test.cjs:
- Test checkWorkTrunk() returns { installed: true } (wt is installed on this system)
- Test worktree claim writes to STATE.md correctly (use a temp directory with mock STATE.md)
- Test worktree claim detects conflict (pre-populate STATE.md with an existing claim)
- Test worktree release removes the correct row
- Test worktree clean removes entries for non-existent paths
- Test worktree update-plan updates the Plan column correctly
- Test worktree verify-result writes verification results section

Register all new subcommands in the main command dispatch (the large if/else chain at the bottom of mow-tools.cjs).
  </action>
  <verify>
Run `node bin/mow-tools.cjs worktree status 2>&1` from the repo root -- should return empty JSON array or section not found.
Run `node bin/mow-tools.test.cjs 2>&1 | tail -5` -- all tests pass including new worktree tests.
  </verify>
  <done>
All 7 worktree subcommands exist and are registered (claim, release, status, update-plan, clean, verify-result, plus stale cleanup wiring). Conflict detection hard-blocks with clear message. Stale cleanup runs silently on every init. Plan progress column tracks which plan is executing. Verification results section can be written. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add worktree summary to /mow:progress and create /mow:worktree-status command</name>
  <files>~/.claude/mowism/workflows/progress.md, commands/mow/worktree-status.md, ~/.claude/commands/mow/worktree-status.md</files>
  <action>
Two locked decisions require worktree claim visibility: (1) `/mow:progress` shows a worktree summary, and (2) a dedicated detail command exists for worktree status.

**1. Update `~/.claude/mowism/workflows/progress.md`** -- add worktree awareness to the `report` step.

After the "## Pending Todos" section in the report template, add a "## Worktree Assignments" section:

```
## Worktree Assignments
```

Logic:
- Call `node /home/max/.claude/mowism/bin/mow-tools.cjs worktree status` to get JSON array of assignments
- If the array is empty: show "No active worktree assignments."
- If non-empty: render a summary table:
  ```
  | Worktree | Phase | Plan | Status | Agent |
  |----------|-------|------|--------|-------|
  | {basename of worktree path} | {phase} | {plan} | {status} | {agent} |
  ```
  - Use basename of worktree path for readability (not full path)
  - Show only the key columns for the summary view (worktree, phase, plan, status, agent)
  - After the table: `<sub>/mow:worktree-status for full details</sub>`
- Only show this section if the project has `.planning/STATE.md` (i.e., after init)

**2. Create `commands/mow/worktree-status.md`** (repo canonical source) -- the dedicated detail command.

```yaml
---
name: mow:worktree-status
description: Show detailed worktree assignment status
allowed-tools:
  - Read
  - Bash
  - Grep
  - Glob
---
```

Body:
```markdown
<objective>
Show detailed worktree assignment information: which worktrees are claiming which phases, their plan progress, timestamps, and agent IDs. This is the detail view -- /mow:progress shows a summary.
</objective>

<process>
1. Run `node /home/max/.claude/mowism/bin/mow-tools.cjs worktree status` to get JSON array
2. If empty: "No active worktree assignments."
3. If non-empty: render a detailed table with ALL columns:
   ```
   ## Worktree Assignments (Detail)

   | Worktree | Branch | Phase | Plan | Status | Started | Agent |
   |----------|--------|-------|------|--------|---------|-------|
   | {full worktree path} | {branch} | {phase} | {plan} | {status} | {started} | {agent} |
   ```
4. For each entry, also show:
   - Time since started (e.g., "2h 15m ago")
   - Whether the worktree still exists on disk (cross-reference with `wt list --format=json`)
   - If worktree no longer exists: mark as "STALE" and suggest running any /mow:* command to auto-clean
5. After the detail table, show:
   ```
   **Quick actions:**
   - `/mow:execute-phase {phase}` -- resume or start execution in a worktree
   - `/mow:progress` -- full project status with worktree summary
   ```
</process>
```

**3. Copy to install location:** Copy `commands/mow/worktree-status.md` to `~/.claude/commands/mow/worktree-status.md` with identical content.
  </action>
  <verify>
`grep "Worktree Assignments" ~/.claude/mowism/workflows/progress.md` -- must find the new section.
`grep "worktree status" ~/.claude/mowism/workflows/progress.md` -- must find the mow-tools.cjs call.
`cat commands/mow/worktree-status.md | head -5` -- shows correct frontmatter.
`diff commands/mow/worktree-status.md ~/.claude/commands/mow/worktree-status.md` -- no differences.
  </verify>
  <done>
/mow:progress includes a Worktree Assignments summary section (per locked decision). /mow:worktree-status exists as a dedicated detail command (per locked decision). Both consume the worktree status data from mow-tools.cjs.
  </done>
</task>

</tasks>

<verification>
- `node bin/mow-tools.cjs init progress` succeeds (wt check passes)
- `grep -c "requireWorkTrunk" bin/mow-tools.cjs` returns 12+
- `node bin/mow-tools.cjs worktree status` returns valid JSON
- `node bin/mow-tools.test.cjs` passes all tests including new ones
- STATE.md can have worktree assignments and verification results written/read
</verification>

<success_criteria>
mow-tools.cjs has all worktree primitives that Plans 02-03 and 02-04 depend on. WorkTrunk is a hard gate on every init. Conflict detection is a hard block. Stale cleanup is automatic. All new code has tests.
</success_criteria>

<output>
After completion, create `.planning/phases/02-worktree-state-and-quality-gates/02-01-SUMMARY.md`
</output>
