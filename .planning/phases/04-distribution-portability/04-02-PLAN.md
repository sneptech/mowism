---
phase: 04-distribution-portability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/mow-tools.cjs
  - bin/mow-tools.test.cjs
  - mowism/bin/mow-tools.cjs
  - mowism/bin/mow-tools.test.cjs
autonomous: true
requirements:
  - DIST-04
  - TEAM-04

must_haves:
  truths:
    - "checkAgentTeams() returns enabled:true when env var is set to 'true'"
    - "checkAgentTeams() returns enabled:true when env var is set to '1'"
    - "checkAgentTeams() returns enabled:true when settings.json has value 'true'"
    - "checkAgentTeams() returns enabled:true when settings.json has value '1'"
    - "No stale duplicate files exist in mowism/bin/"
    - "Test suite passes with new test cases for 'true' value detection"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "Fixed checkAgentTeams() with truthy value matching"
      contains: "val === '1' || val === 'true'"
    - path: "bin/mow-tools.test.cjs"
      provides: "Test coverage for both '1' and 'true' env var values"
      contains: "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS"
  key_links:
    - from: "bin/mow-tools.cjs"
      to: "process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS"
      via: "checkAgentTeams() env var check"
      pattern: "val === '1' \\|\\| val === 'true'"
    - from: "bin/mow-tools.cjs"
      to: "settings.json"
      via: "checkAgentTeams() settings fallback check"
      pattern: "settingsVal === '1' \\|\\| settingsVal === 'true'"
---

<objective>
Fix the `checkAgentTeams()` env var mismatch so both `'1'` and `'true'` are detected, delete the stale `mowism/bin/` directory, and add test coverage for the fix.

Purpose: install.sh recommends `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=true` but `checkAgentTeams()` only matches `=== '1'`. Users following install instructions get a permanent "enable Agent Teams" nudge even when they already have it enabled. The stale `mowism/bin/` directory contains copies 800+ lines behind `bin/` originals, confusing anyone who browses the repo.

Output: `checkAgentTeams()` accepts both `'1'` and `'true'` (case-insensitive), tests cover both values, `mowism/bin/` directory is deleted.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-distribution-portability/04-RESEARCH.md
@bin/mow-tools.cjs
@bin/mow-tools.test.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix checkAgentTeams() to accept both '1' and 'true' + delete stale mowism/bin/</name>
  <files>
    bin/mow-tools.cjs
    mowism/bin/ (deletion)
  </files>
  <action>
    **Fix 1: checkAgentTeams() env var check (around line 189)**

    Replace the strict `=== '1'` comparison with truthy matching for both the env var and settings.json fallback:

    ```javascript
    function checkAgentTeams() {
      // Check shell-level env var first
      const envVal = (process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS || '').toLowerCase();
      if (envVal === '1' || envVal === 'true') {
        return { enabled: true, source: 'env' };
      }

      // Fallback: check ~/.claude/settings.json
      try {
        const homedir = require('os').homedir();
        const settingsPath = path.join(homedir, '.claude', 'settings.json');
        const settings = JSON.parse(fs.readFileSync(settingsPath, 'utf-8'));
        const settingsVal = (
          String(settings.env && settings.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS || '')
        ).toLowerCase();
        if (settingsVal === '1' || settingsVal === 'true') {
          return { enabled: true, source: 'settings' };
        }
      } catch {
        // settings.json doesn't exist or is malformed — that's fine
      }

      return { enabled: false, source: null };
    }
    ```

    The key changes:
    1. Extract env value into `envVal`, normalize to lowercase
    2. Check `envVal === '1' || envVal === 'true'`
    3. Extract settings value into `settingsVal`, normalize to lowercase
    4. Check `settingsVal === '1' || settingsVal === 'true'`

    **Fix 2: Delete stale mowism/bin/ directory**

    ```bash
    rm -rf mowism/bin/
    ```

    The directory contains `mow-tools.cjs` (5326 lines, 812 lines behind `bin/` version) and `mow-tools.test.cjs` (2346 lines, 383 lines behind `bin/` version). Neither is referenced by `install.sh` or any other file. They are Phase 1 snapshots that were never updated.
  </action>
  <verify>
    ```bash
    # Verify checkAgentTeams accepts both values - search for the new pattern
    grep -A2 "envVal === '1'" bin/mow-tools.cjs
    grep -A2 "settingsVal === '1'" bin/mow-tools.cjs

    # Verify stale directory is gone
    test ! -d mowism/bin/ && echo "PASS: mowism/bin/ deleted" || echo "FAIL: mowism/bin/ still exists"
    ```
  </verify>
  <done>`checkAgentTeams()` has two-value matching (`'1'` and `'true'`) for both env var and settings.json paths. `mowism/bin/` directory no longer exists.</done>
</task>

<task type="auto">
  <name>Task 2: Add test coverage for 'true' value detection in checkAgentTeams</name>
  <files>bin/mow-tools.test.cjs</files>
  <action>
    Add test cases to `bin/mow-tools.test.cjs` that verify `checkAgentTeams()` correctly detects `'true'` as an enabled value. Find the existing Agent Teams test section and add:

    1. **Test: env var set to 'true'** — Set `process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS = 'true'`, run an init command, verify `agent_teams_enabled === true` in the JSON output. Restore env after test.

    2. **Test: env var set to 'TRUE' (case-insensitive)** — Set env var to `'TRUE'`, verify detection still works. This confirms the `.toLowerCase()` normalization.

    3. **Test: env var set to '1' still works** — Ensure the existing '1' detection is not broken by the change. (This may already be covered by existing tests; if so, just verify the existing test still passes.)

    Follow the test file's existing patterns for env var manipulation (save original, set value, run command, restore). Use the same `runMowTools()` helper and `assert` style as surrounding tests.
  </action>
  <verify>
    ```bash
    # Run full test suite
    cd /home/max/git/mowism && node bin/mow-tools.test.cjs

    # Expected: all tests pass (100+), including new Agent Teams tests
    ```
  </verify>
  <done>Test suite passes with new test cases covering `'true'` and `'TRUE'` env var values. Existing `'1'` tests still pass. Total test count increased by 2-3.</done>
</task>

</tasks>

<verification>
```bash
# Run full test suite to confirm nothing is broken
node bin/mow-tools.test.cjs

# Verify the fix is in place
grep -c "val === '1' || val === 'true'" bin/mow-tools.cjs
# Expected: 2 (one for envVal, one for settingsVal)

# Verify stale directory is gone
ls mowism/bin/ 2>/dev/null && echo "FAIL" || echo "PASS"
```
</verification>

<success_criteria>
1. `checkAgentTeams()` returns `{ enabled: true, source: 'env' }` for env var values `'1'`, `'true'`, `'TRUE'`
2. `checkAgentTeams()` returns `{ enabled: true, source: 'settings' }` for settings.json values `'1'`, `'true'`
3. `mowism/bin/` directory does not exist
4. Full test suite passes (100+ tests, including 2-3 new ones)
</success_criteria>

<output>
After completion, create `.planning/phases/04-distribution-portability/04-02-SUMMARY.md`
</output>
