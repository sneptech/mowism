---
phase: 04-distribution-portability
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
  - 04-02
files_modified: []
autonomous: true
requirements:
  - DIST-04
  - DIST-01
  - CORE-01
  - CORE-03
  - TEAM-04

must_haves:
  truths:
    - "Zero occurrences of /home/max/.claude/ anywhere in the repository (excluding .git/ and Phase 4 plan files where the path appears as documentation text)"
    - "Full test suite passes (100+ tests)"
    - "No stale files in mowism/bin/"
    - "checkAgentTeams() detects both '1' and 'true'"
    - "All @-references resolve to ~/.claude/mowism/ paths"
    - "All node invocations use ~/.claude/mowism/bin/mow-tools.cjs"
  artifacts: []
  key_links: []
---

<objective>
End-to-end portability validation sweep confirming all Phase 4 changes are correct and complete.

Purpose: This is the final quality gate for Phase 4. It verifies that all hardcoded paths are gone, the env var fix works, stale files are deleted, and the broader portability sweep finds no remaining issues. No code changes -- read-only validation and evidence gathering.

Output: Validation log with PASS/FAIL for each of the 4 Phase 4 success criteria, plus a broader portability check.
</objective>

<execution_context>
@~/.claude/mowism/workflows/execute-plan.md
@~/.claude/mowism/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-distribution-portability/04-RESEARCH.md
@.planning/phases/04-distribution-portability/04-01-SUMMARY.md
@.planning/phases/04-distribution-portability/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate all 4 Phase 4 success criteria</name>
  <files>(read-only validation — no files modified)</files>
  <action>
    Run each check and log the result with evidence. This is a READ-ONLY task -- no code changes.

    **Criterion 1: No hardcoded `.claude/` paths remaining**
    ```bash
    # Must return 0 lines (excludes Phase 4 plan files which contain the path as documentation text)
    grep -r '/home/max/.claude/' . --include='*.md' --include='*.cjs' --include='*.sh' | grep -v '.git/' | grep -v '.planning/phases/04-distribution-portability/' | wc -l
    ```
    PASS if count = 0. FAIL if count > 0 (list the offending files).

    Note: Two categories of `/home/max/` references are excluded from this check:
    1. Phase 4 plan files (`.planning/phases/04-distribution-portability/`) contain `/home/max/.claude/` as documentation text describing the replacement work itself.
    2. Non-`.claude/` references like `/home/max/git/mowism` in `.planning/` research docs and historical artifacts are development documentation, not runtime paths.

    **Criterion 2: checkAgentTeams() detects both '1' and 'true'**
    ```bash
    # Verify the code pattern exists
    grep "val === '1' || val === 'true'" bin/mow-tools.cjs | wc -l
    ```
    PASS if count = 2 (env check + settings check).

    ```bash
    # Run tests to confirm behavior
    node bin/mow-tools.test.cjs 2>&1 | tail -5
    ```
    PASS if all tests pass.

    **Criterion 3: No stale files in mowism/bin/**
    ```bash
    ls mowism/bin/ 2>/dev/null
    ```
    PASS if directory does not exist (command returns non-zero). FAIL if any files listed.

    **Criterion 4: Zero /home/max/.claude/ in any file (broader sweep)**
    ```bash
    # Broader sweep: check ALL file types, not just md/cjs/sh (excludes Phase 4 plan docs)
    grep -r '/home/max/.claude/' . | grep -v '.git/' | grep -v 'node_modules/' | grep -v '.planning/phases/04-distribution-portability/' | wc -l
    ```
    PASS if count = 0. This catches any file type we might have missed. Uses `/home/max/.claude/` (not bare `/home/max/`) because non-`.claude/` references in `.planning/` historical artifacts (e.g., `/home/max/git/mowism`, `/home/max/git/ai-agent-tools-and-tips/`) are development documentation, not runtime paths. Excludes Phase 4 plan files which contain the path as documentation text.

    **Broader portability check (per user's locked decision):**
    ```bash
    # No fish-isms in distributed files
    grep -r 'set -gx\|set -x\|functions ' commands/ mowism/ agents/ bin/ --include='*.md' --include='*.cjs' --include='*.sh' | wc -l

    # No CachyOS-specific paths
    grep -r '/usr/lib/cachyos\|/etc/pacman' commands/ mowism/ agents/ bin/ | wc -l

    # No Wayland/X11 dependencies
    grep -r 'ydotool\|wl-copy\|wl-paste\|xdotool\|xclip' commands/ mowism/ agents/ bin/ | wc -l
    ```
    PASS if all counts = 0.

    Log all results in a validation report format matching the style from 03-06-VERIFICATION.md (if available) or a simple table.
  </action>
  <verify>
    All 4 criteria show PASS. Broader portability check shows PASS. Test suite output shows all tests passing.
  </verify>
  <done>Validation log created with evidence for all criteria. All show PASS. Phase 4 success criteria met.</done>
</task>

<task type="auto">
  <name>Task 2: Cross-reference requirement coverage</name>
  <files>(read-only validation — no files modified)</files>
  <action>
    Verify each Phase 4 requirement ID is addressed by the work done in Plans 04-01 and 04-02:

    | Requirement | Description | Addressed By | Evidence |
    |-------------|-------------|--------------|----------|
    | DIST-04 (fix) | Install script checks for Agent Teams env var | 04-02 Task 1 | `checkAgentTeams()` now accepts `'true'` matching install.sh's recommendation |
    | DIST-01 (fix) | One-command install works | 04-01 Task 1 | Source files use `~/.claude/` so install.sh copies produce working results |
    | CORE-01 (fix) | All workflows forked with correct paths | 04-01 Task 1 | 32 workflow files in `mowism/workflows/` now use portable paths |
    | CORE-03 (fix) | All agent definitions with correct paths | 04-01 Task 1 | 9 agent files in `agents/` now use portable paths |
    | TEAM-04 (fix) | Nudge works correctly when env var is set to 'true' | 04-02 Task 1 | `checkAgentTeams()` detects `'true'`, so nudge is suppressed when Agent Teams is actually enabled |

    Confirm each requirement has a PASS verdict with specific file/grep evidence.

    Record the final validation in the SUMMARY (handled by the summary template).
  </action>
  <verify>
    All 5 requirement IDs show PASS with specific evidence. No requirement left uncovered.
  </verify>
  <done>All 5 Phase 4 requirements verified PASS with evidence. Phase 4 is complete.</done>
</task>

</tasks>

<verification>
```bash
# The ultimate validation: zero hardcoded .claude/ paths + passing tests (excludes Phase 4 plan docs)
grep -r '/home/max/.claude/' . | grep -v '.git/' | grep -v 'node_modules/' | grep -v '.planning/phases/04-distribution-portability/' | wc -l
# Expected: 0

node bin/mow-tools.test.cjs 2>&1 | tail -3
# Expected: all tests pass
```
</verification>

<success_criteria>
1. All 4 Phase 4 success criteria verified PASS with evidence
2. All 5 Phase 4 requirement IDs verified PASS with evidence
3. Broader portability sweep shows no additional issues
4. Full test suite passes
5. Validation log documenting all results exists in SUMMARY
</success_criteria>

<output>
After completion, create `.planning/phases/04-distribution-portability/04-03-SUMMARY.md`
</output>
