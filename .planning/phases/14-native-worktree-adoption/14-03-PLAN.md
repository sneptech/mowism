---
phase: 14-native-worktree-adoption
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - bin/mow-tools.cjs
  - commands/mow/complete-milestone.md
autonomous: true
requirements:
  - WKT-06

must_haves:
  truths:
    - "Running any /mow: command in a repo with .worktrees/ directory triggers a migration offer"
    - "Migration renames .worktrees/ to .worktrees.bak (not deleted)"
    - "In-progress worktrees (with active git branches) are warned about and skipped during migration"
    - "/mow:complete-milestone offers cleanup of .worktrees.bak if it exists"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "cmdWorktreeMigrate function and checkMigrationNeeded helper"
      contains: "cmdWorktreeMigrate"
    - path: "commands/mow/complete-milestone.md"
      provides: "Cleanup offer for .worktrees.bak during milestone completion"
      contains: ".worktrees.bak"
  key_links:
    - from: "bin/mow-tools.cjs init functions"
      to: "checkMigrationNeeded"
      via: "migration detection call in init functions"
      pattern: "checkMigrationNeeded"
    - from: "bin/mow-tools.cjs cmdWorktreeMigrate"
      to: ".worktrees.bak"
      via: "fs.renameSync for migration"
      pattern: "\\.worktrees\\.bak"
---

<objective>
Create migration script that detects existing `.worktrees/` directories, warns about in-progress worktrees, renames to `.worktrees.bak`, and re-creates entries at `.claude/worktrees/phase-NN`. Add migration detection to init commands and .worktrees.bak cleanup offer to /mow:complete-milestone.

Purpose: Users upgrading from v1.1 to v1.2 get a safe migration path that preserves state without data loss.
Output: cmdWorktreeMigrate function, checkMigrationNeeded in init, cleanup offer in complete-milestone.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-native-worktree-adoption/14-RESEARCH.md
@.planning/phases/14-native-worktree-adoption/14-01-SUMMARY.md
@.planning/phases/14-native-worktree-adoption/14-02-SUMMARY.md
@bin/mow-tools.cjs (lines 6044-6047 for cmdInitExecutePhase pattern, lines 6818-6838 for readManifest/writeManifest)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cmdWorktreeMigrate function and checkMigrationNeeded helper</name>
  <files>bin/mow-tools.cjs</files>
  <action>
1. Add `checkMigrationNeeded(cwd)` helper function (near the worktree functions):
   - Get repo root via `getRepoRoot(cwd)`
   - Check if `.worktrees/` directory exists AND `.worktrees.bak` does NOT exist (if .bak exists, migration already happened)
   - If `.worktrees/` exists, read its entries (excluding `manifest.json`)
   - Also check if `.worktrees/manifest.json` exists
   - Return `{ needed: true/false, old_path, entry_count, has_manifest }` or `{ needed: false }`
   - Wrap in try/catch returning `{ needed: false }` on any error

2. Add `cmdWorktreeMigrate(cwd, options, raw)` function:
   - Call `checkMigrationNeeded(cwd)`. If not needed, output `{ migrated: false, reason: 'no migration needed' }` and return.
   - Get repo root. Read old manifest from `.worktrees/manifest.json` if it exists.
   - Check for active worktrees via `git worktree list --porcelain`: parse output and check if any paths start with the `.worktrees/` directory. If any are active:
     - Collect their names and branches
     - Output `{ migrated: false, reason: 'active_worktrees', active: [...] }` with a warning listing which worktrees are still in use
     - Do NOT proceed with migration. The user must `git worktree remove` them first.
     - Return early.
   - If no active worktrees in `.worktrees/`:
     a. Ensure `.claude/worktrees/` directory exists
     b. If old manifest exists, read it, update paths for each entry (change `path` from `.worktrees/pNN` to absolute `.claude/worktrees/phase-NN`), change keys from `pNN` to `phase-NN`, write to `.claude/worktrees/manifest.json`
     c. Rename `.worktrees/` to `.worktrees.bak` using `fs.renameSync`
     d. Output `{ migrated: true, entries_migrated, backup_path: '.worktrees.bak' }`

3. Add migration detection to init functions. In each of these functions, AFTER the existing `silentWorktreeClean(cwd)` call (NOT replacing it), add:
   ```javascript
   const migration = checkMigrationNeeded(cwd);
   if (migration.needed) {
     process.stderr.write(`MOW: Legacy .worktrees/ detected (${migration.entry_count} entries). Run any /mow: command with --migrate or use: node bin/mow-tools.cjs worktree migrate\n`);
   }
   ```
   Add this to these init functions: `cmdInitExecutePhase`, `cmdInitPlanPhase`, `cmdInitNewProject`, `cmdInitNewMilestone`, `cmdInitResume`.
   Do NOT add to every init function -- only the 5 most common entry points.

4. Add CLI dispatch for the new subcommand in the worktree switch case:
   - `migrate`: call `cmdWorktreeMigrate(cwd, {}, raw)`

5. Add `cmdWorktreeCleanBackup(cwd, raw)` function for cleaning up `.worktrees.bak`:
   - Check if `.worktrees.bak` exists
   - If not, output `{ cleaned: false, reason: 'no backup found' }`
   - If yes, remove it recursively (`fs.rmSync` with `recursive: true, force: true`)
   - Output `{ cleaned: true, path: '.worktrees.bak' }`
   - Add to CLI dispatch: `clean-backup`
  </action>
  <verify>
    - `grep -c 'checkMigrationNeeded' bin/mow-tools.cjs` returns at least 6 (1 definition + 5 init calls)
    - `grep -c 'cmdWorktreeMigrate' bin/mow-tools.cjs` returns at least 2 (definition + dispatch)
    - `node bin/mow-tools.cjs worktree migrate --raw` outputs `{"migrated":false,"reason":"no migration needed"}` (since no .worktrees/ exists)
    - `node bin/mow-tools.cjs worktree clean-backup --raw` outputs cleaned false (no backup exists)
  </verify>
  <done>checkMigrationNeeded detects .worktrees/ presence. cmdWorktreeMigrate safely renames with active worktree detection. Five main init functions print migration warning. clean-backup subcommand available for .worktrees.bak removal.</done>
</task>

<task type="auto">
  <name>Task 2: Add .worktrees.bak cleanup offer to complete-milestone command</name>
  <files>commands/mow/complete-milestone.md</files>
  <action>
1. Read the existing `commands/mow/complete-milestone.md` workflow.

2. Add a step near the end of the milestone completion workflow (after archiving, before final output):
   - Check for `.worktrees.bak` existence: `ls -d .worktrees.bak 2>/dev/null`
   - If it exists, inform the user:
     ```
     Legacy worktree backup detected at `.worktrees.bak/`.
     This was preserved during v1.2 migration. Now that the milestone is complete,
     you can safely remove it:
       node bin/mow-tools.cjs worktree clean-backup
     Or keep it for reference.
     ```
   - This is informational only -- do NOT auto-delete. The user decides.

3. Ensure the step integrates naturally with the existing workflow flow without disrupting other milestone completion logic.
  </action>
  <verify>
    - `grep '.worktrees.bak' commands/mow/complete-milestone.md` shows the cleanup offer text
    - `grep 'clean-backup' commands/mow/complete-milestone.md` shows the command reference
  </verify>
  <done>/mow:complete-milestone includes an informational step about .worktrees.bak cleanup. Per user decision: backup is never auto-deleted, only offered for cleanup. The clean-backup command provides the mechanism.</done>
</task>

</tasks>

<verification>
1. Migration detection works: creates .worktrees/ with a manifest, runs init, sees warning
2. cmdWorktreeMigrate refuses to migrate with active worktrees
3. cmdWorktreeMigrate renames .worktrees/ to .worktrees.bak and creates .claude/worktrees/manifest.json
4. complete-milestone offers .worktrees.bak cleanup
5. clean-backup subcommand removes .worktrees.bak
</verification>

<success_criteria>
- Users with .worktrees/ see migration warning on any /mow: command
- Migration safely renames to .worktrees.bak (never deletes)
- Active worktrees block migration with actionable error message
- Manifest entries are converted from pNN to phase-NN format
- /mow:complete-milestone offers cleanup of .worktrees.bak
</success_criteria>

<output>
After completion, create `.planning/phases/14-native-worktree-adoption/14-03-SUMMARY.md`
</output>
