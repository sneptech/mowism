---
phase: 14-native-worktree-adoption
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - bin/mow-tools.cjs
  - mowism/workflows/execute-phase.md
  - mowism/workflows/close-shop.md
  - agents/mow-team-lead.md
  - commands/mow/worktree-status.md
autonomous: true
requirements:
  - WKT-04
  - WKT-05

must_haves:
  truths:
    - "No reference to .worktrees/pNN exists in active code (mow-tools.cjs, workflow files, agent files, command files)"
    - "readManifest reads from .claude/worktrees/manifest.json with fallback to .worktrees/manifest.json for pre-migration repos"
    - "writeManifest always writes to .claude/worktrees/manifest.json"
    - "getActiveWorktrees uses git worktree list instead of wt list --format=json"
    - "Coordination commands (claim, release, merge, clean, status) work with native worktree paths"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "Updated path references and coordination layer"
      contains: ".claude/worktrees"
    - path: "mowism/workflows/execute-phase.md"
      provides: "Updated worktree path references in executor workflow"
      contains: ".claude/worktrees/phase-"
    - path: "agents/mow-team-lead.md"
      provides: "Updated agent with native worktree paths"
      contains: ".claude/worktrees/phase-"
  key_links:
    - from: "bin/mow-tools.cjs readManifest"
      to: ".claude/worktrees/manifest.json"
      via: "path.join(root, '.claude', 'worktrees', 'manifest.json')"
      pattern: "\\.claude.*worktrees.*manifest\\.json"
    - from: "bin/mow-tools.cjs getActiveWorktrees"
      to: "git worktree list"
      via: "execSync git worktree list"
      pattern: "git worktree list"
---

<objective>
Rewrite all `.worktrees/pNN` path references to `.claude/worktrees/phase-NN` across mow-tools.cjs, workflow files, agent files, and commands. Adapt the coordination layer (readManifest, writeManifest, getActiveWorktrees, cmdWorktreeClean, cmdWorktreeMerge) to use native worktree paths.

Purpose: Align all code with the new native worktree path convention so hooks, coordination, and documentation are consistent.
Output: Zero `.worktrees/pNN` references in active code. Coordination layer fully functional with native paths.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-native-worktree-adoption/14-RESEARCH.md
@.planning/phases/14-native-worktree-adoption/14-01-SUMMARY.md
@bin/mow-tools.cjs (lines 6818-6838 for readManifest/writeManifest, lines 7286-7300 for getActiveWorktrees, lines 7302-7372 for cmdWorktreeClean/silentWorktreeClean, lines 6974-7010 for cmdWorktreeMerge, line 2891 for checkpoint worktree path)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update mow-tools.cjs path references and coordination layer</name>
  <files>bin/mow-tools.cjs</files>
  <action>
1. **readManifest (line ~6818):** Update to check `.claude/worktrees/manifest.json` FIRST, then fall back to `.worktrees/manifest.json` (for pre-migration repos). If found at old location only, return data but log a stderr warning suggesting migration.

2. **writeManifest (line ~6829):** Always write to `.claude/worktrees/manifest.json`. Update `worktreeDir` from `path.join(root, '.worktrees')` to `path.join(root, '.claude', 'worktrees')`.

3. **getActiveWorktrees (line ~7286):** Rewrite from `wt list --format=json` to `git worktree list --porcelain`:
   - Parse the porcelain output: each worktree block starts with `worktree /path/to/wt`, followed by `HEAD`, `branch`, `bare`/`detached` lines, separated by blank lines
   - Extract path from lines starting with `worktree `
   - Return array of absolute paths
   - On failure, return null (same contract as before)

4. **cmdWorktreeClean (line ~7302) and silentWorktreeClean (line ~7341):** These already use `getActiveWorktrees()` return value to compare against `r.worktree`. After the `getActiveWorktrees` rewrite, the paths will be absolute (from `git worktree list`). The `r.worktree` values in STATE.md are whatever was written by `cmdWorktreeClaim`. Ensure the comparison handles both absolute and relative paths: compare `path.resolve(root, r.worktree)` against the active worktree paths. Update the error message in `cmdWorktreeClean` from `'wt list failed'` to `'git worktree list failed'`.

5. **cmdWorktreeMerge (line ~6974):** Update the manifest key convention from `p${padded}` to `phase-${padded}` to match the new naming. The merge function reads `manifest.worktrees[wtKey]` â€” the key must match what `cmdWorktreeCreateNative` writes. Add fallback: if `phase-${padded}` key not found, try `p${padded}` (for pre-migration entries).

6. **Checkpoint worktree path (line ~2891):** Change default from `'.worktrees/p' + padded` to `'.claude/worktrees/phase-' + padded`.

7. **cmdWorktreeStash (line ~7012):** Update wtKey from `p${padded}` to `phase-${padded}` with fallback to `p${padded}`.

8. **cmdWorktreeListManifest (line ~6969):** No changes needed (it calls readManifest which is already updated).
  </action>
  <verify>
    - `grep -c "\.worktrees/p" bin/mow-tools.cjs` returns 0 (no old-style path references remain in active code, excluding comments about migration)
    - `grep "\.claude/worktrees" bin/mow-tools.cjs | head -5` shows new path references
    - `grep "git worktree list" bin/mow-tools.cjs` shows the rewritten getActiveWorktrees
    - `node bin/mow-tools.cjs worktree list-manifest --raw` runs without error
  </verify>
  <done>readManifest has dual-path lookup (new first, old fallback). writeManifest writes to new path. getActiveWorktrees uses git worktree list. All manifest key references use phase-NN convention with pNN fallback. Checkpoint path default updated. No .worktrees/pNN references in active code paths.</done>
</task>

<task type="auto">
  <name>Task 2: Update workflow, agent, and command file path references</name>
  <files>
    mowism/workflows/execute-phase.md
    mowism/workflows/close-shop.md
    agents/mow-team-lead.md
    commands/mow/worktree-status.md
  </files>
  <action>
1. **execute-phase.md:**
   - Line ~97: Change `.worktrees/` to `.claude/worktrees/`
   - Line ~108: Change `(.worktrees/pNN)` to `(.claude/worktrees/phase-NN)`
   - Line ~464: Change `(.worktrees/pNN)` to `(.claude/worktrees/phase-NN)`
   - Line ~501: Change `(.worktrees/pNN)` to `(.claude/worktrees/phase-NN)`

2. **close-shop.md:**
   - Line ~51: Change `cat .worktrees/p{NN}/...` to `cat .claude/worktrees/phase-{NN}/...`
   - Line ~117: Change `Worktrees preserved at .worktrees/` to `Worktrees preserved at .claude/worktrees/`

3. **mow-team-lead.md:**
   - Line ~102: Change `node ~/.claude/mowism/bin/mow-tools.cjs worktree create {phase}` to reference the native hook mechanism: `claude --worktree phase-{NN}` (the WorktreeCreate hook handles Mowism coordination automatically)
   - Line ~117: Change `.worktrees/p{NN}` to `.claude/worktrees/phase-{NN}`

4. **worktree-status.md:**
   - Line ~34: Change `wt list --format=json` to `git worktree list` or `mow-tools.cjs worktree list-manifest`
  </action>
  <verify>
    - `grep -r '\.worktrees/p' mowism/workflows/ agents/ commands/mow/worktree-status.md 2>/dev/null | grep -v '.planning' | grep -v 'RESEARCH' | grep -v '.bak'` returns no results
    - `grep '.claude/worktrees' mowism/workflows/execute-phase.md` shows updated references
    - `grep '.claude/worktrees' mowism/workflows/close-shop.md` shows updated references
    - `grep 'claude --worktree' agents/mow-team-lead.md` shows native worktree invocation
  </verify>
  <done>All workflow, agent, and command files reference .claude/worktrees/phase-NN instead of .worktrees/pNN. Team lead agent uses `claude --worktree phase-NN` instead of custom worktree create command. Worktree-status command references git worktree list instead of wt list.</done>
</task>

</tasks>

<verification>
1. `grep -rn '\.worktrees/p' bin/mow-tools.cjs mowism/workflows/ agents/ commands/ 2>/dev/null | grep -v '.planning' | grep -v 'RESEARCH' | grep -v 'migration' | grep -v '.bak' | grep -v 'old location'` returns empty (no old-style references in active code)
2. readManifest correctly reads from new location with old location fallback
3. getActiveWorktrees returns correct paths from `git worktree list --porcelain`
4. cmdWorktreeMerge and cmdWorktreeStash use phase-NN keys with pNN fallback
</verification>

<success_criteria>
- Zero .worktrees/pNN references in active code paths (excluding migration/fallback code and planning docs)
- Coordination layer works with .claude/worktrees/phase-NN paths
- readManifest/writeManifest target .claude/worktrees/manifest.json
- getActiveWorktrees uses git worktree list (no WorkTrunk dependency)
- All workflow/agent/command files use native path convention
</success_criteria>

<output>
After completion, create `.planning/phases/14-native-worktree-adoption/14-02-SUMMARY.md`
</output>
