---
phase: 14-native-worktree-adoption
plan: 04
type: execute
wave: 4
depends_on: ["14-03"]
files_modified:
  - bin/mow-tools.cjs
  - bin/install.sh
autonomous: true
requirements:
  - WKT-07

must_haves:
  truths:
    - "cmdWorktreeCreate, cmdWorktreeStash, WT_CONFIG_CONTENT, WT_PLANNING_COPY_HOOK, ensureWtConfig, checkWorkTrunk, requireWorkTrunk are all removed from mow-tools.cjs"
    - "All 13 requireWorkTrunk() call sites in init functions are removed"
    - "All ensureWtConfig() call sites are removed"
    - "install.sh no longer checks for WorkTrunk or displays it as a dependency"
    - "Net line count of mow-tools.cjs decreases (code removal exceeds code added in Plans 01-03)"
    - "CLI dispatch for worktree create still works (routes to create-native)"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "Cleaned codebase without WorkTrunk dependency or redundant worktree code"
    - path: "bin/install.sh"
      provides: "Updated install script without WorkTrunk dependency check"
  key_links:
    - from: "bin/mow-tools.cjs CLI dispatch"
      to: "cmdWorktreeCreateNative"
      via: "worktree create routes to create-native"
      pattern: "create.*cmdWorktreeCreateNative"
---

<objective>
Remove redundant worktree creation code (cmdWorktreeCreate, cmdWorktreeStash), all WorkTrunk dependency code (checkWorkTrunk, requireWorkTrunk, ensureWtConfig, WT_CONFIG_CONTENT, WT_PLANNING_COPY_HOOK), and all 13+ requireWorkTrunk()/ensureWtConfig() call sites. Update install.sh to remove WorkTrunk dependency check. Redirect CLI `worktree create` to `create-native`.

Purpose: Eliminate the WorkTrunk external dependency entirely and reduce mow-tools.cjs LOC by removing code now handled by native hooks.
Output: Cleaner codebase with ~150 fewer lines and zero WorkTrunk references.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-native-worktree-adoption/14-RESEARCH.md
@.planning/phases/14-native-worktree-adoption/14-01-SUMMARY.md
@.planning/phases/14-native-worktree-adoption/14-02-SUMMARY.md
@.planning/phases/14-native-worktree-adoption/14-03-SUMMARY.md
@bin/mow-tools.cjs (lines 732-870 for WorkTrunk section, lines 6853-6967 for cmdWorktreeCreate, lines 7012-7063 for cmdWorktreeStash, lines 7846-7884 for CLI dispatch)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove WorkTrunk functions and all requireWorkTrunk/ensureWtConfig call sites</name>
  <files>bin/mow-tools.cjs</files>
  <action>
1. **Remove the WorkTrunk dependency section (lines ~732-758):**
   - Delete `checkWorkTrunk()` function
   - Delete `requireWorkTrunk()` function

2. **Remove the WorkTrunk config section (lines ~797-870+):**
   - Delete `WT_CONFIG_CONTENT` constant
   - Delete `WT_PLANNING_COPY_HOOK` constant
   - Delete `ensureWtConfig()` function
   - Keep the `// ─── Agent Teams Detection ──────` section intact (it's between WorkTrunk and WtConfig)

3. **Remove all 13 `requireWorkTrunk()` call sites.** These appear in init functions. Remove the line entirely in each:
   - `cmdInitExecutePhase` (line ~6045)
   - `cmdInitPlanPhase` (line ~6130)
   - `cmdInitNewProject` (line ~6231)
   - `cmdInitNewMilestone` (line ~6293)
   - `cmdInitQuick` (line ~6322)
   - `cmdInitResume` (line ~6373)
   - `cmdInitVerifyWork` (line ~6406)
   - `cmdInitPhaseOp` (line ~6437)
   - `cmdInitTodos` (line ~6495)
   - `cmdInitMilestoneOp` (line ~6592)
   - `cmdInitMapCodebase` (line ~6655)
   - `cmdInitProgress` (line ~6691)
   - And any others found by `grep -n 'requireWorkTrunk' bin/mow-tools.cjs`

4. **Remove the `ensureWtConfig(cwd)` call site** in `cmdInitExecutePhase` (line ~6047). Search for any other `ensureWtConfig` calls.

5. **Remove `cmdWorktreeCreate` (lines ~6853-6967):**
   - Delete the entire function (115 lines)
   - This is now replaced by `cmdWorktreeCreateNative` from Plan 01

6. **Remove `cmdWorktreeStash` (lines ~7012-7063):**
   - Delete the entire function (~50 lines)
   - Stashing is not needed with native worktree lifecycle — worktrees are created fresh and removed on completion

7. **Update CLI dispatch (lines ~7846-7884):**
   - Change `worktree create` to route to `cmdWorktreeCreateNative` instead of `cmdWorktreeCreate`:
     ```javascript
     if (subcommand === 'create') {
       // Legacy alias — routes to create-native
       const nameIdx = args.indexOf('--name');
       const name = nameIdx !== -1 ? args[nameIdx + 1] : (args[2] ? `phase-${normalizePhaseName(args[2])}` : null);
       cmdWorktreeCreateNative(cwd, { name }, raw);
     }
     ```
   - Remove the `stash` subcommand from dispatch
   - Update the error message to remove `stash` and include `create-native, migrate, clean-backup`

8. **Verify no dangling references:** After all deletions, search for `WorkTrunk`, `requireWorkTrunk`, `ensureWtConfig`, `WT_CONFIG`, `WT_PLANNING`, `cmdWorktreeCreate` (but not `cmdWorktreeCreateNative`), `cmdWorktreeStash` — ensure zero matches in mow-tools.cjs.
  </action>
  <verify>
    - `grep -c 'requireWorkTrunk' bin/mow-tools.cjs` returns 0
    - `grep -c 'ensureWtConfig' bin/mow-tools.cjs` returns 0
    - `grep -c 'WT_CONFIG_CONTENT' bin/mow-tools.cjs` returns 0
    - `grep -c 'WT_PLANNING_COPY_HOOK' bin/mow-tools.cjs` returns 0
    - `grep -c 'checkWorkTrunk' bin/mow-tools.cjs` returns 0
    - `grep 'cmdWorktreeCreate[^N]' bin/mow-tools.cjs` returns nothing (only cmdWorktreeCreateNative remains)
    - `grep -c 'cmdWorktreeStash' bin/mow-tools.cjs` returns 0
    - `node bin/mow-tools.cjs worktree create-native --name phase-98 --raw 2>/dev/null` still works (then cleanup)
    - `wc -l bin/mow-tools.cjs` shows a line count decrease compared to pre-plan baseline
  </verify>
  <done>All WorkTrunk dependency code removed. All 13+ requireWorkTrunk() call sites removed. cmdWorktreeCreate and cmdWorktreeStash removed. CLI `worktree create` redirects to create-native. Zero WorkTrunk, WT_CONFIG, cmdWorktreeCreate (non-native), or cmdWorktreeStash references remain.</done>
</task>

<task type="auto">
  <name>Task 2: Update install.sh to remove WorkTrunk dependency</name>
  <files>bin/install.sh</files>
  <action>
1. **Remove the WorkTrunk check block (lines ~77-84):**
   - Delete the `WT_STATUS="MISSING..."` assignment
   - Delete the `if command -v wt` check and the `else` block
   - Delete the `WT_VERSION` line

2. **Remove WorkTrunk from the dependency output (line ~113):**
   - Delete `echo "    WorkTrunk:    $WT_STATUS"`

3. **Add hook script installation:**
   After the existing file copy section (where commands, agents, workflows are copied), add:
   ```bash
   # Copy hook scripts
   HOOK_DIR="$CLAUDE_DIR/mowism/hooks"
   mkdir -p "$HOOK_DIR"
   if [ -d "$REPO_DIR/.claude/hooks" ]; then
     cp -r "$REPO_DIR/.claude/hooks/"* "$HOOK_DIR/" 2>/dev/null
     chmod +x "$HOOK_DIR"/*.sh 2>/dev/null
     HOOK_COUNT=$(ls "$HOOK_DIR"/*.sh 2>/dev/null | wc -l)
   else
     HOOK_COUNT=0
   fi
   ```
   - Add `echo "    Hooks:     $HOOK_COUNT hook scripts"` to the post-install summary

4. Verify the install script still runs cleanly: `bash -n bin/install.sh`
  </action>
  <verify>
    - `grep -c 'WorkTrunk' bin/install.sh` returns 0
    - `grep -c 'worktrunk' bin/install.sh` returns 0
    - `grep -c 'wt --version' bin/install.sh` returns 0
    - `grep 'hook' bin/install.sh` shows hook installation code
    - `bash -n bin/install.sh` passes (syntax check)
  </verify>
  <done>install.sh no longer checks for or references WorkTrunk. Hook scripts are copied during installation. Post-install summary shows hook count instead of WorkTrunk status.</done>
</task>

</tasks>

<verification>
1. `grep -rn 'WorkTrunk\|requireWorkTrunk\|ensureWtConfig\|WT_CONFIG\|WT_PLANNING\|cmdWorktreeStash' bin/mow-tools.cjs bin/install.sh` returns empty
2. `grep 'cmdWorktreeCreate[^N]' bin/mow-tools.cjs` returns empty (only Native variant)
3. `node bin/mow-tools.cjs worktree create-native --name phase-97 --raw 2>/dev/null` creates worktree at .claude/worktrees/phase-97 (cleanup after)
4. `wc -l bin/mow-tools.cjs` < pre-phase baseline (net LOC reduction)
5. `bash -n bin/install.sh` passes
6. All existing worktree subcommands still work: list-manifest, merge, claim, release, status, update-plan, clean, verify-result, create-native, migrate, clean-backup, remove-manifest
</verification>

<success_criteria>
- Zero references to WorkTrunk, wt CLI, or WT_CONFIG in the entire codebase (excluding planning docs)
- cmdWorktreeCreate and cmdWorktreeStash fully removed
- All 13+ requireWorkTrunk() and ensureWtConfig() call sites removed
- CLI `worktree create` seamlessly routes to create-native
- install.sh is WorkTrunk-free and installs hook scripts
- Net LOC reduction in mow-tools.cjs
</success_criteria>

<output>
After completion, create `.planning/phases/14-native-worktree-adoption/14-04-SUMMARY.md`
</output>
