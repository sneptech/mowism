---
phase: 14-native-worktree-adoption
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/settings.json
  - .claude/hooks/mow-worktree-create.sh
  - .claude/hooks/mow-worktree-remove.sh
  - bin/mow-tools.cjs
autonomous: true
requirements:
  - WKT-01
  - WKT-02
  - WKT-03

must_haves:
  truths:
    - "WorktreeCreate hook fires when Claude Code creates a worktree and delegates to mow-tools.cjs create-native"
    - "WorktreeRemove hook fires when worktree is removed and performs manifest/claim/dashboard cleanup via mow-tools.cjs"
    - "Phase worktrees are created at .claude/worktrees/phase-NN with .planning/ copy and STATUS.md initialized"
    - "Non-phase worktrees (names not matching phase-NN) get default git behavior without Mowism coordination"
  artifacts:
    - path: ".claude/settings.json"
      provides: "Hook registration for WorktreeCreate and WorktreeRemove"
      contains: "WorktreeCreate"
    - path: ".claude/hooks/mow-worktree-create.sh"
      provides: "WorktreeCreate hook script delegating to mow-tools.cjs"
      min_lines: 20
    - path: ".claude/hooks/mow-worktree-remove.sh"
      provides: "WorktreeRemove hook script for cleanup"
      min_lines: 15
    - path: "bin/mow-tools.cjs"
      provides: "cmdWorktreeCreateNative and worktree release/remove-manifest subcommands"
      contains: "cmdWorktreeCreateNative"
  key_links:
    - from: ".claude/hooks/mow-worktree-create.sh"
      to: "bin/mow-tools.cjs"
      via: "node invocation of worktree create-native"
      pattern: "mow-tools\\.cjs.*worktree.*create-native"
    - from: ".claude/hooks/mow-worktree-remove.sh"
      to: "bin/mow-tools.cjs"
      via: "node invocation of worktree release and remove-manifest"
      pattern: "mow-tools\\.cjs.*worktree.*release"
---

<objective>
Create Claude Code WorktreeCreate and WorktreeRemove hook scripts with settings.json registration, plus the new `cmdWorktreeCreateNative` function in mow-tools.cjs that handles phase worktree creation with Mowism coordination (.planning/ copy, STATUS.md init, manifest update).

Purpose: Replace custom cmdWorktreeCreate with native Claude Code hook-triggered creation, and add automatic cleanup on worktree removal.
Output: Hook scripts in .claude/hooks/, settings.json with hook registration, new CLI subcommands in mow-tools.cjs.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-native-worktree-adoption/14-RESEARCH.md
@bin/mow-tools.cjs (lines 6800-6970 for existing cmdWorktreeCreate, readManifest, writeManifest, getDefaultBranch)
@bin/mow-tools.cjs (lines 7846-7884 for CLI dispatch of worktree subcommands)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hook scripts and settings.json</name>
  <files>
    .claude/settings.json
    .claude/hooks/mow-worktree-create.sh
    .claude/hooks/mow-worktree-remove.sh
  </files>
  <action>
1. Create `.claude/hooks/` directory.

2. Create `.claude/hooks/mow-worktree-create.sh` (make executable):
   - Read JSON from stdin (fields: `session_id`, `cwd`, `hook_event_name`, `name`)
   - Parse `name` and `cwd` using `jq` with Node.js fallback (for machines without jq)
   - Filter by naming convention: if `name` does NOT match `^phase-[0-9]+$`, create a plain worktree with `git worktree add "$CWD/.claude/worktrees/$NAME" -b "$NAME" "$(git -C "$CWD" symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's|refs/remotes/origin/||' || echo main)"` and echo the absolute path. Exit 0.
   - For phase worktrees: call `node "$CWD/bin/mow-tools.cjs" worktree create-native --name "$NAME" --raw 2>/dev/null` and extract `.path` from the JSON result
   - Print ONLY the absolute path to stdout. ALL diagnostic output goes to stderr (`>&2`)
   - Use `set -euo pipefail` for safety
   - If mow-tools.cjs is not found at `$CWD/bin/`, try `~/.claude/mowism/bin/mow-tools.cjs` as fallback (installed location)

3. Create `.claude/hooks/mow-worktree-remove.sh` (make executable):
   - Read JSON from stdin (fields: `session_id`, `cwd`, `hook_event_name`, `worktree_path`)
   - Parse `worktree_path` and `cwd` using `jq` with Node.js fallback
   - Derive phase from worktree name: `basename "$WT_PATH" | sed 's/^phase-//'`
   - If the name does NOT match `phase-[0-9]+`, exit 0 (no Mowism cleanup for non-phase worktrees)
   - Check for uncommitted changes: `git -C "$WT_PATH" diff --quiet 2>/dev/null || echo "MOW: WARNING: Worktree $(basename "$WT_PATH") removed with uncommitted changes" >&2`
   - Best-effort cleanup: call `node "$TOOLS_PATH" worktree release "$PHASE"` and `node "$TOOLS_PATH" worktree remove-manifest "$PHASE"` (both with `|| true` since hook cannot block removal)
   - Clear dashboard state: call `node "$TOOLS_PATH" dashboard clear` with `|| true` (runs in main repo cwd, not the worktree being removed)
   - Always exit 0 (removal cannot be blocked)

4. Create `.claude/settings.json` (this is the project-level settings file, separate from the existing `.claude/settings.local.json`):
   ```json
   {
     "hooks": {
       "WorktreeCreate": [
         {
           "hooks": [
             {
               "type": "command",
               "command": "bash \"$CLAUDE_PROJECT_DIR/.claude/hooks/mow-worktree-create.sh\""
             }
           ]
         }
       ],
       "WorktreeRemove": [
         {
           "hooks": [
             {
               "type": "command",
               "command": "bash \"$CLAUDE_PROJECT_DIR/.claude/hooks/mow-worktree-remove.sh\""
             }
           ]
         }
       ]
     }
   }
   ```
  </action>
  <verify>
    - `test -x .claude/hooks/mow-worktree-create.sh` (executable)
    - `test -x .claude/hooks/mow-worktree-remove.sh` (executable)
    - `cat .claude/settings.json | node -e "const j=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8')); console.log(j.hooks.WorktreeCreate[0].hooks[0].type)"` outputs "command"
    - `bash -n .claude/hooks/mow-worktree-create.sh` (syntax check)
    - `bash -n .claude/hooks/mow-worktree-remove.sh` (syntax check)
  </verify>
  <done>Both hook scripts are executable, syntactically valid bash, registered in settings.json with correct WorktreeCreate/WorktreeRemove event names. Create hook filters by phase-NN pattern and falls back to plain git for non-phase names. Remove hook performs best-effort cleanup and always exits 0.</done>
</task>

<task type="auto">
  <name>Task 2: Add cmdWorktreeCreateNative and remove-manifest subcommand to mow-tools.cjs</name>
  <files>bin/mow-tools.cjs</files>
  <action>
1. Add `cmdWorktreeCreateNative(cwd, options, raw)` function near the existing `cmdWorktreeCreate` (around line 6853):
   - Parse `--name` from options (required, e.g., "phase-09")
   - Get repo root via `getRepoRoot(cwd)`
   - If name matches `/^phase-(\d+)$/`: extract padded phase number. Otherwise: create a plain worktree at `.claude/worktrees/{name}` with `git worktree add`, output `{ path, branch, phase: null }`, return.
   - For phase worktrees:
     a. Compute `absPath = path.join(root, '.claude', 'worktrees', name)`
     b. Read manifest via `readManifest(root)`. If manifest has entry for this name AND absPath exists, reuse (set status to 'active', write manifest, output with `reused: true`, return)
     c. Clean stale entry if manifest has entry but directory gone
     d. Ensure `.claude/worktrees/` directory exists (`fs.mkdirSync` with `recursive: true`)
     e. Create worktree: `git worktree add "${absPath}" -b "phase-${padded}" "${base}"` (base from `getDefaultBranch(root)`)
     f. Copy `.planning/` from root to worktree: `cp -r`
     g. Init STATUS.md: call `mow-tools.cjs status init ${padded}` with cwd set to absPath
     h. Update manifest at new location with entry `{ path: absPath, branch, phase: padded, phase_name, created, status: 'active', stash_ref: null, last_commit: null, merged: false, merged_at: null }`
     i. Output `{ path: absPath, branch, phase: padded, reused: false }`

2. Add `cmdWorktreeRemoveManifest(cwd, phase, raw)` function:
   - Get repo root, normalize phase, compute wtKey as `phase-${padded}` (new convention)
   - Read manifest. If entry exists and `merged` is false, set `status: 'removed_unmerged'` but do NOT delete entry (branch still exists for potential merge). If `merged` is true, delete entry entirely.
   - Write manifest. Output result.

3. Update the CLI dispatch switch (around line 7846) to add new subcommands:
   - `create-native`: parse `--name` flag, call `cmdWorktreeCreateNative`
   - `remove-manifest`: call `cmdWorktreeRemoveManifest` with `args[2]` as phase
   - Update the error message for unknown subcommands to include the new commands

Note: Do NOT remove or modify the existing `cmdWorktreeCreate` function yet -- it will be removed in Plan 04. Both old and new functions coexist temporarily.
  </action>
  <verify>
    - `node bin/mow-tools.cjs worktree create-native --name phase-99 --raw 2>/dev/null` creates a worktree at `.claude/worktrees/phase-99` (then clean up: `git worktree remove .claude/worktrees/phase-99 && git branch -d phase-99`)
    - `node bin/mow-tools.cjs worktree remove-manifest 99 --raw` handles missing entry gracefully
    - `grep -c 'cmdWorktreeCreateNative' bin/mow-tools.cjs` returns at least 2 (definition + dispatch)
  </verify>
  <done>cmdWorktreeCreateNative creates worktrees at .claude/worktrees/phase-NN with .planning/ copy and STATUS.md init. remove-manifest handles cleanup with merged/unmerged distinction. Both subcommands are accessible via CLI dispatch. Existing cmdWorktreeCreate is untouched for backward compatibility.</done>
</task>

</tasks>

<verification>
1. Hook scripts exist, are executable, pass bash syntax check
2. settings.json has correct hook registration structure
3. `worktree create-native` creates a phase worktree at the correct path with .planning/ and STATUS.md
4. `worktree remove-manifest` handles both merged and unmerged entries
5. Non-phase names in the create hook fall through to plain git behavior
6. No stdout contamination in hook scripts (only the path is printed)
</verification>

<success_criteria>
- WorktreeCreate hook script delegates phase worktrees to mow-tools.cjs create-native
- WorktreeRemove hook script performs best-effort cleanup
- Both hooks are registered in .claude/settings.json
- cmdWorktreeCreateNative creates worktrees at .claude/worktrees/phase-NN with full Mowism setup
- Non-phase worktrees get default behavior without coordination overhead
</success_criteria>

<output>
After completion, create `.planning/phases/14-native-worktree-adoption/14-01-SUMMARY.md`
</output>
