---
phase: 03-agent-teams-and-distribution
plan: 04
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - agents/mow-team-lead.md
  - commands/mow/team-status.md
autonomous: true
requirements:
  - TEAM-03

must_haves:
  truths:
    - "Lead orchestrator agent definition exists with instructions to create teams, spawn workers per worktree, manage tasks with wave dependencies, and update STATE.md"
    - "Lead agent uses Agent Teams API primitives (Teammate spawnTeam, TaskCreate, TaskUpdate addBlockedBy, Task with team_name) -- not custom coordination"
    - "/mow:team-status command reads and displays Agent Team Status from STATE.md"
    - "Lead agent is explicitly instructed to coordinate (not execute) -- no direct file edits, no implementation"
  artifacts:
    - path: "agents/mow-team-lead.md"
      provides: "Lead orchestrator agent definition for Agent Teams"
      min_lines: 60
      contains: "team_name"
    - path: "commands/mow/team-status.md"
      provides: "Team status display command"
      contains: "team-status"
  key_links:
    - from: "agents/mow-team-lead.md"
      to: ".planning/STATE.md"
      via: "team-update commands for state tracking"
      pattern: "mow-tools.cjs team-update"
    - from: "agents/mow-team-lead.md"
      to: "Agent Teams API"
      via: "Teammate and TaskCreate primitives"
      pattern: "Teammate|TaskCreate|team_name"
    - from: "commands/mow/team-status.md"
      to: "bin/mow-tools.cjs"
      via: "team-status subcommand"
      pattern: "mow-tools.cjs team-status"
---

<objective>
Create the Agent Teams lead orchestrator agent and the /mow:team-status command.

Purpose: The lead orchestrator is the brain of Agent Teams coordination. It reads plans, creates tasks with wave dependencies, spawns workers per worktree, monitors completion, and updates STATE.md. The team-status command gives users a quick view of team activity. This is the core TEAM-03 deliverable.

Output: agents/mow-team-lead.md, commands/mow/team-status.md
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-teams-and-distribution/03-RESEARCH.md
@.planning/phases/03-agent-teams-and-distribution/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lead orchestrator agent definition</name>
  <files>agents/mow-team-lead.md</files>
  <action>
  Create `agents/mow-team-lead.md` in the repo's agents/ directory (create agents/ if it doesn't exist). This is a Claude Code agent definition that instructs the lead session how to coordinate an Agent Teams execution.

  The agent definition should include:

  **Identity and role:**
  - "You are the Mowism lead orchestrator. You coordinate Agent Teams execution of project plans. You create teams, spawn workers, manage task dependencies, and track progress. You NEVER implement tasks directly."

  **Orchestration flow (the lead's playbook):**

  1. **Read state:** Load `.planning/STATE.md` and `.planning/ROADMAP.md`. Identify the current phase and its PLAN.md files. Parse plan frontmatter for wave assignments and dependencies.

  2. **Create team:**
     ```
     Teammate({ operation: "spawnTeam", team_name: "mow-{project-slug}" })
     ```

  3. **Record team start in STATE.md:**
     ```bash
     node ~/.claude/mowism/bin/mow-tools.cjs team-update --action start --team-name "mow-{project-slug}"
     ```

  4. **Create tasks from plans (one task per incomplete plan):**
     ```
     TaskCreate({
       subject: "Execute {plan_id}: {plan_objective}",
       description: "Execute plan at {phase_dir}/{plan_file}. Follow the execute-plan workflow at ~/.claude/mowism/workflows/execute-plan.md. Working directory: {worktree_path}. After completion, send a message to the lead with the SUMMARY.md contents.",
     })
     ```

  5. **Set up wave dependencies:**
     ```
     TaskUpdate({ taskId: "{wave2_task}", addBlockedBy: ["{wave1_task_ids}"] })
     ```
     Wave 2 tasks are blocked by all Wave 1 tasks. Wave 3 blocked by Wave 2. Etc.

  6. **Spawn workers (one per available worktree):**
     - Use `wt list --format=json` to discover available worktrees
     - For each worktree, spawn a worker:
     ```
     Task({
       team_name: "mow-{project-slug}",
       name: "worker-{worktree-name}",
       prompt: "You are a Mowism worker in team mow-{project-slug}. Your working directory is {worktree_path}. Check TaskList() for available tasks. Claim a task, execute the plan using the execute-plan workflow, mark it complete when done, and send a summary message to the lead. Repeat until no tasks remain.",
       run_in_background: true
     })
     ```
     - Record each worker in STATE.md:
     ```bash
     node ~/.claude/mowism/bin/mow-tools.cjs team-update --action add-teammate --name "worker-{name}" --worktree "{path}" --task "(pending)"
     ```

  7. **Monitor:** Wait for inbox messages. As workers complete tasks:
     - Update teammate status in STATE.md via `team-update --action update-teammate`
     - Check if wave dependencies are satisfied for next wave tasks

  8. **Completion:** When all tasks done:
     - Request shutdown for all workers
     - Run `team-update --action stop`
     - Report summary to user

  **Critical constraints (from research anti-patterns):**
  - "NEVER implement tasks yourself. You are a coordinator, not an executor."
  - "NEVER modify files that workers might be editing. Workers own their worktree files."
  - "Use targeted Teammate write messages, not broadcast, for routine updates (broadcast is expensive)."
  - "Only offer Agent Teams when phase has 3+ independent plans (token cost consideration)."
  - "Each worker MUST operate in its own worktree for file isolation."

  **Per discretion decision:** Lead is a router (active task management), not passive monitor. The lead creates tasks, assigns dependencies, spawns workers, and synthesizes results.

  Also copy this file to `~/.claude/agents/mow-team-lead.md` during execution (matching the Phase 1 install pattern).
  </action>
  <verify>Read agents/mow-team-lead.md and confirm it contains: spawnTeam, TaskCreate, TaskUpdate with addBlockedBy, Task with team_name, mow-tools.cjs team-update references, and the "NEVER implement tasks yourself" constraint.</verify>
  <done>Lead orchestrator agent definition exists with complete orchestration flow using Agent Teams API primitives, STATE.md tracking via mow-tools.cjs, and explicit coordination-only constraints.</done>
</task>

<task type="auto">
  <name>Task 2: Create /mow:team-status command</name>
  <files>commands/mow/team-status.md</files>
  <action>
  Create `commands/mow/team-status.md` as a Claude Code command. Per locked decision, the lead session has a /mow:team-status command showing all workers and their current tasks.

  Frontmatter:
  ```yaml
  ---
  name: mow:team-status
  description: Show agent team status and teammate assignments
  allowed-tools:
    - Read
    - Bash
  ---
  ```

  The command should:
  1. Run `node ~/.claude/mowism/bin/mow-tools.cjs team-status --raw` to get structured team data
  2. If team is active (`active: true`):
     - Display team name and start time
     - Display teammates table with columns: Teammate, Worktree, Current Task, Status, Last Update
     - Show task summary: pending/in-progress/completed counts
  3. If no team active (`active: false`):
     - Display "No agent team is currently active."
     - Suggest: "Start a team with /mow:execute-phase (requires Agent Teams enabled)"
  4. Also check for live team config at `~/.claude/teams/mow-*/config.json` and cross-reference with STATE.md data

  Format output as a clean markdown table for readability.

  Also install to `~/.claude/commands/mow/team-status.md`.
  </action>
  <verify>Read commands/mow/team-status.md and confirm it has proper frontmatter, calls mow-tools.cjs team-status, and handles both active and inactive team states.</verify>
  <done>/mow:team-status command exists, reads team status from mow-tools.cjs, displays formatted teammate table when active, and shows helpful suggestion when no team is running.</done>
</task>

</tasks>

<verification>
- agents/mow-team-lead.md exists with Agent Teams API primitives and coordination flow
- commands/mow/team-status.md exists with proper frontmatter and team status display logic
- Lead agent references mow-tools.cjs team-update for STATE.md tracking
- Lead agent explicitly prohibits direct implementation
</verification>

<success_criteria>
- Lead orchestrator agent has complete playbook for team creation, task management, worker spawning, monitoring, and cleanup
- Lead uses only Agent Teams API primitives (no custom coordination)
- /mow:team-status command provides formatted view of team activity from STATE.md
- Both files installed to ~/.claude/ locations
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-teams-and-distribution/03-04-SUMMARY.md`
</output>
