---
phase: 03-agent-teams-and-distribution
plan: 05
type: execute
wave: 2
depends_on:
  - "03-01"
  - "03-02"
files_modified:
  - mowism/workflows/new-project.md
  - mowism/workflows/resume-project.md
  - mowism/workflows/execute-phase.md
autonomous: true
requirements:
  - TEAM-01
  - TEAM-02

must_haves:
  truths:
    - "/mow:new-project workflow offers Agent Teams setup when env var is enabled and phase has 3+ independent plans"
    - "/mow:new-project workflow shows prominent nudge with exact enable instructions when Agent Teams is not enabled"
    - "Nudge can be dismissed with 'don't remind me' and dismiss persists in .planning/config.json"
    - "/mow:resume-work workflow offers team re-spawn when STATE.md shows previous team activity"
    - "/mow:execute-phase workflow shows prominent nudge when Agent Teams is not enabled"
    - "Lighter tooltips appear between phases when nudge is dismissed but Agent Teams still not enabled"
    - "First use of new-project always shows nudge regardless of dismiss state (new project exception)"
    - "Modified workflows exist in both the repo (mowism/workflows/) and installed location (~/.claude/mowism/workflows/)"
  artifacts:
    - path: "mowism/workflows/new-project.md"
      provides: "Agent Teams offer and nudge integration (repo copy)"
      contains: "agent_teams"
    - path: "mowism/workflows/resume-project.md"
      provides: "Team re-spawn offer (repo copy)"
      contains: "agent_teams"
    - path: "mowism/workflows/execute-phase.md"
      provides: "Agent Teams nudge at execute-phase (repo copy)"
      contains: "agent_teams"
  key_links:
    - from: "mowism/workflows/new-project.md"
      to: "bin/mow-tools.cjs"
      via: "init new-project returns agent_teams_enabled and agent_teams_nudge_dismissed"
      pattern: "agent_teams_enabled"
    - from: "mowism/workflows/new-project.md"
      to: "agents/mow-team-lead.md"
      via: "spawns lead orchestrator when user opts into Agent Teams"
      pattern: "mow-team-lead"
    - from: "mowism/workflows/resume-project.md"
      to: ".planning/STATE.md"
      via: "reads Agent Team Status section for re-spawn decision"
      pattern: "Agent Team Status"
    - from: "mowism/workflows/*.md"
      to: "~/.claude/mowism/workflows/*.md"
      via: "cp to install location after editing repo copies"
      pattern: "cp.*mowism/workflows"
---

<objective>
Integrate Agent Teams offers and nudges into the new-project, resume-work, and execute-phase workflows.

Purpose: Users need to be offered Agent Teams at key moments (TEAM-01: new-project, TEAM-02: resume-work) and nudged when they don't have it enabled (per locked decisions). These are the user-facing touchpoints that connect the Agent Teams infrastructure (Plans 03-01, 03-04) to the actual user experience. Edits are made to the REPO copies (mowism/workflows/) so that install.sh distributes them correctly, then copied to ~/.claude/ for the current install.

Output: Modified workflow files in mowism/workflows/ with Agent Teams integration, also installed to ~/.claude/mowism/workflows/.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-teams-and-distribution/03-RESEARCH.md
@.planning/phases/03-agent-teams-and-distribution/03-01-SUMMARY.md
@mowism/workflows/new-project.md
@mowism/workflows/resume-project.md
@mowism/workflows/execute-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Agent Teams offer and nudge to new-project workflow</name>
  <files>mowism/workflows/new-project.md</files>
  <action>
  Modify the REPO copy at `mowism/workflows/new-project.md` (NOT ~/.claude/mowism/workflows/new-project.md) to add Agent Teams integration. Add a new step after the project setup is complete (after roadmap approval, before final output):

  **Agent Teams offer/nudge step:**

  Read the `agent_teams_enabled` and `agent_teams_nudge_dismissed` values from the init JSON (already loaded in Step 1).

  **Case 1: Agent Teams IS enabled (`agent_teams_enabled: true`):**
  - After roadmap is approved and has phases with 3+ plans, offer:
    "Agent Teams is enabled. Would you like to set up parallel execution with a lead orchestrator and workers across worktrees? (yes/no)"
  - If yes: spawn the lead orchestrator using the mow-team-lead agent definition. The lead will handle team creation, task assignment, and worker spawning.
  - If no: continue with standard sequential execution.

  **Case 2: Agent Teams is NOT enabled (`agent_teams_enabled: false`):**
  - **If this is a new project (always nudge per locked decision, regardless of dismiss state):**
    Show prominent nudge block:
    ```
    ---
    ## Agent Teams: Parallel Execution

    Mowism works great solo, but its most powerful feature is running
    multiple Claude Code sessions in parallel across git worktrees.

    **To enable Agent Teams:**

    Option A (shell):
      export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1

    Option B (settings.json):
      Add to ~/.claude/settings.json:
      { "env": { "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1" } }

    Then restart Claude Code.

    With Agent Teams, /mow:execute-phase spawns workers that each
    handle a plan in their own worktree -- simultaneously.

    > Type "don't remind me" to dismiss for this project.
    ---
    ```
  - If user says "don't remind me": run `node ~/.claude/mowism/bin/mow-tools.cjs config nudge-dismiss`

  **Per locked decisions:**
  - Prominent nudge at /mow:new-project (key moment)
  - Always nudge once at start of new project regardless of dismiss state
  - Persistent per-project dismiss saved to project config

  **After editing the repo copy**, install it to the current user's location:
  ```bash
  cp mowism/workflows/new-project.md ~/.claude/mowism/workflows/new-project.md
  ```
  This ensures both the repo (for future installs via install.sh) and the current install are updated.
  </action>
  <verify>Read `mowism/workflows/new-project.md` (repo copy) and confirm it checks agent_teams_enabled, shows prominent nudge when not enabled, offers team setup when enabled, and handles dismiss. Then verify `~/.claude/mowism/workflows/new-project.md` matches via `diff mowism/workflows/new-project.md ~/.claude/mowism/workflows/new-project.md`.</verify>
  <done>new-project workflow in REPO (mowism/workflows/) shows Agent Teams offer when enabled, prominent nudge when not enabled (always for new projects), and supports "don't remind me" dismiss. Installed copy at ~/.claude/ matches.</done>
</task>

<task type="auto">
  <name>Task 2: Add team re-spawn offer to resume-work and nudge to execute-phase</name>
  <files>mowism/workflows/resume-project.md, mowism/workflows/execute-phase.md</files>
  <action>
  Edit the REPO copies of both workflows (NOT the ~/.claude/ copies). This ensures install.sh distributes the Agent Teams integration to new users.

  **mowism/workflows/resume-project.md modifications:**

  Add a step after loading state (after Step load_state):

  1. Check `agent_teams_enabled` from init JSON
  2. Read STATE.md Agent Team Status section (via `node ~/.claude/mowism/bin/mow-tools.cjs team-status --raw`)
  3. **If Agent Teams is enabled AND previous team activity exists in STATE.md:**
     - Show: "A previous agent team was active for this project. Would you like to re-spawn the team to continue parallel execution? (yes/no)"
     - If yes: read incomplete plans from STATE.md/ROADMAP.md, spawn fresh lead orchestrator (Agent Teams has NO session resumption per research -- must create fresh team)
     - If no: continue with standard resume flow
  4. **If Agent Teams is NOT enabled AND NOT dismissed:** Show lighter tooltip:
     "Tip: Agent Teams can execute this phase's plans in parallel. Enable: export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1"

  Per discretion: offer team re-spawn during resume-work (recommended by research since it's the ONLY option for continuing team work after session end).

  **mowism/workflows/execute-phase.md modifications:**

  Add nudge logic after the initialize step (after worktree claim):

  1. Check `agent_teams_enabled` and `agent_teams_nudge_dismissed` from init JSON
  2. **If Agent Teams IS enabled:** No nudge needed. (The lead orchestrator handles team setup separately when invoked.)
  3. **If Agent Teams is NOT enabled:**
     - **If not dismissed:** Show prominent nudge (same format as new-project but contextual):
       ```
       This phase has {N} plans across {M} waves. With Agent Teams,
       these plans could execute in parallel across worktrees.
       ```
       Include enable instructions. Support "don't remind me" dismiss.
     - **If dismissed:** Show lighter tooltip only:
       "Tip: Agent Teams can execute this phase's {N} plans in parallel. Enable: export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1"

  Per locked decisions:
  - Prominent nudge at /mow:execute-phase (key moment)
  - Lighter tooltips between phases highlighting productivity gains
  - Persistent per-project dismiss

  **After editing both repo copies**, install them to the current user's location:
  ```bash
  cp mowism/workflows/resume-project.md ~/.claude/mowism/workflows/resume-project.md
  cp mowism/workflows/execute-phase.md ~/.claude/mowism/workflows/execute-phase.md
  ```
  This ensures both the repo (for future installs via install.sh) and the current install are updated.
  </action>
  <verify>Read both repo copies and confirm: `mowism/workflows/resume-project.md` checks for previous team activity and offers re-spawn; `mowism/workflows/execute-phase.md` shows prominent nudge when not dismissed and lighter tooltip when dismissed. Then verify installed copies match: `diff mowism/workflows/resume-project.md ~/.claude/mowism/workflows/resume-project.md && diff mowism/workflows/execute-phase.md ~/.claude/mowism/workflows/execute-phase.md`.</verify>
  <done>resume-project workflow (repo copy) offers team re-spawn from STATE.md when Agent Teams is enabled. execute-phase workflow (repo copy) shows prominent nudge (not dismissed) or lighter tooltip (dismissed) when Agent Teams is not enabled. Both installed copies at ~/.claude/ match the repo copies.</done>
</task>

</tasks>

<verification>
- mowism/workflows/new-project.md (REPO) contains agent_teams_enabled check and prominent nudge block
- mowism/workflows/new-project.md (REPO) offers team setup when Agent Teams is enabled
- mowism/workflows/resume-project.md (REPO) checks for previous team activity and offers re-spawn
- mowism/workflows/execute-phase.md (REPO) shows nudge or tooltip based on dismiss state
- All three repo workflow files reference mow-tools.cjs for config/state operations
- All three installed copies at ~/.claude/mowism/workflows/ match the repo copies
- `diff mowism/workflows/new-project.md ~/.claude/mowism/workflows/new-project.md` shows no differences
</verification>

<success_criteria>
- TEAM-01: /mow:new-project offers Agent Teams setup with lead orchestrator
- TEAM-02: /mow:resume-work offers team re-spawn from STATE.md
- Nudge appears prominently at new-project and execute-phase, with lighter tooltips elsewhere
- Dismiss persists via mow-tools.cjs config nudge-dismiss
- New projects always get one nudge regardless of dismiss state
- Repo copies (mowism/workflows/) contain all changes so install.sh distributes them to new users
- Installed copies (~/.claude/mowism/workflows/) are updated to match via cp
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-teams-and-distribution/03-05-SUMMARY.md`
</output>
