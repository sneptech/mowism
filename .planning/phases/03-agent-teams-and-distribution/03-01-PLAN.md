---
phase: 03-agent-teams-and-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/mow-tools.cjs
  - bin/mow-tools.test.cjs
autonomous: true
requirements:
  - TEAM-04
  - TEAM-05

must_haves:
  truths:
    - "mow-tools.cjs init functions return agent_teams_enabled and agent_teams_nudge_dismissed in output JSON"
    - "Without CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1, agent_teams_enabled is false"
    - "With CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1, agent_teams_enabled is true"
    - "Nudge dismiss state reads from .planning/config.json agent_teams_nudge_dismissed field"
    - "mow-tools.cjs has team-status subcommands for recording and reading agent team status in STATE.md"
  artifacts:
    - path: "bin/mow-tools.cjs"
      provides: "checkAgentTeams(), Agent Teams team-status subcommands, nudge dismiss config reading"
      contains: "checkAgentTeams"
    - path: "bin/mow-tools.test.cjs"
      provides: "Tests for Agent Teams env detection and team-status state management"
      contains: "checkAgentTeams"
  key_links:
    - from: "bin/mow-tools.cjs"
      to: "process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS"
      via: "checkAgentTeams function"
      pattern: "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS"
    - from: "bin/mow-tools.cjs"
      to: ".planning/STATE.md"
      via: "team-status subcommands"
      pattern: "Agent Team Status"
    - from: "bin/mow-tools.cjs"
      to: ".planning/config.json"
      via: "nudge dismiss flag reading"
      pattern: "agent_teams_nudge_dismissed"
---

<objective>
Add Agent Teams detection and team-status state management to mow-tools.cjs.

Purpose: Every workflow needs to know whether Agent Teams is available and whether the user has dismissed the nudge. Team status tracking in STATE.md is required for TEAM-05 and consumed by the lead orchestrator (Plan 03-04) and workflow integrations (Plan 03-05).

Output: Updated mow-tools.cjs with checkAgentTeams(), team-status subcommands, nudge config reading, and tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-teams-and-distribution/03-RESEARCH.md
@bin/mow-tools.cjs
@bin/mow-tools.test.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add checkAgentTeams and integrate into init functions</name>
  <files>bin/mow-tools.cjs</files>
  <action>
  1. Add a `checkAgentTeams()` function near the existing `checkWorkTrunk()` function (after line ~172). It should:
     - Check `process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS === '1'` first (shell-level env var)
     - If not set, check `~/.claude/settings.json` for `env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS === '1'` as fallback
     - Return `{ enabled: boolean, source: 'env' | 'settings' | null }`

  2. Add a helper function `getAgentTeamsNudgeDismissed(cwd)` that reads `.planning/config.json` and returns `config.agent_teams_nudge_dismissed || false`.

  3. Add `agent_teams_enabled` and `agent_teams_nudge_dismissed` to the output JSON of these init functions:
     - `cmdInitNewProject` -- prominent nudge point (per locked decision)
     - `cmdInitExecutePhase` -- prominent nudge point (per locked decision)
     - `cmdInitResume` -- for team re-spawn offer

     Pattern: call `checkAgentTeams()` and `getAgentTeamsNudgeDismissed(cwd)`, add to result object:
     ```
     agent_teams_enabled: checkAgentTeams().enabled,
     agent_teams_nudge_dismissed: getAgentTeamsNudgeDismissed(cwd),
     ```

  4. Add a `config nudge-dismiss` subcommand to the CLI router that writes `{ "agent_teams_nudge_dismissed": true, "agent_teams_nudge_dismissed_at": "YYYY-MM-DD" }` to `.planning/config.json` (merging with existing config, not overwriting). This is called when the user says "don't remind me".

  5. Do NOT add Agent Teams as a hard requirement (no `requireAgentTeams()`). It is always optional per locked decisions.
  </action>
  <verify>Run `node bin/mow-tools.cjs init new-project --raw 2>/dev/null | node -e "const j=JSON.parse(require('fs').readFileSync('/dev/stdin','utf-8')); console.log('agent_teams_enabled' in j, 'agent_teams_nudge_dismissed' in j)"` -- should output `true true`.</verify>
  <done>All three init functions return agent_teams_enabled and agent_teams_nudge_dismissed. checkAgentTeams correctly detects env var and settings.json fallback. config nudge-dismiss subcommand writes to .planning/config.json.</done>
</task>

<task type="auto">
  <name>Task 2: Add team-status subcommands for STATE.md tracking</name>
  <files>bin/mow-tools.cjs, bin/mow-tools.test.cjs</files>
  <action>
  1. Add `cmdTeamStatus(cwd, raw)` function that reads STATE.md and extracts the "Agent Team Status" section, returning structured JSON:
     ```
     { active: boolean, team_name: string|null, teammates: [{name, worktree, task, status, last_update}], started: string|null }
     ```
     If no "Agent Team Status" section exists, return `{ active: false, team_name: null, teammates: [], started: null }`.

  2. Add `cmdTeamUpdate(cwd, options, raw)` function that updates the Agent Team Status section in STATE.md. Options:
     - `--action start --team-name <name>` -- create the section with team name, started date, empty teammates table
     - `--action add-teammate --name <name> --worktree <wt> --task <task>` -- add a row to the teammates table
     - `--action update-teammate --name <name> --status <status> --task <task>` -- update an existing teammate row
     - `--action stop` -- remove the Agent Team Status section (team finished)

     Use the same table parsing pattern as `parseWorktreeTable`/`writeWorktreeTable` but for the teammates table. Section header: `## Agent Team Status`. Table columns: `| Teammate | Worktree | Task | Status | Last Update |`.

  3. Add CLI router entries:
     - `team-status` -> `cmdTeamStatus(cwd, raw)`
     - `team-update` with `--action`, `--team-name`, `--name`, `--worktree`, `--task`, `--status` -> `cmdTeamUpdate(cwd, options, raw)`

  4. Add tests in mow-tools.test.cjs:
     - Test `checkAgentTeams()` returns `{ enabled: false, source: null }` when env var is not set
     - Test `team-status` returns `{ active: false }` when no section exists
     - Test `team-update --action start` creates the section
     - Test `team-update --action add-teammate` adds a row
     - Test `team-update --action stop` removes the section
  </action>
  <verify>Run `node bin/mow-tools.test.cjs 2>&1 | tail -5` -- all tests pass, including new Agent Teams tests.</verify>
  <done>team-status and team-update subcommands work correctly. STATE.md gets a properly formatted "Agent Team Status" section with teammates table. Tests pass.</done>
</task>

</tasks>

<verification>
- `node bin/mow-tools.cjs init new-project --raw` includes `agent_teams_enabled` and `agent_teams_nudge_dismissed`
- `node bin/mow-tools.cjs init execute-phase 01 --raw` includes `agent_teams_enabled` and `agent_teams_nudge_dismissed`
- `node bin/mow-tools.cjs init resume --raw` includes `agent_teams_enabled` and `agent_teams_nudge_dismissed`
- `node bin/mow-tools.cjs team-status --raw` returns valid JSON with `active` field
- All existing + new tests pass
</verification>

<success_criteria>
- checkAgentTeams() correctly detects Agent Teams env var (direct and settings.json fallback)
- Three init functions expose agent_teams_enabled and agent_teams_nudge_dismissed
- team-status reads STATE.md agent team section
- team-update manages STATE.md agent team section (start/add-teammate/update-teammate/stop)
- config nudge-dismiss writes dismiss flag to .planning/config.json
- All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-teams-and-distribution/03-01-SUMMARY.md`
</output>
