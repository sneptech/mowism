---
phase: 05-fix-update-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mowism/workflows/update.md
  - commands/mow/update.md
  - help/update.md
  - commands/mow/reapply-patches.md
  - help/reapply-patches.md
autonomous: true
requirements:
  - "DIST-01 (fix)"

must_haves:
  truths:
    - "User who installed via install.sh can run /mow:update and get a working update flow (not a dead-end 'advise manual setup' message)"
    - "User who installed via git clone can still run /mow:update with git pull (existing path not broken)"
    - "User running /mow:update when no repo URL is configured gets a clear error with instructions, not a silent failure"
    - "/mow:reapply-patches with no patches gives an honest message (no false 'automatically saved' claim)"
    - "No npm, changelog, cache clearing, or local-vs-global references remain in any update-related file"
    - "No stale Phase 3 note remains in the update workflow"
  artifacts:
    - path: "mowism/workflows/update.md"
      provides: "Dual-path update workflow (GIT_CLONE and INSTALL_SH branches)"
      contains: "INSTALL_SH"
    - path: "commands/mow/update.md"
      provides: "Command definition routing to update workflow"
      contains: "installation method detection"
    - path: "help/update.md"
      provides: "User-facing help for /mow:update"
      contains: "Detects how Mowism was installed"
    - path: "commands/mow/reapply-patches.md"
      provides: "Command definition for reapply-patches"
      contains: "manually"
    - path: "help/reapply-patches.md"
      provides: "User-facing help for /mow:reapply-patches"
      contains: "manually"
  key_links:
    - from: "commands/mow/update.md"
      to: "mowism/workflows/update.md"
      via: "execution_context reference"
      pattern: "workflows/update\\.md"
    - from: "mowism/workflows/update.md"
      to: "bin/install.sh"
      via: "bash execution for INSTALL_SH update path"
      pattern: "install\\.sh"
---

<objective>
Fix the update workflow to work after install.sh installation, clean up all stale npm/GSD-era references in update-related files, and make reapply-patches honest about current capabilities.

Purpose: Users who installed via install.sh (the recommended method) currently cannot update at all -- the workflow hits a dead end. This plan adds a working INSTALL_SH update path, cleans up stale references from the GSD/npm era, and removes false promises about automatic patch saving. Closes INT-01 and FLOW-01 from the v1.0 audit.

Output: 5 updated markdown files (1 workflow, 2 commands, 2 help files) with working dual-path update logic and honest messaging.
</objective>

<execution_context>
@/home/max/.claude/get-shit-done/workflows/execute-plan.md
@/home/max/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-fix-update-workflow/05-RESEARCH.md
@bin/install.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite update workflow with dual-path support (GIT_CLONE + INSTALL_SH)</name>
  <files>mowism/workflows/update.md</files>
  <action>
Rewrite `mowism/workflows/update.md` to support two installation methods while preserving the existing GIT_CLONE path.

The workflow must have these steps:

**Step 1 (check_installation):** Detection logic with THREE branches:
- `GIT_CLONE`: `~/.claude/mowism/.git` exists -- proceed with git pull path (EXISTING behavior, keep as-is)
- `INSTALL_SH`: `~/.claude/mowism/VERSION` exists but no `.git` -- proceed with new install.sh re-run path
- `NOT_FOUND`: Neither exists -- show install instructions and exit

**Step 2 (resolve_repo_source):** Determine where to get updates from.
- Check for a local repo path first: if a file `~/.claude/mowism/.update-source` exists, read the URL/path from it
- If not set, check if there is a `git remote get-url origin` available (for GIT_CLONE method)
- If neither available, show a clear error:
  ```
  No update source configured.

  To configure, create ~/.claude/mowism/.update-source containing
  the path or URL to the Mowism repository. For example:

    echo "https://github.com/youruser/mowism" > ~/.claude/mowism/.update-source

  Or for a local repo:

    echo "/home/you/git/mowism" > ~/.claude/mowism/.update-source
  ```
  Exit.

**Step 3 (check_for_updates):** For GIT_CLONE method, keep existing git fetch + compare logic. For INSTALL_SH method:
- Clone (shallow, depth 1) or copy from the source to a temp directory (`mktemp -d`)
- Read current VERSION from `~/.claude/mowism/VERSION`
- Read new VERSION from `$TMPDIR/mowism/mowism/VERSION` (if source is a git URL -- note the repo contains a `mowism/` subdirectory where VERSION lives) or `$SOURCE/mowism/VERSION` (if local path)
- If versions match, report "already up to date" and clean up temp dir, exit
- If different, show current vs latest version

**Step 4 (show_changes_and_confirm):** Show what changed and ask for confirmation via AskUserQuestion. For GIT_CLONE: show `git log --oneline HEAD..@{u}`. For INSTALL_SH: show git log between version tags if available, or just show version difference.

**Step 5 (run_update):** For GIT_CLONE: `cd ~/.claude/mowism && git pull`. For INSTALL_SH: Run `bash $TMPDIR/mowism/bin/install.sh` (or `bash $SOURCE/bin/install.sh` for local path). Then clean up the temp directory.

**Step 6 (display_result):** Show success message with restart reminder.

IMPORTANT:
- Remove the stale `<note>` at the bottom that says "Full install/update tooling (npm package, installer script) is planned for Phase 3 (DIST-01)."
- The existing GIT_CLONE path (steps: check .git, git fetch, git pull) must remain functional -- do NOT break it
- For INSTALL_SH path, handle cleanup of temp directory on both success and failure (use trap or explicit cleanup in error paths)
- Support both URL sources (starts with http/git/ssh) and local directory paths (exists on disk) for the update source
- Keep the `<purpose>`, `<process>`, `<success_criteria>` XML structure consistent with the existing file format
  </action>
  <verify>
Read the rewritten `mowism/workflows/update.md` and confirm:
1. It contains "INSTALL_SH" and "GIT_CLONE" branches
2. It contains `install.sh` execution for the INSTALL_SH path
3. It has no `<note>` referencing Phase 3 or npm
4. It handles `.update-source` for repo URL configuration
5. It includes temp directory cleanup
6. Run `grep -c 'npm' mowism/workflows/update.md` -- must return 0
7. VERSION path for cloned repo uses `$TMPDIR/mowism/mowism/VERSION` (not `$TMPDIR/mowism/VERSION`)
8. Run `grep -c 'Phase 3' mowism/workflows/update.md` -- must return 0
  </verify>
  <done>Update workflow has working dual-path logic: GIT_CLONE uses git pull (preserved), INSTALL_SH clones to temp and re-runs install.sh, NOT_FOUND shows install instructions. Stale Phase 3 note removed. Repo URL is configurable via .update-source file. VERSION file path correctly accounts for the mowism/ subdirectory within the cloned repo.</done>
</task>

<task type="auto">
  <name>Task 2: Fix stale references in update and reapply-patches command/help files</name>
  <files>commands/mow/update.md, help/update.md, commands/mow/reapply-patches.md, help/reapply-patches.md</files>
  <action>
Fix 4 files to remove stale npm/GSD-era references and false automation claims.

**commands/mow/update.md:**
Rewrite the `<objective>` section. Replace the current description that references "npm version checking", "Changelog fetching and display", "clean install warning", and "cache clearing" with an accurate description:
```
Check for MOW updates and install if available.

Routes to the update workflow which handles:
- Installation method detection (git clone vs install.sh)
- Update source resolution (remote URL or local path)
- Version comparison
- User confirmation before updating
- Update execution (git pull or re-run install.sh)
- Restart reminder
```

Rewrite the `<process>` section. Replace the current list that references "npm", "changelog fetching", "clean install warning display", and "cache clearing" with:
```
**Follow the update workflow** from `@~/.claude/mowism/workflows/update.md`.

The workflow handles all logic including:
1. Installation method detection (git clone vs install.sh)
2. Update source resolution
3. Version checking
4. Change display and user confirmation
5. Update execution
6. Post-update restart reminder
```

**help/update.md:**
Rewrite the "What Happens" section. Replace references to "local vs global installation", "changelog", "clean install", and "clears caches" with:
```
1. Detects how Mowism was installed (git clone or install.sh)
2. Resolves update source (configured URL or local path)
3. Checks for latest version available
4. Shows what's new (version comparison, commit log if available)
5. Asks for confirmation before proceeding
6. Runs the update (git pull or re-run install.sh)
7. Reminds to restart Claude Code for changes to take effect
```

**commands/mow/reapply-patches.md:**
Find the "If no patches found" message block that currently says:
```
No local patches found. Nothing to reapply.

Local patches are automatically saved when you run /mow:update
after modifying any MOW workflow, command, or agent files.
```

Replace with:
```
No local patches found. Nothing to reapply.

To preserve local modifications before updating:
1. Identify files you have modified in ~/.claude/
2. Copy them to a safe location before running /mow:update
3. After updating, manually merge your changes back

Automatic patch detection may be added in a future version.
```

Also update the `<purpose>` section to remove the false claim that update "wipes and reinstalls files" with automatic backup. Replace with: "After a MOW update, this command helps merge any previously saved local modifications back into the updated installation. Uses intelligent comparison to handle cases where the upstream file also changed."

**help/reapply-patches.md:**
In the "Related" section, change:
```
    /mow:update    Update MOW (creates backups automatically)
```
to:
```
    /mow:update    Update MOW to latest version
```

Review the "What Happens" section. Step 1 says "Checks for backed-up patches" which is fine (accurate). But ensure no step claims patches are "automatically" created by /mow:update. The existing steps 1-8 are mostly fine since they describe what happens IF patches exist. No changes needed to steps 1-8 unless they contain false automation claims.
  </action>
  <verify>
Run these grep checks across all 5 modified files to confirm no stale references remain:
```bash
grep -rn 'npm' commands/mow/update.md help/update.md mowism/workflows/update.md commands/mow/reapply-patches.md help/reapply-patches.md
grep -rn 'changelog' commands/mow/update.md help/update.md
grep -rn 'cache clear' commands/mow/update.md help/update.md
grep -rn 'local vs global\|local/global' commands/mow/update.md help/update.md
grep -rn 'automatically saved' commands/mow/reapply-patches.md help/reapply-patches.md
grep -rn 'creates backups automatically' help/reapply-patches.md
grep -rn 'Phase 3' mowism/workflows/update.md
```
All of these must return zero matches.
  </verify>
  <done>All 4 command/help files updated: update command and help describe git-based dual-path workflow (no npm/changelog/cache references), reapply-patches gives honest "no patches" message without false automation claims, help file does not claim /mow:update creates automatic backups.</done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full set of phase success criteria:

1. **INSTALL_SH update path exists:** `grep 'INSTALL_SH' mowism/workflows/update.md` returns matches
2. **GIT_CLONE path preserved:** `grep 'GIT_CLONE\|git pull' mowism/workflows/update.md` returns matches
3. **install.sh called:** `grep 'install.sh' mowism/workflows/update.md` returns matches
4. **No npm references:** `grep -r 'npm' mowism/workflows/update.md commands/mow/update.md help/update.md` returns 0 matches
5. **No stale Phase 3 note:** `grep 'Phase 3' mowism/workflows/update.md` returns 0 matches
6. **No false auto-save claim:** `grep 'automatically saved' commands/mow/reapply-patches.md` returns 0 matches
7. **Honest reapply-patches message:** `grep 'manually' commands/mow/reapply-patches.md` returns matches
8. **Configurable repo URL:** `grep 'update-source' mowism/workflows/update.md` returns matches
9. **Correct VERSION path for cloned repo:** `grep 'TMPDIR/mowism/mowism/VERSION' mowism/workflows/update.md` returns matches
</verification>

<success_criteria>
- The update workflow in `mowism/workflows/update.md` has a working INSTALL_SH branch that clones to temp dir and re-runs install.sh
- The existing GIT_CLONE branch (git fetch + git pull) still works unmodified
- The workflow handles "no repo URL configured" with a clear error and instructions
- `commands/mow/update.md` describes installation method detection, not npm/changelog
- `help/update.md` describes dual-path git-based workflow, not npm/cache clearing
- `commands/mow/reapply-patches.md` gives honest "no patches" message with manual backup instructions
- `help/reapply-patches.md` does not claim /mow:update creates automatic backups
- Zero occurrences of: npm, changelog, cache clearing, "automatically saved", Phase 3 note across all 5 files
- VERSION file path in INSTALL_SH clone path correctly uses $TMPDIR/mowism/mowism/VERSION (not $TMPDIR/mowism/VERSION)
</success_criteria>

<output>
After completion, create `.planning/phases/05-fix-update-workflow/05-01-SUMMARY.md`
</output>
