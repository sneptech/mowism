# Architecture: v1.2 Integration Map

**Domain:** Native worktree adoption, full-lifecycle workers, auto-advance pipeline, GSD bugfix cherry-picks
**Researched:** 2026-02-24
**Confidence:** HIGH (analysis of existing codebase + pre-existing v1.2 research)
**Purpose:** Answer "How do v1.2 features integrate with existing architecture?" for roadmap creation

## Executive Summary

v1.2 is a simplification milestone. The core architectural move is **replacing Mowism's custom worktree creation** (cmdWorktreeCreate, WorkTrunk dependency, manifest.json) **with Claude Code's native `isolation: worktree`** while preserving Mowism's coordination layer (claiming, merge orchestration, DAG scheduling, state tracking). Full-lifecycle workers extend mow-phase-worker.md to chain all lifecycle stages autonomously. Auto-advance (`/mow:auto`) already exists as a `--auto` flag mechanism distributed across 4 workflows -- the new command is a thin entry point. GSD bugfixes are surgical edits to specific mow-tools.cjs functions and workflow files.

No new components are needed except one new command file (`commands/mow/auto.md`). Everything else is modification of existing files.

---

## Component Integration Map

### 1. Native Worktree Adoption (`isolation: worktree`)

**What changes:** Claude Code's `isolation: worktree` in agent YAML frontmatter auto-creates worktrees at `.claude/worktrees/<name>` and auto-cleans on completion. This replaces Mowism's `cmdWorktreeCreate` which manually runs `git worktree add` into `.worktrees/pNN`.

**What stays:** Mowism's coordination layer. Claude Code provides worktree isolation but does NOT provide:
- Phase-to-worktree tracking (which agent owns which phase)
- Claim/conflict prevention (preventing two agents from claiming the same phase)
- Merge orchestration (when/how to merge phase branches back to main)
- Shared state coordination (copying .planning/ between worktrees)

#### Files to REMOVE or gut (custom worktree creation):

| Component | Location | Action |
|-----------|----------|--------|
| `cmdWorktreeCreate` | mow-tools.cjs:6610-6724 | **Remove.** Native worktree creation replaces this. |
| `cmdWorktreeStash` | mow-tools.cjs:6769-6802 | **Remove.** Native worktrees handle cleanup. |
| `readManifest` / `writeManifest` | mow-tools.cjs:6575-6594 | **Remove.** No more `.worktrees/manifest.json`. |
| `getDefaultBranch` | mow-tools.cjs:6597-6608 | **Remove.** Native worktree handles branching. |
| `WT_CONFIG_CONTENT` / `WT_PLANNING_COPY_HOOK` | mow-tools.cjs:798-837 | **Remove.** WorkTrunk config no longer needed. |
| `ensureWtConfig` | mow-tools.cjs:839-850 | **Remove.** WorkTrunk no longer required. |
| `requireWorkTrunk` / `checkWorkTrunk` | mow-tools.cjs:733-757 | **Remove.** WorkTrunk dependency eliminated. |
| WorkTrunk calls in 12 `cmdInit*` functions | mow-tools.cjs (12 call sites) | **Remove.** `requireWorkTrunk()` calls deleted. |
| `worktree create` CLI subcommand | mow-tools.cjs:7603-7611 | **Remove.** |
| `worktree stash` CLI subcommand | mow-tools.cjs:7618 | **Remove.** |
| `worktree list-manifest` CLI subcommand | mow-tools.cjs:7611 | **Remove.** |

#### Files to KEEP (coordination layer):

| Component | Location | Why Keep |
|-----------|----------|----------|
| `cmdWorktreeClaim` | mow-tools.cjs:6927-6978 | Prevents phase conflicts. Operates on STATE.md Worktree Assignments table. |
| `cmdWorktreeRelease` | mow-tools.cjs:6981-6999 | Releases claims on completion. |
| `cmdWorktreeStatus` | mow-tools.cjs:7002-7012 | Shows claim state for dashboard/progress. |
| `cmdWorktreeUpdatePlan` | mow-tools.cjs:7014-7040 | Tracks which plan is active per worktree. |
| `cmdWorktreeClean` | mow-tools.cjs:7059-7127 | Detects stale claims from removed worktrees. |
| `cmdWorktreeMerge` | mow-tools.cjs:6731-6768 | Merge orchestration after phase completion. |
| `cmdWorktreeVerifyResult` | mow-tools.cjs:7131+ | Verification tier tracking per worktree. |
| Worktree Assignments table in STATE.md | STATE.md | Central coordination record. |

#### Files to MODIFY (adapt to native worktree paths):

| Component | Change |
|-----------|--------|
| `mow-team-lead.md` multi_phase_flow Step 2 | Replace `worktree create {phase}` with native teammate spawning using `isolation: worktree`. The lead uses `Task()` with `isolation: worktree` to spawn teammates -- Claude Code creates the worktree automatically. |
| `mow-team-lead.md` single_phase_flow Step 6 | Same: replace `wt list --format=json` worktree discovery with native teammate spawn. |
| `mow-phase-worker.md` Step 1 Initialize | Worktree path comes from the working directory (inherited from native worktree). Remove `cd {worktree_path}` -- the worker IS already in its worktree. |
| `cmdWorktreeClaim` | Currently reads `getRepoRoot(cwd)` to compute worktree path from `.worktrees/pNN`. Update to discover current worktree path via `git rev-parse --show-toplevel` and map to a claim key derived from phase number. |
| `cmdWorktreeMerge` | Currently uses manifest.json for branch lookup. Update to use `git worktree list --porcelain` for active worktree discovery, derive branch from phase number convention. |
| `cmdWorktreeClean` | Currently reads manifest.json + git worktree list. Simplify to just `git worktree list` comparison against STATE.md claims. |
| execute-phase.md `initialize` step | Remove `worktree claim` for non-multi-phase mode (single-user doesn't need claiming). Keep for multi-phase. |

#### .planning/ State Sync (WorktreeCreate hook):

Claude Code's `WorktreeCreate` hook (v2.1.50) runs when a worktree is created. Configure this hook to copy `.planning/` from the main worktree:

```bash
# WorktreeCreate hook in ~/.claude/hooks/ or agent frontmatter
cp -r "${PRIMARY_WORKTREE}/.planning" "${WORKTREE_PATH}/.planning"
```

This replaces both WorkTrunk's `post-create` hook AND the manual `cp -r` in `cmdWorktreeCreate`.

**Key architectural decision:** The hook goes in the Mowism install, NOT in agent frontmatter. `WorktreeCreate` hooks are global to the Claude Code installation, defined in `~/.claude/hooks/`. This means the install script needs to register this hook.

#### WorkTrunk Removal Implications:

- `install.sh` no longer checks for/recommends WorkTrunk
- `.config/wt.toml` no longer auto-created
- README removes WorkTrunk from prerequisites
- `ensureWtConfig()` calls removed from all init commands
- Error message about WorkTrunk dependency removed
- The `wt` CLI is no longer referenced anywhere

---

### 2. Full-Lifecycle Worker Agents

**Current state:** `mow-phase-worker.md` already defines a 5-step lifecycle (Initialize, Context Gathering, Planning, Execute Plans, Phase Complete). The worker chains these stages sequentially. However, the current implementation is manual -- the worker reads workflows inline rather than spawning subagents for each stage.

**What changes:** Workers MUST spawn subagents via `Task()` for each lifecycle stage. This is a constraint from v1.2-NESTED-DELEGATION.md research: subagents CANNOT spawn subagents, so the phase worker (a teammate with full session tools) is the orchestration point.

#### No New Agent File Needed

The existing `mow-phase-worker.md` already has the right structure. The change is to its internal implementation -- each lifecycle step spawns a dedicated subagent rather than executing inline:

| Lifecycle Step | Current Behavior | v1.2 Behavior | Subagent |
|----------------|-----------------|---------------|----------|
| Step 2: Context | Runs discuss-phase workflow inline | `Task()` spawns research subagent (read-only) | mow-phase-researcher or general-purpose |
| Step 3: Planning | Runs plan-phase workflow inline | `Task()` spawns planner subagent | mow-planner (via general-purpose, since skills don't resolve in Task()) |
| Step 4: Execute | Spawns mow-executor via Task() | **Same** (already correct) | mow-executor |
| Step 5: Verify | Verification is part of execute | `Task()` spawns verifier subagent | mow-verifier |

**Critical constraint from research:** Skills (`/mow:*` commands) don't resolve inside `Task()` subagents. The worker must pass workflow content via `@file` references in the Task prompt, not invoke slash commands. This is already the pattern used in Step 4 (executor spawning).

#### Files to MODIFY:

| File | Change |
|------|--------|
| `agents/mow-phase-worker.md` | Rewrite Steps 2-3 to use `Task()` subagent spawning pattern matching Step 4. Add Step 5 (verification) as explicit subagent spawn. Add context passing between stages (each subagent returns results, worker passes to next). |
| `agents/mow-executor.md` | **Minor:** Remove STATE.md writes (line in `<state_updates>` section). Workers handle state, executors just execute. Already partially addressed by the "skip STATE.md in worktree" logic. |

#### Context Accumulation Concern:

Per research: "collecting results from 4+ subagents across full lifecycle grows context." The mitigation is already designed:

1. Each `Task()` subagent operates in its own context window (fresh 200k)
2. The worker receives only the Task() return value (compact summary)
3. Subagents write artifacts to disk (CONTEXT.md, RESEARCH.md, PLAN.md, SUMMARY.md)
4. Next subagent reads from disk, not from worker's context

The worker's context budget: ~15% for lifecycle orchestration + 4 subagent return summaries. Well within safe limits.

#### Discuss-Phase Pause Gate:

In full-lifecycle mode, the discuss-phase step may require user input. The worker ALREADY handles this (Step 2 sends `input_needed` message, waits for user interaction). No architectural change needed -- the existing `input_needed` -> dashboard notification -> user switches to terminal flow is correct.

---

### 3. Auto-Advance Pipeline (`/mow:auto`)

**Current state:** Auto-advance ALREADY EXISTS as a distributed mechanism:
- `--auto` flag parsed in 4 workflows: `discuss-phase.md`, `plan-phase.md`, `execute-phase.md`, `transition.md`
- `workflow.auto_advance` config persisted in `.planning/config.json`
- Chain: discuss -> plan -> execute -> transition -> discuss (next phase)
- Milestone boundary clears auto-advance
- Discuss-phase ALWAYS pauses for user input (hard constraint honored)

**What's missing:** A dedicated `/mow:auto` entry point. Currently, auto-advance is only triggered by:
1. `--auto` flag on individual commands (e.g., `/mow:new-project --auto`)
2. `workflow.auto_advance` config set during new-project setup

#### New Component: `commands/mow/auto.md`

This is the ONLY new file in v1.2. It's a thin command that:

1. Sets `workflow.auto_advance` to `true` in config
2. Detects current project state (which phase, what exists)
3. Invokes the appropriate starting workflow with `--auto` flag

```
User runs: /mow:auto
                |
                v
    Read STATE.md for current position
                |
    +-----------+-----------+
    |           |           |
    v           v           v
  No CONTEXT  Has CONTEXT   Has PLANs
  for phase   no PLANs     incomplete
    |           |           |
    v           v           v
  discuss     plan         execute
  --auto      --auto       --auto
```

#### Files to CREATE:

| File | Purpose |
|------|---------|
| `commands/mow/auto.md` | Entry point for `/mow:auto`. Reads project state, determines starting point, sets config, invokes appropriate workflow with `--auto`. |

#### Files to MODIFY:

| File | Change |
|------|--------|
| `mowism/workflows/discuss-phase.md` | **None.** Auto-advance already implemented in `auto_advance` step. |
| `mowism/workflows/plan-phase.md` | **None.** Auto-advance already implemented in step 14. |
| `mowism/workflows/execute-phase.md` | **None.** Auto-advance already in `offer_next` step. |
| `mowism/workflows/transition.md` | **None.** Already chains to next discuss/plan with `--auto`. |
| `bin/mow-tools.cjs` | Add `init auto` compound command that returns current state + what's needed (similar to `init resume` but focused on auto-advance decision). |
| `commands/mow/help.md` | Add `/mow:auto` to the help index. |

#### Auto-Advance in Multi-Phase Mode:

When the team lead runs multiple phases in parallel, auto-advance is per-worker, not global. Each phase worker independently chains discuss -> plan -> execute. The team lead's DAG controls WHEN phases start (dependency ordering), but once started, each worker auto-advances through its own lifecycle.

**No change needed** to the team lead. Workers already do this via `mow-phase-worker.md`'s 5-step lifecycle. The `--auto` flag just controls checkpoint behavior (auto-approve vs pause).

---

### 4. GSD Upstream Bugfix Integration

Nine bugs mapped to specific locations. Here's the integration plan:

#### Bug 1: STATE.md Dollar Sign Corruption (PR #701)

**Location:** `bin/mow-tools.cjs`
- `cmdStateUpdate` (line 1983): `content.replace(pattern, \`$1${value}\`)`
- `stateReplaceField` (line 2006): Same pattern
- `cmdStateAddDecision` (line 2131): `content.replace(sectionPattern, \`${match[1]}${sectionBody}\`)`
- `cmdStateAddBlocker` (line 2154): Same
- `cmdStateResolveBlocker` (line 2186): Same

**Fix:** Replace all `String.replace(regex, stringWithPotentialDollarSigns)` with callback form:
```javascript
// Before (vulnerable):
content = content.replace(pattern, `$1${value}`);
// After (safe):
content = content.replace(pattern, (_, prefix) => `${prefix}${value}`);
```

**Scope:** 5 sites in `bin/mow-tools.cjs`. Easy fix, zero architectural impact.

#### Bug 2: Phase Requirement IDs Not Propagating (PR #702)

**Location:** `bin/mow-tools.cjs`
- `cmdInitPlanPhase` (line 5928): Does not extract Requirements field from ROADMAP phase section
- `cmdInitExecutePhase` (line 5849): Same gap

**Fix:** In both init functions, after extracting phase info from `findPhaseInternal`, also call `getRoadmapPhaseInternal` (or equivalent) to extract the `**Requirements:**` line from the ROADMAP.md phase section. Add `phase_req_ids` to the returned JSON.

**Scope:** 2 functions in `bin/mow-tools.cjs`. Moderate -- needs to parse ROADMAP.md section for requirements field.

#### Bug 3: Feature Branch Created Too Late (PR #512)

**Location:** Workflows
- `mowism/workflows/discuss-phase.md`: No `handle_branching` step
- `mowism/workflows/plan-phase.md`: No `handle_branching` step (execute-phase has it at step `handle_branching`)

**Fix:** Add a `handle_branching` step after `initialize` in both workflows, identical to the one in execute-phase.md. When `branching_strategy: "phase"`, create/switch to the phase branch before making commits.

**Scope:** 2 workflow files. Easy -- copy pattern from execute-phase.md.

#### Bug 4: Progress Bar RangeError (PR #715)

**Location:** `bin/mow-tools.cjs`
- `renderProgressBar` (line 311): `fillChar.repeat(fillCount)` where fillCount could be negative
- `cmdStateUpdateProgress` (line 2075): Percent computation sites
- Any other percent computation that feeds into `String.repeat()`

**Fix:** Add `Math.max(0, ...)` clamping to ALL `fillCount` / `emptyCount` computations, and `Math.min(100, ...)` to percent values. The `renderProgressBar` function already has `Math.max(0, Math.min(100, percent))` on line 313 but the `Math.round((percent / 100) * width)` on line 314 can still produce negative via floating point. Add `Math.max(0, ...)` to fillCount and emptyCount.

**Scope:** 3-5 sites in `bin/mow-tools.cjs`. Easy.

#### Bug 5: Executor No Attempt Limit (v1.19.2)

**Location:**
- `agents/mow-executor.md`: Has `FIX ATTEMPT LIMIT` section (3 attempts per task) but no overall plan-level limit
- `mowism/workflows/execute-phase.md`: No timeout/attempt tracking for executor agents

**Fix:** The executor already has a 3-attempt limit per task (in `<deviation_rules>` SCOPE BOUNDARY section). Strengthen by:
1. Add a plan-level attempt limit in execute-phase.md (if executor agent reports failure, max 2 retries)
2. Add a timeout parameter to the `Task()` call for executor spawning

**Scope:** 2 files. Easy.

#### Bug 6: Plan-Without-Discuss / Discuss-After-Plans Guards (v1.20.0)

**Location:**
- `mowism/workflows/plan-phase.md` step 4: Already checks `has_context` and offers "Run discuss-phase first" option. BUT it doesn't WARN, it offers a choice.
- `mowism/workflows/discuss-phase.md` step `check_existing`: Already checks `has_plans` and warns. Already implemented.

**Fix:** Strengthen plan-phase.md step 4: if no CONTEXT.md exists AND this is an interactive session (not `--auto`), show a prominent warning instead of a quiet option. The discuss-phase guard is already adequate.

**Scope:** 1 file, minor text change. Easy.

#### Bug 7: Health --repair Overwrites STATE.md Without Backup (v1.20.5)

**Location:** `bin/mow-tools.cjs` -- health validation/repair logic

**Fix:** Before overwriting STATE.md during repair, create timestamped backup:
```javascript
const backup = statePath + '.backup-' + Date.now();
fs.copyFileSync(statePath, backup);
```

**Scope:** 1 function in `bin/mow-tools.cjs`. Easy.

#### Bug 8: Subagents Don't Discover Project CLAUDE.md (v1.20.5)

**Location:** Multiple workflow spawn points:
- `mowism/workflows/execute-phase.md`: Task() prompt for executor
- `mowism/workflows/plan-phase.md`: Task() prompt for researcher, planner, checker
- `agents/mow-phase-worker.md`: Task() prompt for all subagents

**Fix:** In each Task() spawn prompt, add:
```markdown
<project_context>
@.claude/CLAUDE.md  (if exists)
</project_context>
```

The subagent reads this file at start. Alternatively, include the content inline in the prompt (since `@` references may not resolve in Task() -- per v1.2-NESTED-DELEGATION.md finding).

**Preferred approach:** Have the spawning agent READ `.claude/CLAUDE.md` content and embed it in the Task() prompt string. This ensures subagent context regardless of `@` resolution behavior.

**Scope:** 6-8 Task() spawn sites across 3 files. Medium.

#### Bug 9: Todo Marked Done Before Work Starts (PR #543)

**Location:** `bin/mow-tools.cjs`
- `cmdTodoComplete` (todo complete subcommand): Moves file from pending/ to done/
- No intermediate state

**Fix:** Add `in-progress/` directory and `todo start` subcommand:
```
pending/ --[todo start]--> in-progress/ --[todo complete]--> done/
```

**Scope:** `bin/mow-tools.cjs` (new subcommand + modify existing), `mowism/workflows/check-todos.md` (show in-progress state). Medium.

---

## Data Flow Changes

### Worktree Handoff (Before vs After)

**v1.1 (current):**
```
Team Lead (main worktree)
  |
  | mow-tools.cjs worktree create {phase}
  | -> git worktree add .worktrees/pNN -b phase-NN main
  | -> cp -r .planning/ .worktrees/pNN/.planning/
  | -> writes manifest.json
  |
  | Task(teammate, prompt="cd .worktrees/pNN && ...")
  v
Phase Worker (in .worktrees/pNN)
```

**v1.2 (proposed):**
```
Team Lead (main worktree)
  |
  | Task(
  |   teammate,
  |   isolation: worktree,    <-- Claude Code creates worktree
  |   prompt="..."
  | )
  | -> WorktreeCreate hook fires
  | -> Hook copies .planning/ to new worktree
  |
  | mow-tools.cjs worktree claim {phase}  <-- coordination only
  v
Phase Worker (in .claude/worktrees/<name>)
```

**Key difference:** Worktree path changes from `.worktrees/pNN` to `.claude/worktrees/<name>`. All code referencing `.worktrees/` paths must be updated OR (preferred) made path-agnostic using `git rev-parse --show-toplevel`.

### Auto-Advance Pipeline Flow

```
/mow:auto
  |
  v
[Read STATE.md] -> Detect current position
  |
  +--[No CONTEXT.md]--> /mow:discuss-phase {phase} --auto
  |                       |
  |                       v
  |                     [PAUSES for user input -- HARD CONSTRAINT]
  |                       |
  |                       v
  |                     [User provides context]
  |                       |
  |                       v
  |                     /mow:plan-phase {phase} --auto  (chained by discuss-phase)
  |
  +--[Has CONTEXT, no PLANs]--> /mow:plan-phase {phase} --auto
  |                               |
  |                               v
  |                             [Auto-spawn researcher, planner, checker]
  |                               |
  |                               v
  |                             /mow:execute-phase {phase} --auto  (chained by plan-phase)
  |
  +--[Has PLANs, incomplete]--> /mow:execute-phase {phase} --auto
                                  |
                                  v
                                [Auto-approve checkpoints]
                                  |
                                  v
                                transition.md --auto
                                  |
                                  +--[More phases]--> /mow:discuss-phase {next} --auto  [LOOPS]
                                  |
                                  +--[Last phase]--> Clear auto_advance, milestone complete
```

### Full-Lifecycle Worker Data Flow

```
Phase Worker (teammate, full session)
  |
  | Task() -> Research Subagent
  |   reads: ROADMAP.md, phase description
  |   writes: {phase}-RESEARCH.md
  |   returns: summary string to worker
  |
  | Task() -> Planner Subagent
  |   reads: RESEARCH.md, CONTEXT.md (if exists), REQUIREMENTS.md
  |   writes: {phase}-NN-PLAN.md files
  |   returns: plan count + wave structure to worker
  |
  | For each plan:
  |   Task() -> Executor Subagent
  |     reads: PLAN.md
  |     writes: code + {phase}-NN-SUMMARY.md
  |     returns: commit hashes + completion status
  |
  | Task() -> Verifier Subagent
  |   reads: PLAN.md files, SUMMARY.md files, codebase
  |   writes: {phase}-VERIFICATION.md
  |   returns: pass/fail + gap list
  |
  | SendMessage(lead, phase_complete)
  v
Lead receives completion, triggers merge
```

---

## Component Boundary Summary

### New Components

| Component | Type | Purpose |
|-----------|------|---------|
| `commands/mow/auto.md` | Command | Entry point for `/mow:auto`. Reads state, invokes appropriate workflow with `--auto`. |
| `init auto` in mow-tools.cjs | Compound cmd | Returns current state for auto-advance decision (phase, what exists, what's next). |
| WorktreeCreate hook | Hook script | Copies `.planning/` when Claude Code creates a worktree. Registered by install.sh. |

### Modified Components (Significant)

| Component | Change Magnitude | What Changes |
|-----------|-----------------|-------------|
| `bin/mow-tools.cjs` | **Large** | Remove ~200 lines (worktree create/stash/manifest/WorkTrunk), fix 9 bugs (~50 lines changed), add `init auto` (~40 lines), update claim/merge/clean for native paths (~30 lines). Net: ~-100 lines. |
| `agents/mow-phase-worker.md` | **Medium** | Rewrite Steps 2-3 to use Task() subagent pattern. Add Step 5 verification. ~60% of file changes. |
| `agents/mow-team-lead.md` | **Medium** | Replace worktree create calls with native isolation. Update merge flow for native worktree paths. ~30% of file changes. |
| `install.sh` | **Small** | Remove WorkTrunk check. Add WorktreeCreate hook registration. |

### Modified Components (Minor)

| Component | What Changes |
|-----------|-------------|
| `agents/mow-executor.md` | Strengthen attempt limit section. Minor text. |
| `mowism/workflows/discuss-phase.md` | Add handle_branching step (~10 lines). |
| `mowism/workflows/plan-phase.md` | Add handle_branching step (~10 lines). Strengthen no-context warning. |
| `mowism/workflows/execute-phase.md` | Strengthen executor retry limit (~5 lines). |
| `mowism/workflows/health.md` | Add backup-before-repair note. |
| `commands/mow/help.md` | Add `/mow:auto` to index. |
| `README.md` | Remove WorkTrunk prerequisite. Add `/mow:auto` to command list. |

### Removed Components

| Component | Why |
|-----------|-----|
| `cmdWorktreeCreate` + related (~160 lines) | Replaced by native `isolation: worktree` |
| `readManifest` / `writeManifest` (~20 lines) | No more manifest.json |
| `getDefaultBranch` (~12 lines) | Native worktree handles this |
| `requireWorkTrunk` / `checkWorkTrunk` (~25 lines) | WorkTrunk dependency eliminated |
| `ensureWtConfig` (~15 lines) | No more wt.toml |
| `WT_CONFIG_CONTENT` / `WT_PLANNING_COPY_HOOK` (~40 lines) | No more WorkTrunk hooks |
| `.config/wt.toml` auto-creation | WorkTrunk removed |
| WorkTrunk install check in install.sh | Dependency removed |

---

## Build Order (Dependency-Aware)

Phases must be ordered by dependency -- later phases assume earlier ones are merged:

### Wave 1 (Independent foundations)

1. **GSD Bugfixes** -- No dependencies on other v1.2 work. Pure fixes to existing code. Can be done first because every other phase will touch the same files, so getting these right first prevents conflicts.

2. **WorkTrunk Removal & Native Worktree Adoption** -- Independent of bugfixes (different code sections). Removes ~270 lines, adds WorktreeCreate hook, updates 12 init functions. This is the largest code change and should be early to unblock testing.

### Wave 2 (Depends on Wave 1)

3. **Coordination Layer Adaptation** -- Depends on native worktree adoption (Wave 1). Updates claim/merge/clean/status to work with native worktree paths (`.claude/worktrees/` instead of `.worktrees/`). Updates mow-team-lead.md to spawn teammates with `isolation: worktree`.

4. **Full-Lifecycle Workers** -- Depends on native worktrees (Wave 1). Rewrites mow-phase-worker.md Steps 2-5 to use Task() subagent spawning. Tests require working worktree isolation.

### Wave 3 (Depends on Wave 2)

5. **Auto-Advance Pipeline** -- Depends on full-lifecycle workers (Wave 2). Creates `/mow:auto` command, adds `init auto` to mow-tools.cjs. Tests require the full discuss->plan->execute->transition chain to work with native worktrees and lifecycle workers.

6. **Simplification Pass** -- Depends on everything (Wave 2). Final cleanup: remove dead code paths, update README, audit for remaining WorkTrunk references, run full integration test.

---

## Anti-Patterns to Avoid

### Anti-Pattern 1: Worktree Path Hardcoding
**What:** Replacing `.worktrees/pNN` hardcoding with `.claude/worktrees/<name>` hardcoding.
**Why bad:** Claude Code may change worktree paths in future releases.
**Instead:** Use `git rev-parse --show-toplevel` to discover current worktree root. Derive phase from branch name or claim table, not path.

### Anti-Pattern 2: Putting Coordination Logic in Hooks
**What:** Moving claim/release/merge logic into WorktreeCreate/WorktreeRemove hooks.
**Why bad:** Hooks are fire-and-forget, no error handling, no return values, limited to shell scripts.
**Instead:** Hooks handle only `.planning/` copy. Coordination stays in mow-tools.cjs, invoked explicitly by agents.

### Anti-Pattern 3: Worker Context Bloat
**What:** Having the worker read all prior subagent outputs to pass context forward.
**Why bad:** 4 subagent returns * varied length = potential context rot.
**Instead:** Subagents write to disk. Worker passes disk paths to next subagent. Worker only retains compact status (success/fail, plan count, commit hashes).

### Anti-Pattern 4: Auto-Advance Skipping Discuss
**What:** Having `/mow:auto` skip discuss-phase for "efficiency."
**Why bad:** Violates hard constraint. User input during discuss shapes all downstream work.
**Instead:** Auto-advance chains through discuss, but discuss ALWAYS pauses for user input via `input_needed` message. After user provides input, auto-advance continues.

### Anti-Pattern 5: Monolithic Bugfix Phase
**What:** Combining all 9 GSD bugfixes into a single plan.
**Why bad:** Each fix touches different areas. A single plan creates a mega-context-consuming session.
**Instead:** Group by locality: state mutator fixes (Bug 1, 7), workflow guards (Bug 3, 5, 6), init function fixes (Bug 2, 8), new features (Bug 9), progress fixes (Bug 4).

---

## Scalability Considerations

| Concern | Current (v1.1) | After v1.2 |
|---------|----------------|------------|
| Worktree creation | Custom cmdWorktreeCreate with manifest.json tracking | Native Claude Code -- no Mowism overhead |
| Worker lifecycle | Manual inline workflow execution | Task() subagent delegation -- isolated context per stage |
| Phase pipeline | Manual invocation of each stage | Auto-advance chains stages automatically |
| WorkTrunk dependency | Hard requirement, install complexity | **Eliminated** |
| mow-tools.cjs size | 8,208 lines | ~8,000 lines (net reduction from removal > additions) |

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| `isolation: worktree` behavior changes in Claude Code update | Medium | High | Pin to known working Claude Code version in docs. Abstract worktree path discovery behind `git rev-parse`. |
| WorktreeCreate hook doesn't fire reliably | Low | High | Fallback: worker detects missing `.planning/` and copies from main manually. Add this check to mow-phase-worker.md Step 1. |
| Context accumulation in full-lifecycle workers | Medium | Medium | Subagents write to disk, worker passes paths not content. Monitor with context window hook (should-consider from GSD diff). |
| Auto-advance creates runaway cost | Low | Medium | Milestone boundary auto-clears. Circuit breaker halts on failures. Per-phase billing visibility in dashboard. |

## Sources

- Existing codebase: `bin/mow-tools.cjs` (8,208 lines), 14 agents, 33 workflows, 42 commands
- `.planning/research/v1.2-NESTED-DELEGATION.md` (2026-02-24)
- `.planning/research/v1.2-GSD-UPSTREAM-DIFF.md` (2026-02-24)
- `.planning/research/ARCHITECTURE.md` (v1.1, 2026-02-20)
- `.planning/PROJECT.md` (v1.2 scope definition)
- Claude Code Agent Teams docs (WorktreeCreate hooks, isolation: worktree)
