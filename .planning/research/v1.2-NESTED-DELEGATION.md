# Nested Agent Delegation Research (2026-02-24)

## Architecture: Confirmed Working

```
Level 0: User's session (IS the team lead) — full Claude Code session
         Uses TeamCreate + Teammate tool
Level 1: Phase workers (teammates) — full, independent Claude Code sessions
         Use Task() to spawn subagents
Level 2: Executors, researchers, refiners (subagents) — restricted, no Task()
```

## Hard Constraints

- **Subagents CANNOT spawn subagents** (enforced since v1.0.64, causes OOM if attempted)
- **Teammates CANNOT create their own teams** (no nested teams)
- **Teammates CAN use Task()** — they're full sessions, not subagents
- **No production system uses 3+ levels** — cost/failure modes escalate super-linearly
- **Skills don't resolve in Task() subagents** — must use `@file` references, not `/mow:` commands

## Full-Lifecycle Worker Pattern

Phase worker (teammate) sequentially chains Task() calls:
1. Task() → research subagent (read-only, consider Haiku for cost)
2. Task() → planner subagent
3. Task() → executor subagent (mow-executor, writes code)
4. Task() → refiner subagent (review/test)

Each returns results to phase worker, which passes context to next. This is Anthropic's recommended pattern.

## Claude Code Native Worktree Support

- `claude --worktree <name>` creates worktrees at `.claude/worktrees/<name>`
- Subagent `isolation: worktree` in YAML frontmatter — auto-creates/cleans up
- `WorktreeCreate`/`WorktreeRemove` lifecycle hooks (v2.1.50)
- Subagents inherit parent's PWD but no first-class `cwd` parameter (Issue #12748)
- Does NOT provide: phase-to-worktree tracking, claim/conflict prevention, merge orchestration, shared state coordination

## Agent Teams Status (still experimental)

- Flag: `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1` — no graduation
- APIs: TeamCreate, SendMessage, TaskList, TeamDelete
- Known limits: no session resume, no nested teams, one team per session, slow shutdown
- Memory leak fix in v2.1.50

## Risk Factors for v1.2

1. **Context accumulation in phase workers**: collecting results from 4+ subagents across full lifecycle grows context. Auto-compaction helps but monitor for context rot.
2. **Cost**: 6 parallel phases × 4-5 subagents = 24-30 spawns per milestone. Use Haiku for read-only research.
3. **Orphan cleanup**: if lead dies, workers and subagents may continue. `/mow:close-shop` must handle this.
4. **Working directory**: subagents inherit PWD, must use explicit path passing for worktree context.

## Ecosystem Comparison

- **Anthropic's own research system**: 2-level (Opus lead + Sonnet workers), 15x token usage vs chat
- **Google ADK**: supports arbitrary depth but recommends shallow trees; shared session state "whiteboard" pattern
- **OpenHands**: `AgentDelegateAction` for delegation, blocking parallel, same workspace
- **Cursor 2.0**: 8 agents with worktree isolation, flat parallelism (no hierarchy)
- **GSD upstream**: no worktree support, no Agent Teams merged, plan-level parallelism only

## Sources

- Claude Code Agent Teams docs: https://code.claude.com/docs/en/agent-teams
- Claude Code Subagents docs: https://code.claude.com/docs/en/sub-agents
- Anthropic engineering blog: multi-agent research system
- UC Berkeley MAS failure taxonomy (arxiv 2503.13657)
