# Technology Stack: v1.2

**Project:** Mowism v1.2 -- Native Worktree Adoption, Full-Lifecycle Workers, Auto-Advance Pipeline, GSD Upstream Cherry-Pick
**Researched:** 2026-02-24
**Supersedes:** v1.1 STACK.md (2026-02-20) for NEW FEATURES ONLY. v1.0/v1.1 stack decisions (zero-dependency CJS, Markdown workflows, NDJSON events, Agent Teams, DAG scheduling, ANSI formatting) remain unchanged.
**Overall confidence:** HIGH

## Design Principle: Simplification, Not Expansion

v1.2 is a simplification milestone. The stack SHRINKS:
- Remove ~200 LOC of custom worktree creation/management code
- Replace with Claude Code's native `isolation: worktree` and `--worktree` flag
- Keep only what Claude Code does NOT provide: phase-to-worktree tracking, claim/conflict prevention, merge orchestration, shared `.planning/` state coordination

**Zero new dependencies.** The zero-npm-dependency constraint from v1.0 continues. All changes are to existing files.

---

## 1. Claude Code Native Worktree API (replaces cmdWorktreeCreate)

| Component | Version | Purpose | Confidence |
|-----------|---------|---------|------------|
| `--worktree` CLI flag | v2.1.49+ (stable in v2.1.50) | Launch Claude sessions in isolated git worktrees | HIGH |
| `isolation: worktree` frontmatter field | v2.1.49+ (stable in v2.1.50) | Subagents declaratively run in temp worktrees; auto-cleaned if no changes | HIGH |
| `WorktreeCreate` hook event | v2.1.50 | Fires when `--worktree` or `isolation: worktree` creates a worktree; can replace default git behavior | HIGH |
| `WorktreeRemove` hook event | v2.1.50 | Fires when worktree session exits or subagent finishes; cleanup counterpart | HIGH |

### How It Replaces Our Code

**Current (v1.1):** `cmdWorktreeCreate()` in mow-tools.cjs (lines 6610-6724) manually runs `git worktree add`, copies `.planning/`, initializes STATUS.md, and updates manifest.json. 115 lines.

**v1.2 target:** Claude Code handles worktree creation natively. We use `WorktreeCreate` hook to inject our `.planning/` copy and STATUS.md init. We keep the manifest for phase-to-worktree tracking.

### WorktreeCreate Hook Spec (verified from official docs)

**Input JSON (received on stdin):**
```json
{
  "session_id": "abc123",
  "cwd": "/home/user/project",
  "hook_event_name": "WorktreeCreate",
  "name": "feature-auth"
}
```

**Output:** Must print absolute path to created worktree on stdout. Non-zero exit fails creation.

**Key behavior:**
- No matcher support (fires on EVERY worktree creation)
- Replaces default git behavior entirely when defined
- Only `type: "command"` hooks supported (no prompt/agent)
- `name` field is a slug: either user-specified or auto-generated (e.g., `bold-oak-a3f2`)

### WorktreeRemove Hook Spec (verified from official docs)

**Input JSON:**
```json
{
  "session_id": "abc123",
  "cwd": "/home/user/project",
  "hook_event_name": "WorktreeRemove",
  "worktree_path": "/home/user/project/.claude/worktrees/feature-auth"
}
```

**Key behavior:**
- Cannot block removal (fires are informational)
- Failures logged in debug mode only
- Only `type: "command"` hooks supported

### Integration Design

**WorktreeCreate hook script** (`.claude/hooks/mow-worktree-create.sh`):

```bash
#!/bin/bash
# Read JSON from stdin
INPUT=$(cat)
NAME=$(echo "$INPUT" | jq -r '.name')
CWD=$(echo "$INPUT" | jq -r '.cwd')

# Use mow-tools to create worktree with our coordination layer
# This handles: git worktree add, .planning/ copy, STATUS.md init, manifest update
RESULT=$(node "$CWD/bin/mow-tools.cjs" worktree create-native --name "$NAME" --raw)
echo "$RESULT" | jq -r '.path'  # Print absolute path for Claude Code
```

**What stays in mow-tools.cjs:**
- `cmdWorktreeCreateNative()` -- slimmed version: does git worktree add, .planning/ copy, STATUS init, manifest update. Returns absolute path.
- `cmdWorktreeMerge()` -- unchanged. Claude Code does NOT handle merge orchestration.
- `cmdWorktreeStash()` -- unchanged. Claude Code does NOT handle checkpoint stashing.
- `cmdWorktreeClaim()`, `cmdWorktreeRelease()` -- unchanged. Claude Code does NOT handle claim/conflict.
- `cmdWorktreeStatus()`, `cmdWorktreeUpdatePlan()` -- unchanged.
- `cmdWorktreeClean()` -- unchanged.
- `cmdWorktreeVerifyResult()` -- unchanged.
- Manifest read/write functions -- unchanged.

**What gets removed from mow-tools.cjs:**
- The WT_PLANNING_COPY_HOOK constant (embedded shell script at line 821) -- replaced by the hook
- The WorkTrunk hook registration code -- no longer needed
- The `--base` option handling for `worktree create` -- Claude Code picks the branch

**Net code change:** Remove ~50 LOC, add ~30 LOC for `cmdWorktreeCreateNative`. Net -20 LOC.

### Worktree Path Differences

**Claude Code native:** creates worktrees at `.claude/worktrees/<name>/`
**Mowism current:** creates at `.worktrees/p<NN>/`

**Decision: Keep Mowism's path convention** via the WorktreeCreate hook. The hook controls the path. This preserves the `.worktrees/` directory and `p<NN>` naming that all existing agent prompts reference. Changing every agent reference to `.claude/worktrees/` would be unnecessary churn.

**Confidence:** HIGH -- Verified from official Claude Code hooks docs. WorktreeCreate hook explicitly replaces default git behavior and the hook controls the output path.

---

## 2. `isolation: worktree` for Executor Subagents

| Component | Purpose | Integration Point |
|-----------|---------|-------------------|
| `isolation: worktree` in mow-executor.md frontmatter | Executors get auto-isolated worktrees for individual plan execution | Agent definition file |

### How This Works

When a phase worker spawns an executor via `Task()`, the executor can declare `isolation: worktree` in its frontmatter. Claude Code:
1. Creates a temporary worktree (triggers WorktreeCreate hook)
2. Runs the subagent in that worktree
3. If subagent makes no changes, auto-cleans the worktree (triggers WorktreeRemove hook)
4. If subagent makes changes, worktree persists

### Why NOT to Use This (v1.2 decision)

**We should NOT add `isolation: worktree` to mow-executor.md for v1.2.** Reason:

Phase workers already run in their own worktree (created by the team lead). Executors spawned within a phase worker inherit that worktree's PWD. Adding `isolation: worktree` to executors would create **nested worktrees** -- a worktree within a worktree -- which:
- Doubles the disk footprint
- Breaks the merge model (executor worktree changes would need to merge into phase worktree, which then merges into main)
- Complicates `.planning/` state (which worktree's `.planning/` is authoritative?)
- Adds latency for every executor spawn

**Keep the current model:** phase workers own worktrees; executors inherit the phase worker's worktree and commit directly to the phase branch.

`isolation: worktree` is useful for **solo mode** (no Agent Teams) where the user runs `/mow:execute-phase` directly. In that case, the executor could use worktree isolation to prevent polluting the user's working copy. This is a **future consideration**, not v1.2 scope.

**Confidence:** HIGH -- Anthropic's docs confirm subagent `isolation: worktree` creates a new worktree per spawn. Nesting would be harmful.

---

## 3. PostToolUse Hook for Context Window Monitor

| Component | Version | Purpose | Confidence |
|-----------|---------|---------|------------|
| `PostToolUse` hook event | v2.1.33+ (hook system mature) | Fire after every tool call to check remaining context | HIGH |

### Spec (verified from official docs)

**Input JSON (received on stdin):**
```json
{
  "session_id": "abc123",
  "hook_event_name": "PostToolUse",
  "tool_name": "Bash",
  "tool_input": { "command": "npm test" },
  "tool_response": { "success": true },
  "tool_use_id": "toolu_01ABC123..."
}
```

**Key behavior:**
- Supports matcher (e.g., `"Bash"`, `"Edit|Write"`, `"*"`)
- Cannot block (tool already ran), but can return `additionalContext` to Claude
- `decision: "block"` prompts Claude with the reason (not actually blocking, since tool ran)
- Supports `async: true` for background execution

### Context Window Monitor Design

The context window monitor cannot directly read remaining context percentage -- there is no API for that. However, GSD upstream (PR #638) uses an approximation:

**Approach: Token count estimation via transcript file**

```bash
#!/bin/bash
# .claude/hooks/context-monitor.sh
INPUT=$(cat)
TRANSCRIPT=$(echo "$INPUT" | jq -r '.transcript_path')

# Approximate tokens: count bytes, divide by ~4 (rough chars-per-token)
BYTES=$(wc -c < "$TRANSCRIPT" 2>/dev/null || echo 0)
APPROX_TOKENS=$((BYTES / 4))

# Claude's context window: ~200K tokens
USED_PCT=$((APPROX_TOKENS * 100 / 200000))
REMAINING=$((100 - USED_PCT))

if [ "$REMAINING" -le 25 ]; then
  echo '{"decision":"block","reason":"CONTEXT CRITICAL: ~25% remaining. Compact now or finish current task and checkpoint."}'
elif [ "$REMAINING" -le 35 ]; then
  echo '{"systemMessage":"Context monitor: ~35% remaining. Consider compacting soon."}'
fi
```

**Alternative: Use PreCompact hook instead.** PreCompact fires before auto-compaction (which triggers at ~95% usage). This is a reliable signal but fires too late for a 35% warning. The PostToolUse approach gives earlier warnings.

**Configuration:**
```json
{
  "hooks": {
    "PostToolUse": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/.claude/hooks/context-monitor.sh",
            "async": true,
            "timeout": 5
          }
        ]
      }
    ]
  }
}
```

Using `async: true` so it does not block Claude's execution. The `systemMessage` field in async hook output is delivered on the next conversation turn.

**Confidence:** MEDIUM -- The transcript byte-count approach is a rough approximation. The actual context window size varies by model and includes system prompt, tool definitions, and other overhead. The 35%/25% thresholds will need tuning. GSD's implementation (PR #638) likely uses a similar heuristic.

---

## 4. SubagentStart Hook for CLAUDE.md Discovery (Bug #8 fix)

| Component | Version | Purpose | Confidence |
|-----------|---------|---------|------------|
| `SubagentStart` hook event | v2.1.33+ | Inject project context into subagents at spawn time | HIGH |

### Spec (verified from official docs)

**Input JSON:**
```json
{
  "session_id": "abc123",
  "hook_event_name": "SubagentStart",
  "agent_id": "agent-abc123",
  "agent_type": "mow-executor"
}
```

**Key behavior:**
- Supports matcher on agent type name (e.g., `"mow-executor"`, `"Explore"`)
- Cannot block subagent creation
- Can return `additionalContext` string injected into subagent's context

### Integration Design

```json
{
  "hooks": {
    "SubagentStart": [
      {
        "matcher": "mow-.*",
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/.claude/hooks/inject-project-context.sh"
          }
        ]
      }
    ]
  }
}
```

The hook script reads CLAUDE.md and injects it as `additionalContext`. This fixes Bug #8 (subagents not discovering project CLAUDE.md) without modifying every workflow's Task() spawn point.

**Note:** Claude Code v2.1.50 already partially fixed this: "Fixed custom agents and skills not being discovered when running from a git worktree." But this was about .claude/agents/ discovery, not CLAUDE.md content injection. The SubagentStart hook provides a more robust solution.

**Confidence:** HIGH -- SubagentStart hook is documented, `additionalContext` injection is confirmed.

---

## 5. Node.js Patterns for GSD Bugfix Cherry-Picks

### Bug #1: Dollar Sign Corruption (lines 1983, 2006)

**Current vulnerable code:**
```javascript
content = content.replace(pattern, `$1${value}`);
```

When `value` contains `$1`, `$2`, `$$`, etc., `String.replace()` treats them as backreferences/special replacement patterns. Decision text like "Cost $100" becomes "Cost $100" mutated by regex capture groups.

**Fix pattern: Callback replacer**
```javascript
content = content.replace(pattern, (match, prefix) => prefix + value);
```

The callback form does NOT interpret `$` sequences in the return value. This is standard JavaScript -- no new dependency.

**All affected sites in mow-tools.cjs:**
- Line 1983: `cmdStateUpdate` -- `content.replace(pattern, \`$1${value}\`)`
- Line 2006: `stateReplaceField` -- `content.replace(pattern, \`$1${newValue}\`)`
- Line 2131: `cmdStateAddDecision` -- `content.replace(sectionPattern, \`${match[1]}${sectionBody}\`)`
- Line 2154: `cmdStateAddBlocker` -- same pattern
- Line 2186: `cmdStateResolveBlocker` -- same pattern

**Effort:** 5 lines changed, each from string template to callback. Zero risk of regression.

**Confidence:** HIGH -- This is a well-known JavaScript pitfall. MDN documents it explicitly.

### Bug #4: Progress Bar RangeError

**Current code (line 311-313):**
```javascript
function renderProgressBar(percent, width, isBlocked, colorCode) {
  percent = Math.max(0, Math.min(100, percent));
  const fillCount = Math.round((percent / 100) * width);
```

The clamping on line 313 is already present. But other percent computation sites (lines 627-649, 2096-2098, 5527-5547) do NOT clamp before passing to `String.repeat()` or similar functions.

**Fix pattern: Defensive clamping at EVERY computation site**
```javascript
const percent = Math.max(0, Math.min(100, totalPlans > 0 ? Math.round((completed / totalPlans) * 100) : 0));
```

**Specific risk:** Orphaned SUMMARY files (SUMMARY exists but no matching PLAN) can make `completed > totalPlans`, producing `percent > 100`, which when passed to `String.repeat(width - fillCount)` yields a negative argument.

**All sites to audit:**
- Line 638: `percent = Math.round((completed / plans.length) * 100)` -- NO clamp
- Line 649: `percent = Math.round((done / total) * 100)` -- NO clamp
- Line 2096: `const percent = totalPlans > 0 ? Math.round(totalSummaries / totalPlans * 100) : 0` -- NO clamp
- Line 2098: `const filled = Math.round(percent / 100 * barWidth)` -- NO clamp on filled vs barWidth
- Line 5527: same pattern
- Line 5532: same pattern
- Line 5544: same pattern

**Effort:** Add `Math.min(100, ...)` wrapper at 7 sites. ~7 lines changed.

**Confidence:** HIGH -- Pure arithmetic, no behavioral change for valid inputs.

### Bug #5: Executor No Attempt Limit

**Current state:** No `MAX_ATTEMPTS` or retry logic in mow-executor agent/workflow.

**Fix pattern:** Add to `execute-plan.md` workflow and `mow-executor.md` agent:
```markdown
**Scope boundary:** If a task fails after 3 attempts, write a CHECKPOINT.md with
the failure details and move to the next task. Do NOT loop indefinitely.
```

This is a prompt engineering change, not a code change. The limit lives in the agent instruction, not in mow-tools.cjs.

**Confidence:** HIGH -- GSD v1.19.2 implemented this the same way: as an instruction in the executor agent prompt.

### Bug #6: Workflow Ordering Guards

**Fix pattern:** Add conditional checks at the top of each workflow:

In `plan-phase.md`:
```markdown
**Guard:** Before planning, check if CONTEXT.md exists for this phase:
\`\`\`bash
ls .planning/phases/{phase_dir}/*-CONTEXT.md 2>/dev/null
\`\`\`
If no CONTEXT.md exists, warn: "No context gathered for this phase. Run /mow:discuss-phase first for better results. Continue anyway? (y/n)"
```

In `discuss-phase.md`:
```markdown
**Guard:** Check if PLAN files already exist:
\`\`\`bash
ls .planning/phases/{phase_dir}/*-PLAN.md 2>/dev/null
\`\`\`
If plans exist, warn: "Plans already exist for this phase. Re-discussing may invalidate existing plans. Continue? (y/n)"
```

**Confidence:** HIGH -- Prompt-level guards, no code changes needed.

### Bug #7: Health Backup Before Repair

**Current code:** `cmdValidateHealth()` with `--repair` overwrites STATE.md without backup.

**Fix pattern:**
```javascript
if (options.repair) {
  const backup = statePath + '.' + new Date().toISOString().replace(/[:.]/g, '-') + '.bak';
  fs.copyFileSync(statePath, backup);
  process.stderr.write(`MOW: Backup created: ${path.basename(backup)}\n`);
}
```

**Effort:** 4 lines added before the repair logic.

**Confidence:** HIGH -- `fs.copyFileSync` is synchronous and atomic enough for this purpose.

### Bug #9: Todo Lifecycle (in-progress state)

**Current code (lines 5563-5588):** `cmdTodoComplete()` moves directly from `pending/` to `completed/`.

**Fix pattern:** Add `in-progress/` directory and `todo start` subcommand:
```javascript
function cmdTodoStart(cwd, filename, raw) {
  const pendingDir = path.join(cwd, '.planning', 'todos', 'pending');
  const inProgressDir = path.join(cwd, '.planning', 'todos', 'in-progress');
  // Move from pending to in-progress, add started timestamp
}

function cmdTodoComplete(cwd, filename, raw) {
  // Check in-progress first, then pending (backward compat)
  const inProgressDir = path.join(cwd, '.planning', 'todos', 'in-progress');
  const pendingDir = path.join(cwd, '.planning', 'todos', 'pending');
  // Move from whichever to completed
}
```

**Effort:** ~25 LOC for `cmdTodoStart`, ~10 LOC modified in `cmdTodoComplete`.

**Confidence:** HIGH -- Standard file move operations.

---

## 6. Auto-Advance Pipeline (`/mow:auto`)

| Component | Purpose | Integration Point |
|-----------|---------|-------------------|
| New workflow: `auto.md` | Chain phases: discuss -> plan -> execute per phase, advance through roadmap | `/mow:auto` command |
| Phase completion trigger | After execute-phase completes, check roadmap for next phase and auto-start | Team lead logic |
| Discuss-phase pause gate | HARD CONSTRAINT: discuss phase always pauses for user input | mow-phase-worker.md |

### No New Stack Needed

Auto-advance is orchestration logic, not infrastructure. It uses:
- Existing `roadmap analyze-dag` to determine phase order
- Existing `phase complete` to mark phases done
- Existing phase worker lifecycle (discuss -> plan -> execute)
- New state field in STATE.md: `**Auto-advance:** enabled|disabled`

### Implementation Pattern

The auto-advance workflow is a loop:
```
1. Read roadmap DAG, find next ready phase(s)
2. For each ready phase:
   a. Run discuss-phase (PAUSE for user input -- mandatory)
   b. Run plan-phase (autonomous)
   c. Run execute-phase (autonomous)
   d. Run phase complete
3. Loop to step 1
```

The discuss-phase pause is enforced by the existing `input_needed` message type and the phase worker's constraint that discuss-phase requires user interaction.

**No new mow-tools.cjs commands needed.** The auto-advance logic lives entirely in the workflow markdown file and team lead agent.

**Confidence:** HIGH -- All building blocks exist from v1.1.

---

## 7. Full-Lifecycle Worker Changes

| Component | Change | Confidence |
|-----------|--------|------------|
| `mow-phase-worker.md` | Add refine step after execute; chain 4 Task() calls instead of 3 | HIGH |
| `mow-team-lead.md` | Support `isolation: worktree` for teammates via `--worktree` flag | HIGH |

### Worker Lifecycle Update

Current (v1.1): discuss -> plan -> execute
Target (v1.2): discuss -> research -> plan -> execute -> refine

Each step is a Task() call to a specialized subagent. The phase worker collects results and passes context to the next step.

**No new Node.js code needed.** The lifecycle is encoded in the agent markdown, not in mow-tools.cjs.

### Team Lead Worktree Adoption

The team lead currently runs `node mow-tools.cjs worktree create {phase}` to create worktrees manually. In v1.2, the lead should use `claude --worktree <name>` when spawning teammates, which triggers the WorktreeCreate hook.

**Agent Teams interaction:** Teammates spawned via `Task()` with `team_name` already get their own sessions. Adding `--worktree` or configuring teammates to use worktree isolation happens at the Agent Teams level, not in mow-tools.cjs.

**Current limitation:** Agent Teams teammates are spawned with `Task()` which does not accept `--worktree` as a parameter. The `isolation: worktree` frontmatter field only applies to subagents (Task without team_name), not teammates. For teammates, the worktree is created by the lead before spawning.

**Decision: Keep the lead creating worktrees explicitly.** The lead creates worktrees via the WorktreeCreate hook (triggered by calling `claude --worktree p{NN}`), then spawns teammates into those worktrees. This matches the existing model and avoids relying on unverified teammate worktree behavior.

**Confidence:** MEDIUM -- The interaction between `isolation: worktree` and Agent Teams teammates is not explicitly documented. The safe path is to keep lead-managed worktree creation.

---

## What Code Gets Removed (Simplification Wins)

| Code to Remove | Lines | Reason |
|----------------|-------|--------|
| `WT_PLANNING_COPY_HOOK` constant | ~20 | Replaced by WorktreeCreate hook script |
| WorkTrunk hook registration in install.sh | ~15 | No longer using WorkTrunk hooks for .planning/ copy |
| Inline shell script generation for worktree hooks | ~10 | Replaced by .claude/hooks/ JSON config |
| Duplicate worktree path resolution logic | ~10 | Standardized in cmdWorktreeCreateNative |

**Total removed:** ~55 LOC
**Total added (bugfixes + new commands):** ~70 LOC
**Net change:** +15 LOC (vs v1.1's +280 LOC -- this is a simplification milestone)

---

## What NOT to Add

| Temptation | Why Avoid | Do Instead |
|------------|-----------|------------|
| **Use `isolation: worktree` for mow-executor** | Creates nested worktrees (worktree-in-worktree). Doubles disk, breaks merge model, complicates .planning/ authority. | Executors inherit phase worker's worktree. No isolation needed at plan level. |
| **Replace all worktree code with Claude Code native** | Claude Code does NOT provide: manifest tracking, claim/release, merge orchestration, .planning/ copy, STATUS.md init | Keep coordination layer. Replace only the git worktree creation primitive. |
| **Add `PreCompact` hook for context monitoring** | PreCompact fires at ~95% capacity -- too late for 35%/25% warnings | Use PostToolUse with transcript byte counting for early warnings |
| **Use prompt/agent hooks for WorktreeCreate** | WorktreeCreate only supports `type: "command"` | Use bash script hook |
| **Add file watcher for .planning/ sync** | Claude Code sessions cannot run background file watchers. Would require inotifywait/fswatch infrastructure | Poll on idle (existing coordinator pattern) |
| **Migrate manifest.json to SQLite** | Opaque to LLM agents, not git-diffable, adds complexity for a few KB of data | Keep JSON manifest |
| **Add PostToolUse context monitor to all tool calls** | Running a transcript byte-counter after every single tool call adds latency | Use `async: true` and only warn (never block). Consider matcher like `"Bash\|Write\|Edit"` to skip read-only tools |
| **Domain-split mow-tools.cjs into modules** | GSD did this (PR #691) but it breaks the single-file deployment model | Keep single file. 8,200 LOC is manageable for a single .cjs binary. Consider if it crosses 12K. |

---

## Version Compatibility

| Component | Minimum for v1.2 | Current Version | Notes |
|-----------|-------------------|-----------------|-------|
| Claude Code | 2.1.50 | 2.1.50 | WorktreeCreate/WorktreeRemove hooks require v2.1.50. SubagentStart hook requires v2.1.33+. Both satisfied. |
| Node.js | 22.x | 25.4.0 | Same as v1.1. `util.styleText` stable in 22. Core works on 18+. |
| Git | 2.20 | System | No new requirements. |
| jq | Any | System | Needed by hook scripts for JSON parsing. Already present on most systems. If missing, hook scripts should gracefully degrade. |

**New soft dependency: `jq`** -- hook scripts use `jq` to parse JSON from stdin. This is not a hard dependency; hooks can fall back to Node.js JSON parsing if jq is unavailable:

```bash
# Prefer jq, fall back to node
if command -v jq &>/dev/null; then
  NAME=$(echo "$INPUT" | jq -r '.name')
else
  NAME=$(echo "$INPUT" | node -e "process.stdin.on('data',d=>console.log(JSON.parse(d).name))")
fi
```

**Confidence:** HIGH -- jq is standard on developer machines. The fallback ensures it's not a blocker.

---

## Hook Configuration Summary

All v1.2 hooks are defined in `.claude/settings.json` (project-level, committable):

```json
{
  "hooks": {
    "WorktreeCreate": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/.claude/hooks/mow-worktree-create.sh"
          }
        ]
      }
    ],
    "WorktreeRemove": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/.claude/hooks/mow-worktree-remove.sh"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/.claude/hooks/context-monitor.sh",
            "async": true,
            "timeout": 5
          }
        ]
      }
    ],
    "SubagentStart": [
      {
        "matcher": "mow-.*",
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/.claude/hooks/inject-project-context.sh"
          }
        ]
      }
    ]
  }
}
```

**New files to create:**
| File | Purpose | LOC (est.) |
|------|---------|------------|
| `.claude/hooks/mow-worktree-create.sh` | WorktreeCreate handler: git worktree add, .planning/ copy, manifest update | ~30 |
| `.claude/hooks/mow-worktree-remove.sh` | WorktreeRemove handler: manifest cleanup, optional archive | ~15 |
| `.claude/hooks/context-monitor.sh` | PostToolUse handler: transcript byte counting, threshold warnings | ~25 |
| `.claude/hooks/inject-project-context.sh` | SubagentStart handler: read CLAUDE.md, return additionalContext | ~15 |

**Total new hook scripts:** ~85 LOC of bash.

---

## Integration Summary

All v1.2 changes integrate with existing infrastructure:

| Change Category | Files Modified | Lines Changed (est.) | Tests Needed |
|-----------------|----------------|----------------------|--------------|
| Bugfix: Dollar sign corruption | mow-tools.cjs (5 sites) | ~10 changed | String with `$1`, `$$`, `$100` in state updates |
| Bugfix: Progress bar RangeError | mow-tools.cjs (7 sites) | ~14 changed | Orphaned SUMMARY (completed > total), zero plans |
| Bugfix: Health backup | mow-tools.cjs (1 site) | ~4 added | --repair creates .bak file before overwriting |
| Bugfix: Todo lifecycle | mow-tools.cjs (2 functions) | ~35 added | `todo start` moves pending->in-progress, `todo complete` checks both dirs |
| Feature: Worktree hooks | .claude/settings.json, 4 hook scripts | ~85 new (bash) | Hook fires on --worktree, outputs correct path, copies .planning/ |
| Feature: Slimmed worktree code | mow-tools.cjs | ~55 removed, ~30 added | Existing worktree tests pass with new code path |
| Feature: Auto-advance | auto.md workflow, mow-team-lead.md | ~100 new (markdown) | Pipeline pauses at discuss, advances after execute |
| Feature: Full-lifecycle worker | mow-phase-worker.md | ~50 changed (markdown) | Worker chains research->plan->execute->refine |
| Feature: Workflow guards | discuss-phase.md, plan-phase.md | ~20 added (markdown) | Guard warns when out-of-order |
| Feature: Executor attempt limit | execute-plan.md, mow-executor.md | ~10 added (markdown) | Max 3 retries, then checkpoint |
| Feature: Context monitor | context-monitor.sh hook | ~25 new (bash) | Warns at 35%/25%, async execution |
| Feature: Subagent context injection | inject-project-context.sh hook | ~15 new (bash) | Mow agents receive CLAUDE.md context |

**Total estimated changes:** ~190 LOC of JavaScript, ~85 LOC of bash, ~180 LOC of markdown.
**Total estimated tests:** ~15 new test cases added to mow-tools.test.cjs.

---

## Sources

### Verified (HIGH confidence)
- [Claude Code Hooks Reference](https://code.claude.com/docs/en/hooks) -- Full hook event specs: WorktreeCreate, WorktreeRemove, PostToolUse, SubagentStart. Input schemas, output formats, matcher support, exit code behavior.
- [Claude Code Subagents Documentation](https://code.claude.com/docs/en/sub-agents) -- `isolation: worktree` frontmatter field, supported frontmatter schema, subagent scope.
- [Claude Code v2.1.50 Release Notes](https://github.com/anthropics/claude-code/releases/tag/v2.1.50) -- WorktreeCreate/WorktreeRemove hooks, worktree agent discovery fix, memory leak fixes.
- [Claude Code v2.1.49 Release Notes](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md) -- `--worktree` flag, `isolation: worktree` for subagents, `background: true` for agents.
- [Claude Code v2.1.50 Changelog on X](https://x.com/ClaudeCodeLog/status/2025163354965266574) -- Confirmed: "Added WorktreeCreate and WorktreeRemove hook events."
- [MDN String.prototype.replace()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace) -- Dollar sign special replacement patterns documentation.
- Local verification: `claude --version` returns 2.1.50, confirming all hook events are available.
- Local verification: mow-tools.cjs line-by-line audit of vulnerable `replace()` call sites.

### Prior Research (HIGH confidence)
- [Mowism v1.2 GSD Upstream Diff](.planning/research/v1.2-GSD-UPSTREAM-DIFF.md) -- 9 confirmed bugs with line-level analysis.
- [Mowism v1.2 Nested Delegation Research](.planning/research/v1.2-NESTED-DELEGATION.md) -- Agent hierarchy, hard constraints, worktree interaction.
- [Mowism v1.1 STACK.md](.planning/research/STACK.md) -- Zero-dependency constraint, NDJSON events, DAG scheduling patterns.
- [Boris Cherny on --worktree](https://www.threads.com/@boris_cherny/post/DVAAoZ3gYut) -- Creator's recommendation for worktree isolation.

### Corroborated (MEDIUM confidence)
- [GSD CHANGELOG](https://github.com/glittercowboy/get-shit-done/blob/main/CHANGELOG.md) -- Bug fix versions and descriptions for cherry-pick targets.
- [GSD PR #701](https://github.com/glittercowboy/get-shit-done/pulls) -- STATE.md dollar sign corruption fix.
- [GSD PR #702](https://github.com/glittercowboy/get-shit-done/pulls) -- Requirement ID propagation fix.

---
*Stack research for: Mowism v1.2 -- Native Worktree Adoption, Full-Lifecycle Workers, Auto-Advance Pipeline, GSD Upstream Cherry-Pick*
*Researched: 2026-02-24*
*Overall confidence: HIGH (all recommendations verified against Claude Code v2.1.50 official docs and local codebase audit)*
